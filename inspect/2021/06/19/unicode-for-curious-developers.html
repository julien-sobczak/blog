<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="Julien Sobczak">
<meta name="robots" content="index,follow,noodp">
<meta name="googlebot" content="index,follow">
<meta name="subject" content="Programming">


    <title>Unicode for Curious Developers Loving Code üòâ</title>

    <!-- To make search engines use the HTTPS url -->
<link rel="canonical" href="https://www.juliensobczak.com/inspect/2021/06/19/unicode-for-curious-developers.html">
<link rel="alternate" type="application/atom+xml" title="I'm Lovin' I.T. - Julien Sobczak" href="https://www.juliensobczak.com/feed.xml">

<!-- Asciidoctor assets -->
<link href="/css/coderay.css" rel="stylesheet" />

<!-- Theme CSS -->
<link href="/css/app.css" rel="stylesheet">

<!-- Custom Fonts -->
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i|Oswald" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Nothing+You+Could+Do" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Righteous" rel="stylesheet">

<!-- Favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

</head>

<body id="page-post">
  <!-- Custom loader -->
<div id="loader-wrapper">
  <div id="loader"></div>
</div>


  <!-- Navigation -->

  <nav id="mainNav" class="navbar-default">

    
    
    <div id="reading-bar"></div>
    
    

    <div class="container">
      <a class="navbar-brand" href="/index.html">I'm lovin' I.T.</a>
      <div class="navbar-collabsible">
        <input id="collapsible" class="navbar-checkbox-toggle" type="checkbox">
        <label for="collapsible" class="navbar-label-toggle">Menu <i class="fas fa-bars"></i></label>
        <div class="navbar-collapse">
          <ul>

            
            <li>
            
                <a href="/categories/read.html">I'm readin' I.T.</a>
            </li>

            
            <li>
            
                <a href="/categories/write.html">I'm writin' I.T.</a>
            </li>

            
            <li class="active">
            
                <a href="/categories/inspect.html">I'm inspectin' I.T.</a>
            </li>

            <li class="page-scroll">
                <a href="https://fr.linkedin.com/in/julien-sobczak-56780a91">About Me</a>
            </li>
          </ul>
        </div>
      </div>
      <button id="zen-mode-in"><i class="fas fa-minus"></i></button>
      <button id="zen-mode-out"><i class="fas fa-plus"></i></button>
    </div>
  </nav>


  <header class="post-title post-inspect">
  <!-- see https://www.elastic.co/blog/elasticsearch-5-0-0-released -->
  <div class="container">

    <div class="icon-category">
    </div>

    <div class="metadata">
      <span class="date">June 19, 2021</span>

      

      

      <ul class="language">
        <li class="current-language"><a class="active" href="#">EN</a></li>
      </ul>

      <h2>Unicode for Curious Developers Loving Code üòâ</h2>
      
      <h3>The "Minimum" Every Developer Must Know About Unicode</h3>
      

      <p class="author-name">
        
        <span>By </span>
        
        <a href="/#about-me">Julien Sobczak</a>
      </p>

     </div>
    </div>
  </div>
</header>

<section class="content">

  <div class="container">

    <article>

      <div class="content">
      <div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Our goal is to make sure that all of the text on computers for every language in the world is represented but we get a lot more attention for emojis than for the fact that you can type Chinese on your phone and have it work with another phone.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Unicode Consortium co-founder and president Mark Davis
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/emojis-everywhere.png" alt="emojis everywhere" width="700">
</div>
</div>
<div class="paragraph lead">
<p>Unicode is what allows me to say hello in over 100 languages‚Äî·ä•·ãç ·à∞·àã·àù ·äê·ãç (Amharic), ‰Ω†Â•Ω (Chinese), Œ≥ŒµŒπŒ± (Greek), ◊©◊ú◊ï◊ù (Hebrew), ‡§®‡§Æ‡§∏‡•ç‡§§‡•á (Hindi), „Åì„Çì„Å´„Å°„ÅØ (Japanese), ÿ≥ŸÑÿßŸÖ (Persian), cze≈õƒá (Polish), –ü—Ä–∏–≤–µ—Ç (Russian), and Unicode is what allows you to understand the difference between "You are funny ü§£" and "You are funny üëé." The web would not be the same without Unicode. But Unicode is not magic, and developers have to understand it to create applications running in a multilingual world.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">What You Will Learn</div>
<div class="ulist">
<ul>
<li>
<p><strong>The Story</strong></p>
<div class="ulist">
<ul>
<li>
<p>Why Unicode makes the web possible.</p>
</li>
<li>
<p>Why emojis exist in Unicode.</p>
</li>
<li>
<p>How you can suggest a new emoji.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>The Standard</strong></p>
<div class="ulist">
<ul>
<li>
<p>Why Unicode is not just a character set.</p>
</li>
<li>
<p>How characters are allocated in the codespace.</p>
</li>
<li>
<p>Why UTF-8 is different from Unicode, and why Unicode is different from UTF-8.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>The Implementation</strong></p>
<div class="ulist">
<ul>
<li>
<p>Why "√†" == "aÃÄ" is false in most languages.</p>
</li>
<li>
<p>Why the pistol emoji is now a toy.</p>
</li>
<li>
<p>How emojis are implemented on your device.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Why Learning About Unicode?</div>
<div class="paragraph">
<p>During my career, I came across the famous <a href="https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/">Joel Spoky&#8217;s blog post</a> about Unicode and character encodings several times. The truth is, I still didn&#8217;t understand what was really Unicode.</p>
</div>
<div class="paragraph">
<p>As often, if you want to have a good overview of a topic, you have to understand the details. Details create the Big Picture. The reverse is not true. Therefore, I read the Unicode Standard, browsed many articles, and inspected the code of some programming languages and libraries to understand how Unicode works. The result is this article. I hope it will help you better understand the challenges of Unicode, and why developers need to learn more about it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="table_of_contents">Table of Contents</h2>
<div class="sectionbody">
<div class="ulist compact">
<ul>
<li>
<p><a href="#sect-story">The Story</a></p>
<div class="ulist">
<ul>
<li>
<p><a href="#sect-story-characters">The Rise of Characters</a></p>
</li>
<li>
<p><a href="#sect-story-computers">The Rise of Computers</a></p>
</li>
<li>
<p><a href="#sect-story-unicode">The Rise of Unicode</a></p>
</li>
<li>
<p><a href="#sect-story-emojis">The Rise of Emojis</a></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#sect-standard">The Standard</a></p>
<div class="ulist">
<ul>
<li>
<p><a href="#sect-standard-standard">The Unicode Standard</a></p>
</li>
<li>
<p><a href="#sect-standard-character-table">The Unicode Character Table</a></p>
</li>
<li>
<p><a href="#sect-standard-character-database">The Unicode Character Database</a></p>
</li>
<li>
<p><a href="#sect-standard-encodings">The Unicode Encodings</a></p>
<div class="ulist">
<ul>
<li>
<p><a href="#sect-standard-encodings-utf32">UTF-32</a></p>
</li>
<li>
<p><a href="#sect-standard-encodings-utf16">UTF-16</a></p>
</li>
<li>
<p><a href="#sect-standard-encodings-utf8">UTF-8</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#sect-implementation">The Implementation</a></p>
<div class="ulist">
<ul>
<li>
<p><a href="#sect-implementation-reading">Reading</a></p>
</li>
<li>
<p><a href="#sect-implementation-processing">Processing</a></p>
</li>
<li>
<p><a href="#sect-implementation-writing">Writing</a></p>
</li>
<li>
<p><a href="#sect-implementation-rendering">Rendering</a></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#sect-future">The Future</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-story">The Story</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sect-story-characters">The Rise of Characters</h3>
<div class="paragraph">
<p>The story begins well after the origin of speech in the oldest known cave painting, located in France within Chauvet Cave. These paintings, dated to around 30,000 BC, were mainly symbols, and even if a picture is worth a thousand words, we cannot consider these <a href="https://en.wikipedia.org/wiki/Proto-writing"><em>proto-writing</em></a> systems to be expressive enough to be considered like <a href="https://en.wikipedia.org/wiki/Writing_system"><em>writing systems</em></a>. Drawing is not writing.</p>
</div>
<div class="paragraph">
<p>We have to move forward to the beginning of the Bronze Age (around 3000 BC) to discover the earliest writing systems, in particular, the famous Egyptian hieroglyphs. They were still symbols, but once their significance was revealed, the meaning of hieroglyphs was unequivocal. <strong>A writing system represents communication visually, using a shared understanding between writers and readers of the meaning behind the sets of characters that make up a script.</strong></p>
</div>
<div class="paragraph">
<p>Concerning hieroglyphs, this shared understanding was completely lost during the medieval period. The breakthrough in decipherment finally came when Napoleon&#8217;s troops discovered the Rosetta Stone in 1799. The stone refuted the assumption that hieroglyphs recorded ideas and not the sounds of the language. Hieroglyphs are not drawing but true characters. This idea will serve as the main inspiration for the first alphabets, including the Latin alphabet I am currently using on my computer.</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-story-computers">The Rise of Computers</h3>
<div class="paragraph">
<p>Computers are not as convenient as papyrus for hieroglyphs. Computers deal with numbers composed of 0 and 1. They store letters and other characters by assigning a number to each of them, a process called <a href="https://en.wikipedia.org/wiki/Character_encoding"><em>character encoding</em></a>, just like the <a href="https://en.wikipedia.org/wiki/Morse_code">Morse code</a> uses signal durations to encode characters.</p>
</div>
<div class="paragraph">
<p>The earlier character encodings were limited and did not cover characters for all the world‚Äôs languages. They even didn&#8217;t cover all the symbols in common use in English&#8230;&#8203; The fact is there are so many writing systems that classifying them is already a challenge. Chinese uses roughly 50,000 characters representing meanings (Êó• for "sun"), Japanese uses approximately 100 characters representing whole syllables („Åü for "ta"), and Greek uses 34 characters representing sounds (Œ± and Œ≤ for "alpha" and "beta", the two first letters which serve as the etymology of the word "alphabet"). In addition, if we consider the limited space of the first computers, we can understand why <strong>the main problem was not how to support all languages but how to save bytes</strong>.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="paragraph">
<p>ASCII was the first widely used encoding and used only seven bytes, enough to represent 128 unique characters (2<sup>7</sup> = 128):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/ascii-charset.png" alt="ascii charset" width="600">
</div>
<div class="title">Figure 1. ASCII character set</div>
</div>
<div class="paragraph">
<p>Note that ASCII reserves <a href="http://www.catb.org/esr/faqs/things-every-hacker-once-knew/#_ascii">the first 32 codes for non-printable control characters</a>. For example, the character 10 represents a line feed, causing a <em>printer</em> to advance its paper to the next line and the character 8 is emitted by the <em>terminal</em> when pressing Ctrl+D to represent the "end of file."</p>
</div>
<div class="paragraph">
<p>Gradually people wanted more characters and new character encodings started to use the other 128 values available when taking all 8 bits of a byte.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> The most famous were <a href="https://en.wikipedia.org/wiki/ISO/IEC_8859-1">ISO 8859-1</a> and <a href="https://en.wikipedia.org/wiki/Windows-1252">Windows 1252</a>, the latter being a superset of the former.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/ascii-8bits.png" alt="ascii 8bits" width="650">
</div>
<div class="title">Figure 2. Common character sets extending ASCII</div>
</div>
<div class="paragraph">
<p>These encodings are just two examples among so many others.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/extended-ascii.png" alt="extended ascii" width="650">
</div>
<div class="title">Figure 3. Examples of incompatible character sets extending ASCII</div>
</div>
<div class="paragraph">
<p>In practice, whenever textual data was exchanged between different programs or
computers, the risk of corruption was high as different character encodings often use different codes for the same character. Moreover, computers did not support all character encodings, and many languages lacked character support altogether. Clearly, <strong>256 unique codes were nowhere near enough</strong>, especially to create multilingual documents.</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-story-unicode">The Rise of Unicode</h3>
<div class="paragraph">
<p>The origins of Unicode dates back to 1987, but the name Unicode first appeared the next year in the document <a href="https://unicode.org/history/unicode88.pdf"><em>Unicode 88</em></a>. <strong>The intent of Unicode was to create "a <em>uni</em>que, <em>uni</em>fied, <em>uni</em>versal en<em>cod</em>ing," so that computers would only have to implement a single encoding to support all languages</strong>.</p>
</div>
<div class="paragraph">
<p>Unicode began with a 16-bit design (i.e., 65,536 codes "to encompass the characters of all the world&#8217;s living languages"<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>), but was extended in 1996 to support more than a million code points. The motivation was to allow the encoding of many historic scripts (e.g., the Egyptian hieroglyphs) and thousands of rarely used or obsolete characters that had not been anticipated as needing encoding (e.g., rarely used Kanji or Chinese characters, many of which are part of personal and place names, making them rarely used, but much more essential than envisioned in the original architecture of Unicode). History is always surprising.</p>
</div>
<div class="paragraph">
<p>In the meantime, the <a href="https://en.wikipedia.org/wiki/Unicode_Consortium">Unicode Consortium</a> was created in 1991. This nonprofit organization, which counts only three employees, still has the same ambitious goal of replacing all existing character encodings. This goal has almost become a reality. <a href="https://w3techs.com/technologies/details/en-utf8">More than 95% of the Internet</a> uses Unicode (<a href="https://googleblog.blogspot.com/2010/01/unicode-nearing-50-of-web.html">it was just 50% a decade ago</a>), and almost all electronic devices support Unicode too.</p>
</div>
<div class="paragraph">
<p>This organization is funded by <a href="https://home.unicode.org/membership/membership-levels/">membership fees</a> (from $75 for an individual to $21,000 for a full-member company) and <a href="https://www.unicode.org/consortium/donations.html">donations</a>, but you can also support them by <a href="https://home.unicode.org/adopt-a-character/about-adopt-a-character/">adopting a character</a> for $100 (or $1000-$5000 for exclusivity).</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-story-emojis">The Rise of Emojis</h3>
<div class="paragraph">
<p>The number of available code points exploded when Unicode dropped the 16-bit limitation. If 65,536 codes may seem a lot at that time, Unicode was now able to represent more than one million codes! Not all codes are in use. <strong>Unicode is an evolving standard</strong>. The current version Unicode 13.0.0 uses "only" 143,859 codes, including <a href="https://unicode.org/emoji/charts/full-emoji-list.html">more than 2000 special characters</a> that we call emojis.</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://www.statista.com/chart/17275/number-of-emojis-from-1995-bis-2019/"><img src="/posts_resources/2021-06-19-unicode-for-curious-developers/emojis-history-infography.jpeg" alt="emojis history infography" width="700"></a>
</div>
<div class="title">Figure 4. Emojis are probably the fatest growing language in the world (Source: Statista)</div>
</div>
<div class="paragraph">
<p><strong>Emojis didn&#8217;t appear with Unicode</strong>. They were born in the 90s in Japan ( ÁµµÊñáÂ≠ó [emod ëi] means "picture character"), and must not be confused with emoticons such as :-), which are text-based. Emojis were called <em>smileys</em> at that time. They were used mainly by mobile manufacturers and implemented using custom fonts like <a href="https://en.wikipedia.org/wiki/Wingdings">Wingdings</a>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/Wingdings.png" alt="Wingdings">
</div>
<div class="title">Figure 5. Mosaic of Wingdings characters (Source: Wikipedia)</div>
</div>
<div class="paragraph">
<p>If the receiver of your message didn&#8217;t have the font on his device, letters were displayed instead. For example, the national park pictogram üèû was available in Webdings at 0x50, which corresponded to the capital letter P encoded in ASCII. To solve this problem, new character encodings were introduced to not mix characters and emojis by using different codes. Unicode was in danger.</p>
</div>
<div class="paragraph">
<p>Therefore, Google employees requested that Unicode looks into the possibility of a uniform emoji set. As a result, 722 emojis were released in 2010 as Unicode 6.0, and each new version now integrates new emojis. Unicode entered a new era.</p>
</div>
<div class="paragraph">
<p>Emoji standardization has put pressure on the Unicode Consortium, overtaking the initial focus on standardizing characters used for minority languages. But the desire for more emojis has put pressure on vendors too to improve their Unicode support, leading to better support for Unicode&#8217;s minority languages. A good example of a win-win situation. <strong>Emojis contribute to preserving the writing of the past while making the writing of the future more fun</strong>.</p>
</div>
<div class="paragraph">
<p>The primary function of emojis was to fill in emotional cues otherwise missing from typed conversations (üò¢ü§£üòâüòçü•≥). But emojis have been extended to include a lot more (üë∂üë∞üßõ‚Äç‚ôÇÔ∏èüï∂üêºüçÄ‚òÄÔ∏èü•ù‚öΩÔ∏èüö¥‚Äç‚ôÄÔ∏è‚úàÔ∏è).</p>
</div>
<div class="paragraph">
<p>Now, when the Unicode Technical Committee meets quarterly to decide which new characters will be encoded, they also decide about <a href="https://www.unicode.org/emoji/future/emoji-candidates.html">new emojis</a>. <strong>Any individual or organization can suggest a new emoji by writing a proposal</strong> (the <a href="https://unicode.org/L2/L2019/19232-n5085-troll-emoji.pdf">proposal for a troll emoji</a> is a 10-page document using Google Trends, and film references to justify its introduction). The selection process uses <a href="http://unicode.org/emoji/proposals.html#selection_factors">well-documented rules</a>. A quorum of half of the Consortium&#8217;s <a href="https://home.unicode.org/membership/members/">full members</a> is required. There are currently ten full members, only one of which, the Ministry of Endowments and Religious Affairs of Oman, is not a tech company. The other nine are Adobe, Apple, Facebook, Google, IBM, Microsoft, Netflix, SAP, Salesforce, and a newcomer, <a href="https://y.at/">Yat</a>.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-standard">The Standard</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unicode can be used informally to refer to the <em>Unicode Standard</em>, the encoding standard for characters, and the <em>Unicode Consortium</em>, the organization that created the Unicode Standard. We have already talked about the consortium in the last part. We will now look at the Unicode Standard, and the next part will focus on its implementation in modern systems.</p>
</div>
<div class="sect2">
<h3 id="sect-standard-standard">The Unicode Standard</h3>
<div class="paragraph">
<p>The Unicode Standard is the reference document and is <a href="http://www.unicode.org/versions/latest/">freely accessible online</a> (the <a href="https://www.amazon.com/Unicode-Standard-Version-5-0-5th/dp/0321480910/">last edition published as a book</a> dates back to 2006, and recent editions are available as Print-on-Demand (POD) for purchase on <a href="https://www.lulu.com/en/us/shop/unicode-consortium/the-unicode-standard-version-130-volume-1/paperback/product-qkgep6.html">lulu.com</a>). The <a href="https://www.unicode.org/versions/Unicode13.0.0/UnicodeStandard-13.0.pdf">current PDF version</a> contains more than 1000 pages, but only the first 300 pages define Unicode and are a must-read if you want to go deeper on the subject. The remaining pages examine all supported scripts one by one.</p>
</div>
<div class="paragraph">
<p>The main contribution of the Unicode Standard is the <em>Unicode Character Table</em>. <strong>Unicode specifies a numeric value (code point) and a name for every defined
character</strong>. In this respect, it is similar to other character encoding standards from ASCII
onward. But the Unicode Standard is far more than a simple encoding of characters. <strong>Unicode also associates a rich set of semantics with each encoded character</strong>‚Äîproperties like case and directionality required for interoperability and correct behavior in implementations. These semantics are cataloged in the <em>Unicode Character Database</em>, a collection of data files discussed at length in the last part.</p>
</div>
<div class="paragraph">
<p><strong>The Unicode Character Table has an overall capacity for more than 1 million characters</strong>, which is more than sufficient for all the world&#8217;s languages, but also for currency symbols, punctuation marks, mathematical symbols, technical symbols, geometric shapes, dingbats, and emojis. The Unicode Standard does not encode personal characters like logos but reserves 6,400 code points for private use in the Basic Multilingual Plane (BMP), the first 65,536 code points, and more than 100,000 private code points overall.</p>
</div>
<div class="paragraph">
<p><strong>A <em>character</em> is an abstract entity</strong>, such as ‚Äúlatin capital letter a‚Äù or ‚Äúbengali digit five,‚Äù defined by a unique code point, such as U+0041 or U+09EB. These code points are integers represented in base 16, ranging from 0 to 10FFFF (called the <em>codespace</em>). The representation of a character on screen, called a <em>glyph</em>, depends on the software implementation, based on the fonts available on your device. The Unicode Standard does not specify the precise shape, size, or orientation of on-screen characters. <strong>Unicode characters are code points, not glyphs</strong>. Unicode declares that U+0041 is A, U+03B1 is Œ±, etc. Simple?</p>
</div>
<div class="paragraph">
<p>BUT.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unicode includes <em>compatibility characters</em>, which would not be included if they were not present in other standards.<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup> The idea is to make it easy to have a one-to-one mapping between the Unicode Standard and other standards. For example, U+2163 ‚ÄúIV‚Äù is the roman numeral four even if we could have used two existing characters to represent it.</p>
</li>
<li>
<p>Unicode includes <em>combining characters</em>, which are characters to be positioned relative to the previous base characters. Accents are implemented using combining characters, so U+0065 e + U+0302  ÃÇ ‚Üí √™, and symbols can be composed using the same mechanism, so:</p>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-standard-figure-2-17.png" alt="unicode standard figure 2 17" width="300">
</div>
<div class="title">Figure 6. Combining Enclosing Marks for Symbols (From Unicode Standard, Figure 2.17)</div>
</div>
<div class="paragraph">
<p>Unicode does not restrict the number of combining characters that may follow a base character, but implementations are not obliged to support all of them.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-standard-figure-2-21.png" alt="unicode standard figure 2 21" width="500">
</div>
<div class="title">Figure 7. Stacking Sequences (From Unicode Standard, Figure 2.21)</div>
</div>
</li>
<li>
<p>Unicode recognizes <em>equivalent sequences</em>, which are two sequences using different Unicode codes to represent the same character.</p>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-standard-figure-2-23.png" alt="unicode standard figure 2 23" width="400">
</div>
<div class="title">Figure 8. Equivalent Sequences (From Unicode Standard, Figure 2.23)</div>
</div>
</li>
<li>
<p>Unicode includes <em>special characters</em>. For example, UTF-16 and UTF-32 are sensible to the endianness of the hardware and often include a Byte Order Mark (BOM), which is composed of two code points‚ÄîU+FEFF <code>zero width no-break space</code> and U+FFFE (a special character). Implementations can detect which byte ordering is used in a file based on the order of these two code points. Another common example is the U+FFFD <code>replacement character</code> ÔøΩ used to represent ‚Äúunknown‚Äù characters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will talk more about these particularities when covering the implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-standard-character-table">The Unicode Character Table</h3>
<div class="paragraph">
<p>The <a href="https://unicode.org/charts/">Unicode Character Table</a> has room for more than one million characters. That&#8217;s a lot! Their position in this table means nothing.  (There are small differences like the number of bytes to represent them in the various encodings but from a logical perspective, all characters behave similarly.) In theory, the code point of a character only needs to be unique, but in practice, its assignment follows some "conventions." Marie Kondo would probably appreciate the effort to organize the characters.</p>
</div>
<div class="paragraph">
<p><strong>The codespace is divided up into 17 <em>planes</em> of characters</strong>‚Äîeach plane consisting of 64K code points. Not all planes are currently in use.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Plane 0: the <em>Basic Multilingual Plane</em> (BMP) is the main descendant of the first version of Unicode (with the 16-bits limitation), and the majority of frequent characters can be found here.</p>
</li>
<li>
<p>Plane 1: the <em>Supplementary Multilingual Plane</em> (SMP) is the extension of the BPM for scripts or symbols with very infrequent usage. Most emojis are present in Plane 1, but as always, exceptions exist üòâ.</p>
</li>
<li>
<p>Plane 2: the <em>Supplementary Ideographic Plane</em> (SIP) is similar to Plane 1 but for rare  CJK characters. (CJK is a collective term for the Chinese, Japanese, and Korean languages.)</p>
</li>
<li>
<p>Planes 3..13 are &#8230;&#8203; empty.</p>
</li>
<li>
<p>Plane 14: the <em>Supplementary Special-purpose Plane</em> (SSP) is the spillover allocation area for format control characters that do not fit into the small allocation areas for format control characters in the BMP.</p>
</li>
<li>
<p>Planes 15..16: the <em>Private Use Planes</em>. These code points can be freely used for any purpose, but their use requires that the sender and receiver agree on their interpretation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Planes are further divided into subparts called <em>blocks</em></strong>. Character blocks generally contain characters from a single <em>script</em>, and in many cases, a script is fully represented in its block.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-allocation.png" alt="unicode allocation" width="750">
</div>
<div class="title">Figure 9. Unicode allocation</div>
</div>
<div class="paragraph">
<p>These blocks and scripts are also used to organize the <a href="https://unicode.org/charts/">Unicode Code Charts</a> in the documentation so that you can quickly jump to the given script of your language. If you want the full listing instead, you can download <a href="https://www.unicode.org/Public/UCD/latest/charts/CodeCharts.pdf">the complete code charts in PDF</a> (2684 pages and 110 MB! üòÖ).</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://www.unicode.org/charts/#scripts"><img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-code-charts.png" alt="unicode code charts"></a>
</div>
<div class="title">Figure 10. Unicode Character Code Charts</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-standard-character-database">The Unicode Character Database</h3>
<div class="paragraph">
<p>The <a href="https://www.unicode.org/reports/tr44">Unicode Character Database</a> (UCD) is a set of documentation and data files <a href="https://www.unicode.org/Public/UCD/latest/ucd/">accessible online</a>. These files contain more than 100 character properties, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A name<br>
‚Üí Useful to refer to a character using a unique identifier instead of a hexadecimal value, like using the name <code>tab</code> instead of U+0009.</p>
</li>
<li>
<p>The general category (basic partition into letters, numbers, symbols, punctuation, and so on).<br>
‚Üí Useful to determine the primary use (letter, digit, punctuation, symbol) when implementing functions like <code>isDigit()</code>.</p>
</li>
<li>
<p>Some general characteristics (whitespace, dash, ideographic, alphabetic, noncharacter, deprecated, and so on)<br>
‚Üí Useful to determine the kind of character like digits.</p>
</li>
<li>
<p>Some display-related properties (bidirectional class, shaping, mirroring, width, and so on)<br>
‚Üí Useful when rendering the text on screen.</p>
</li>
<li>
<p>The case (upper, lower, title, folding‚Äîboth simple and full)<br>
‚Üí Useful to determine if a character is uppercase.</p>
</li>
<li>
<p>The script and block a character belongs.<br>
‚Üí Useful to find characters commonly used together.</p>
</li>
<li>
<p>and a lot more!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can visualize these properties from many websites like <a href="https://unicode-table.com/">unicode-table.com</a>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-table-character-A.png" alt="unicode table character A">
</div>
</div>
<div class="paragraph">
<p>These websites are based on the files available in the UCD. We will present the main ones in this article. These files follow a few conventions: each line consists of fields separated by semicolons, the first field represents a code point or range expressed as hexadecimal numbers. The remaining fields are properties associated with that code point. A code point may be omitted in a data file if the default value for the property in question applies.</p>
</div>
<div class="paragraph">
<p><code>UnicodeData.txt</code> is the main file:</p>
</div>
<div class="listingblock">
<div class="title">UnicodeData.txt</div>
<div class="content">
<pre class="CodeRay highlight"><code>...
0009;&lt;control&gt;;Cc;0;S;;;;;N;CHARACTER TABULATION;;;;
‚Ä¶
0021;EXCLAMATION MARK;Po;0;ON;;;;;N;;;;;
‚Ä¶
0041;LATIN CAPITAL LETTER A;Lu;0;L;;;;;N;;;;0061;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where (<a href="https://www.unicode.org/reports/tr44/#UnicodeData.txt">see full details</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0041</code> is the code point (U+0041).</p>
</li>
<li>
<p><code>LATIN CAPITAL LETTER A</code> is the property <code>NAME</code>.</p>
</li>
<li>
<p><code>Lu</code> is the abbreviation for the value <code>Uppercase_Letter</code> of the property <code>General_Category</code>.</p>
</li>
<li>
<p><code>L</code> is the abbreviation for the value <code>Left_To_Right</code> of the property <code>Bidi_Class</code> to indicate a left-to-right character. <code>ON</code> stands for <code>Other_Neutral</code> and is used by most punctuation characters.</p>
</li>
<li>
<p><code>0061</code> is the code point value of the property <code>Simple_Lowercase_Mapping</code> which means the lowercase character for U+0041 <code>A</code> is U+0061 <code>a</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>emoji-data.txt</code> is the main file concerning emojis:</p>
</div>
<div class="listingblock">
<div class="title">emoji/emoji-data.txt</div>
<div class="content">
<pre class="CodeRay highlight"><code>...
1F600         ; Emoji                # E1.0   [1] (üòÄ)       grinning face
1F601..1F606  ; Emoji                # E0.6   [6] (üòÅ..üòÜ)    beaming face with smiling eyes..grinning squinting face
1F607..1F608  ; Emoji                # E1.0   [2] (üòá..üòà)    smiling face with halo..smiling face with horns
1F609..1F60D  ; Emoji                # E0.6   [5] (üòâ..üòç)    winking face..smiling face with heart-eyes
1F60E         ; Emoji                # E1.0   [1] (üòé)       smiling face with sunglasses
1F60F         ; Emoji                # E0.6   [1] (üòè)       smirking face
1F610         ; Emoji                # E0.7   [1] (üòê)       neutral face
1F611         ; Emoji                # E1.0   [1] (üòë)       expressionless face
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where (<a href="https://www.unicode.org/reports/tr44/#emoji-data.txt">see full details</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Emoji</code> is the default type. Other possible values are <code>Emoji_Modifier</code> for the skin tone modifier, <code>Emoji_Modifier_Base</code> for characters that can serve as a base for emoji modifiers. <code>Emoji_Component</code> for characters used in emoji sequences like flags.</p>
</li>
<li>
<p>The comment indicates the first version that introduced the emoji(s), the count of emojis in the range, a preview of the emoji(s), and their name(s).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sect-standard-encodings">The Unicode Encodings</h3>
<div class="paragraph">
<p>Character encodings are necessary when exchanging or storing texts. Computers only understand <code>0</code>s and <code>1</code>s and therefore, Unicode code points must be converted into binary.</p>
</div>
<div class="paragraph">
<p>The Unicode Standard provides three distinct encoding forms for Unicode characters, using minimum 8-bit, 16-bit, and 32-bit units. These are named UTF-8, UTF-16, and UTF-32, respectively. <strong>All three encoding forms can be used to represent the full range of Unicode characters and each one can be efficiently transformed into either of the other two without any loss of data</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-standard-figure-2-11.png" alt="unicode standard figure 2 11" width="500">
</div>
<div class="title">Figure 11. Unicode Encoding Forms (From Unicode Standard, Figure 2.11)</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">The Principle of Nonoverlapping</div>
<div class="paragraph">
<p>Unicode encodings differ from many prior encodings that also use varied-length bytes but where overlap was permitted. For example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-standard-figure-2-9.png" alt="unicode standard figure 2 9" width="500">
</div>
<div class="title">Figure 12. Overlap in Legacy Mixed-Width Encodings (From Unicode Standard, Figure 2.9)</div>
</div>
<div class="paragraph">
<p>To determine the character, these encodings depend on the first byte. If someone
searches for the character ‚ÄúD,‚Äù for example, he might find it in the trail byte of the two-byte sequence –î. The program must look backward through text to find the correct matches, but the boundaries are not always easy to interpret with overlapping:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-standard-figure-2-10.png" alt="unicode standard figure 2 10" width="500">
</div>
<div class="title">Figure 13. Boundaries and Interpretation (From Unicode Standard, Figure 2.10)</div>
</div>
<div class="paragraph">
<p>Therefore, each of the Unicode encoding forms is designed with the principle of nonoverlapping in mind to make implementations more simple and more efficient.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sect-standard-encodings-utf32">UTF-32</h4>
<div class="paragraph">
<p>UTF-32 is the simplest Unicode encoding form. UTF-32 is a fixed-width character encoding form. <strong>Each Unicode code point is represented directly by a single 32-bit code unit</strong>. Because of this, UTF-32 has a one-to-one relationship between encoded character and code unit;</p>
</div>
<div class="paragraph">
<p>Note that 32 bits have space for more than four million codes, but UTF-32 restricts the representation of code points in the standard ranges 0..10FFFF (we need to cover UTF-16 first to explain this restriction).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go"><span class="keyword">import</span> (
    <span class="string"><span class="delimiter">&quot;</span><span class="content">bytes</span><span class="delimiter">&quot;</span></span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">encoding/binary</span><span class="delimiter">&quot;</span></span>
)

<span class="keyword">func</span> EncodeUTF32BE(codepoints []<span class="predefined-type">uint32</span>) []<span class="predefined-type">byte</span> {
    buf := <span class="predefined">new</span>(bytes.Buffer)

    <span class="comment">// BOM (optional)</span>
    binary.Write(buf, binary.BigEndian, <span class="predefined-type">uint32</span>(<span class="hex">0xFEFF</span>))

    <span class="keyword">for</span> _, codepoint := <span class="keyword">range</span> codepoints {
        <span class="comment">// Each codepoint is written as unit32</span>
        binary.Write(buf, binary.BigEndian, codepoint)
    }

    <span class="keyword">return</span> buf.Bytes()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Decoding follows the inverse logic:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read the next four bytes.</p>
</li>
<li>
<p>Extract the value to get the code point.</p>
</li>
<li>
<p>Repeat.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preferred Usage</strong>: UTF-32 may be preferred where memory or disk storage space is not limited and when the simplicity of access to single code units is desired. For example, the first version of Python 3 represented strings as sequences of Unicode code points, but Python 3.3 changed the implementation to optimize the memory usage.</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-standard-encodings-utf16">UTF-16</h4>
<div class="paragraph">
<p><strong>UTF-16 is the historical descendant of the earliest form of Unicode where only 16-bits were used for code points</strong>. The characters in the range U+0000..U+FFFF (the first 65,536 characters) are often called the Basic Multilingual Plane (BMP, or Plane 0), and are encoded as a single 16-bit code unit using the code point value like in UTF-32.</p>
</div>
<div class="paragraph">
<p>The remaining characters are called <em>surrogates</em> and are encoded as pairs of 16-bit code units whose values are disjunct from the code units used for the single code unit representations, thus maintaining non-overlap for all code point representations in UTF-16.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Understanding the maximum number of code points in Unicode</div>
<div class="paragraph">
<p>Not breaking already encoded texts in UCS-2 (known as Unicode at that time) was the biggest challenge to extend the initial number of Unicode characters (2<sup>16</sup> = 65536 characters).</p>
</div>
<div class="paragraph">
<p>The solution (now called UTF-16) is to rely on two unused ranges 0xD800..0xDBFF and 0xDC00‚Äì0xDFFF (each one representing 1024 code points). If we concatenate these two ranges, it means we can represent 1024 * 1024 = 1,048,576 new characters, in addition to the 63488 original code points (2<sup>16</sup> - 2048, the number of unique code points that fits 2 bytes minus the ranges previously unused).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-codespace-size-limit.png" alt="unicode codespace size limit" width="600">
</div>
<div class="title">Figure 14. Unicode surrogate codes</div>
</div>
<div class="paragraph">
<p>So, in UTF-16, the representation for all initial characters does not change. But when we need to encode one of the new characters, we will not use their code points&#8212;&#8203;they just cannot fit in a 16-byte word&#8212;&#8203;but use instead what is called a surrogate pair, which is a pair of pointers to retrieve the original code point. If we consider the binary representation of the two previously unused ranges:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>0xD800 = 0b1101100000000000 (110110 = high surrogate prefix)
0xDFFF = 0b1101111111111111 (110111 =  low surrogate prefix)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Every new code point is represented in UTF-16 by two 16-bytes words‚Äîthe high surrogate followed by the low surrogate‚Äîeach one uses one of the two ranges. Note that six bits are reserved for the prefix of the ranges. Therefore, if a byte starts with <code>110110</code>, we know we have a high surrogate that is followed by a low surrogate starting with <code>110111</code>, and inversely. It means we have 20 representative bits to represent the new characters (2<sup>20</sup> = 1,048,576).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/surrogate-pair-decoding.png" alt="surrogate pair decoding" width="600">
</div>
<div class="title">Figure 15. Decoding surrogate pairs in UTF-16</div>
</div>
<div class="paragraph">
<p>Even if other encodings like UTF-32 and UTF-8 can represent more code points, the total number of valid Unicode code points is still constrained by UTF-16 for backward compatibility reasons. The exact number is <a href="https://www.johndcook.com/blog/2019/09/02/number-of-possible-unicode-characters">1,111,998 possible Unicode characters</a>, a little less than our estimation due to 2 reserved characters at the end of each plane.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go"><span class="keyword">import</span> (
    <span class="string"><span class="delimiter">&quot;</span><span class="content">bytes</span><span class="delimiter">&quot;</span></span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">encoding/binary</span><span class="delimiter">&quot;</span></span>
)

<span class="keyword">func</span> EncodeUTF16BE(codepoints []<span class="predefined-type">uint32</span>) []<span class="predefined-type">byte</span> {
    <span class="comment">// Code is inspired by Go official implementation of module unicode/utf16</span>
    <span class="comment">// https://github.com/golang/go/blob/go1.16/src/unicode/utf16/utf16.go</span>

    buf := <span class="predefined">new</span>(bytes.Buffer)

    <span class="comment">// BOM</span>
    binary.Write(buf, binary.BigEndian, <span class="predefined-type">uint16</span>(<span class="hex">0xFEFF</span>))
    <span class="keyword">for</span> _, v := <span class="keyword">range</span> codepoints {
        <span class="keyword">switch</span> {
        <span class="keyword">case</span> v &lt; <span class="hex">0x10000</span>:
            <span class="comment">// Code points in the Basic Multilingual Plane (BMP)</span>
            <span class="comment">// are written as such in uint16 as they can safely</span>
            <span class="comment">// be stored in two bytes.</span>
            binary.Write(buf, binary.BigEndian, <span class="predefined-type">uint16</span>(v))
        <span class="keyword">case</span> <span class="hex">0x10000</span> &lt;= v:
            <span class="comment">// Code points in Supplementary Planes are encoded</span>
            <span class="comment">// as two 16-bit code units called a surrogate pair.</span>

            <span class="comment">// 0x10000 is subtracted from the code point,</span>
            <span class="comment">// leaving a 20-bit number in the hex number range 0x00000‚Äì0xFFFFF</span>
            r := v - <span class="hex">0x10000</span>

            <span class="comment">// The high ten bits (in the range 0x000‚Äì0x3FF) are added to 0xD800</span>
            <span class="comment">// to give the first 16-bit code unit or high surrogate,</span>
            <span class="comment">// which will be in the range 0xD800‚Äì0xDBFF.</span>
            r1 := <span class="hex">0xd800</span> + (r&gt;&gt;<span class="integer">10</span>)&amp;<span class="hex">0x3ff</span>
            binary.Write(buf, binary.BigEndian, <span class="predefined-type">uint8</span>(r1))

            <span class="comment">// The low ten bits (also in the range 0x000‚Äì0x3FF) are added</span>
            <span class="comment">// to 0xDC00 to give the second 16-bit code unit or low surrogate,</span>
            <span class="comment">// which will be in the range 0xDC00‚Äì0xDFFF.</span>
            r2 := <span class="hex">0xdc00</span> + r&amp;<span class="hex">0x3ff</span>
            binary.Write(buf, binary.BigEndian, <span class="predefined-type">uint8</span>(r2))
        }
    }

    <span class="keyword">return</span> buf.Bytes()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Decoding simply needs to test for surrogates:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read the next two bytes.</p>
</li>
<li>
<p>If the value is in the range U+0000..U+FFFF, this is a code point.</p>
</li>
<li>
<p>Otherwise, retrieve the value from the high surrogate (0xD800..0xDBFF) and the low surrogate (0xDC00‚Äì0xDFFF) by reading two more bytes and extract the code point using basic mathematical operations.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preferred Usage</strong>: UTF-16 provides a balanced representation that is reasonably compact as all the common, heavily used characters fit into a single 16-bit code unit. This encoding is often used by programming languages as their internal representation of strings for that reason, but for file encoding, UTF-8 is by far the most privileged encoding.</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-standard-encodings-utf8">UTF-8</h4>
<div class="paragraph">
<p>UTF-8 is a variable-width like UTF-16, but offering compatibility with ASCII. That means Unicode code points U+0000..U+007F are converted to a single byte 0x00..0x7F in UTF-8 and are thus indistinguishable from ASCII itself. An ASCII document is a valid UTF-8 document (the reverse is rarely true).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">First code point</th>
<th class="tableblock halign-left valign-top">Last code point</th>
<th class="tableblock halign-left valign-top">Byte 1</th>
<th class="tableblock halign-left valign-top">Byte 2</th>
<th class="tableblock halign-left valign-top">Byte 3</th>
<th class="tableblock halign-left valign-top">Byte 4</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">U+0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U+007F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xxxxxxx</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">U+0080</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U+07FF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>11</strong>0xxxxx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10xxxxxx</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">U+0800</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U+FFFF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>111</strong>0xxxx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10xxxxxx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10xxxxxx</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">U+10000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U+10FFFF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>1111</strong>0xxx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10xxxxxx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10xxxxxx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10xxxxxx</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that when the first byte starts with <code>1</code>, the number of successive <code>1</code>s gives the number of bytes for this code point.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go"><span class="keyword">import</span> (
    <span class="string"><span class="delimiter">&quot;</span><span class="content">bytes</span><span class="delimiter">&quot;</span></span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">encoding/binary</span><span class="delimiter">&quot;</span></span>
)

<span class="keyword">func</span> EncodeUTF8(codepoints []<span class="predefined-type">uint32</span>) []<span class="predefined-type">byte</span> {
    <span class="comment">// Code is inspired by Go official implementation of module unicode/utf8</span>
    <span class="comment">// https://github.com/golang/go/blob/go1.16/src/unicode/utf8/utf8.go</span>

    buf := <span class="predefined">new</span>(bytes.Buffer)

    <span class="comment">// Note: The Unicode Standard neither requires nor recommends</span>
    <span class="comment">// the use of the BOM for UTF-8.</span>

    <span class="keyword">for</span> _, r := <span class="keyword">range</span> codepoints {
        <span class="keyword">switch</span> i := <span class="predefined-type">uint32</span>(r); {

        <span class="comment">// 1 byte for ASCII characters</span>
        <span class="keyword">case</span> <span class="predefined-type">int</span>(r) &lt;= <span class="hex">0x007F</span>: <span class="comment">// 127</span>
            buf.WriteByte(<span class="predefined-type">byte</span>(r)) <span class="comment">// 0xxxxxxx</span>

        <span class="comment">// 2 bytes for most Latin scripts</span>
        <span class="keyword">case</span> i &lt;= <span class="hex">0x07FF</span>: <span class="comment">// 2047</span>
            buf.WriteByte(<span class="integer">0</span>b11000000 | <span class="predefined-type">byte</span>(r&gt;&gt;<span class="integer">6</span>))         <span class="comment">// 110xxxxx</span>
            buf.WriteByte(<span class="integer">0</span>b10000000 | <span class="predefined-type">byte</span>(r)&amp;<span class="integer">0</span>b00111111) <span class="comment">// 10xxxxxx</span>

        <span class="comment">// 3 bytes for the rest of the BMP</span>
        <span class="keyword">case</span> i &lt;= <span class="hex">0xFFFF</span>: <span class="comment">// 65535</span>
            buf.WriteByte(<span class="integer">0</span>b11100000 | <span class="predefined-type">byte</span>(r&gt;&gt;<span class="integer">12</span>))           <span class="comment">// 1110xxxx</span>
            buf.WriteByte(<span class="integer">0</span>b10000000 | <span class="predefined-type">byte</span>(r&gt;&gt;<span class="integer">6</span>)&amp;<span class="integer">0</span>b00111111) <span class="comment">// 10xxxxxx</span>
            buf.WriteByte(<span class="integer">0</span>b10000000 | <span class="predefined-type">byte</span>(r)&amp;<span class="integer">0</span>b00111111)    <span class="comment">// 10xxxxxx</span>

        <span class="comment">// 4 bytes for other planes and most emojis</span>
        <span class="keyword">default</span>:
            buf.WriteByte(<span class="integer">0</span>b11110000 | <span class="predefined-type">byte</span>(r&gt;&gt;<span class="integer">18</span>))            <span class="comment">// 11110xxx</span>
            buf.WriteByte(<span class="integer">0</span>b10000000 | <span class="predefined-type">byte</span>(r&gt;&gt;<span class="integer">12</span>)&amp;<span class="integer">0</span>b00111111) <span class="comment">// 10xxxxxx</span>
            buf.WriteByte(<span class="integer">0</span>b10000000 | <span class="predefined-type">byte</span>(r&gt;&gt;<span class="integer">6</span>)&amp;<span class="integer">0</span>b00111111)  <span class="comment">// 10xxxxxx</span>
            buf.WriteByte(<span class="integer">0</span>b10000000 | <span class="predefined-type">byte</span>(r)&amp;<span class="integer">0</span>b00111111)     <span class="comment">// 10xxxxxx</span>
        }
    }

    <span class="keyword">return</span> buf.Bytes()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Decoding is easy to implement.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read the next byte.</p>
</li>
<li>
<p>If it starts by <code>0</code>, the character is encoded using 1 byte.</p>
</li>
<li>
<p>If it starts by <code>110</code>, the character is encoded using 2 bytes. (two leading <code>1</code>s)</p>
</li>
<li>
<p>If it starts by <code>1110</code>, the character is encoded using 3 bytes. (three leading <code>1</code>s)</p>
</li>
<li>
<p>If it starts by <code>11110</code>, the character is encoded using 4 bytes. (four leading <code>1</code>s)</p>
</li>
<li>
<p>Read the remaining bits of the first byte.</p>
</li>
<li>
<p>Read the last six bits of the other composing byte(s).</p>
</li>
<li>
<p>Reassemble using basic mathematical operations to retrieve the code unit.</p>
</li>
<li>
<p>Repeat.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preferred Usage</strong>: UTF-8 is particularly compact when the text contains mainly ASCII characters, which is often the case for a large percent of the population, but UTF-8 is significantly larger for Asian writing systems compared to UTF-16 as these characters require three bytes in UTF-8.</p>
</div>
<div class="paragraph">
<p>In practice, UTF-8 has become the default Unicode encoding of the Web even if all three encodings are perfectly valid.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-implementation">The Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we understand the history of Unicode and what is the scope of the Unicode Standard, we may look at the implementation. What does it mean to support Unicode? For an operating system? For a programming language? For a desktop application? For a web application?</p>
</div>
<div class="paragraph">
<p>We will split this section based on the different steps of a program. A program manipulates data that is often received and sent over networks and eventually displayed to a user. Unicode plays an essential role in every step.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/implementation.png" alt="implementation" width="600">
</div>
</div>
<div class="sect2">
<h3 id="sect-implementation-reading">Reading</h3>
<div class="paragraph">
<p>When a program receives or reads a text, it needs to know the encoding. Having a text without knowing its encoding is useless‚Äîjust a suite of 0s and 1s. Several strategies exist to determine the encoding. For example, the source code of your program is also a text that the compiler or the interpreter must decode. The common solutions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Use the charset of the underlying operating system</strong> (ex: Java). Unix operating system family uses UTF-8 encoding by default, which means the Java compiler expects source files to be encoded in UTF-8 too. Otherwise, the developer needs to define the encoding explicitly from the command line (<code>java -Dfile.encoding=UTF-16</code>) or when reading a text:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// $LC_CTYPE returns &quot;UTF-8&quot;</span>
<span class="predefined-type">File</span> file = <span class="keyword">new</span> <span class="predefined-type">File</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/path/to/file</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">BufferedReader</span> br = <span class="keyword">new</span> <span class="predefined-type">BufferedReader</span>(<span class="keyword">new</span> <span class="predefined-type">InputStreamReader</span>(
    <span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(file), <span class="string"><span class="delimiter">&quot;</span><span class="content">UTF16</span><span class="delimiter">&quot;</span></span>)); <span class="comment">// Override default encoding</span>
...</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Use a default encoding and allows the developer to override it.</strong> (ex: Python). The Python interpreter expects UTF-8 files but supports <a href="https://www.python.org/dev/peps/pep-0263/">various syntaxes to specify a different encoding</a>.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment">#!/usr/bin/python env</span>
<span class="comment"># -*- coding: utf-16 -*-</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This magic comment must be the first or second line. As the interpreter ignores the encoding when reading the file, all characters until the encoding must only be ASCII characters. This technique was already used by browsers to determine the encoding of a web page. Initially, web servers were expected to return the HTTP header <code>Content-Type</code> (ex: <code>text/plain; charset="UTF-8"</code>) so that the browser knows the encoding before reading the HTML file, but in practice, a web server can serve different files written by different persons in different languages, and thus would also need to know the encoding&#8230;&#8203; The common solution was instead to include the charset directly in the document as the first meta under the <code>&lt;head&gt;</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;html&gt;</span>
<span class="tag">&lt;head&gt;</span>
<span class="tag">&lt;meta</span> <span class="attribute-name">http-equiv</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/html; charset=utf-8</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...</code></pre>
</div>
</div>
</li>
<li>
<p><strong>Force a specific encoding.</strong> (ex: Go). Go source code can only be written in UTF-8 files.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ cat &gt; hello.go &lt;&lt; EOF
package main

import &quot;fmt&quot;

func main() {
        fmt.Println(&quot;hello world&quot;)
}
EOF
$ iconv -f UTF-8 -t UTF-16 hello_UTF-16.go
$ go run hello_UTF-16.go
go: reading hello_UTF-16.go: unexpected NUL in input</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">The Byte Order Mark (BOM)</div>
<div class="paragraph">
<p>In practice, if a program only works with Unicode encodings (which is the goal of Unicode, after all), it can also check the <em>byte order mark</em> (BOM), a magic number representing the Unicode character, <code>U+FEFF BYTE ORDER MARK</code>. Depending on the starting byte sequence (<code>0xEF,0xBB,0xBF</code> for UTF-8, <code>0xFE 0xFF</code> for UTF-16 in big endian, <code>0xFF 0xFE</code> for UTF-16 in little endian, <a href="https://en.wikipedia.org/wiki/Byte_order_mark#Byte_order_marks_by_encoding">etc.</a>), the parser can detect the encoding (and the endianness). But the BOM is optional and is often missing in UTF-8 text because the BOM character is not a valid ASCII character, and that would break the ASCII backward compatibility supported by UTF-8.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the encoding is known, the next step is to decode the text. We have already covered the Unicode encoding algorithms in the second part. The decoding algorithms are very similar and the code is omitted. What is more interesting is the question of how to represent Unicode text in memory. The most basic string representation for a programming language is to store a sequence of Unicode code points:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># A custom string implementation for illustration purposes.</span>
<span class="keyword">class</span> <span class="class">String</span>:

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, codepoints=[]):
        <span class="predefined-constant">self</span>.codepoints = codepoints

    <span class="keyword">def</span> <span class="function">__len__</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined">len</span>(<span class="predefined-constant">self</span>.codepoints)

    <span class="keyword">def</span> <span class="function">__getitem__</span>(<span class="predefined-constant">self</span>, index):
        <span class="keyword">if</span> index &lt; <span class="predefined">len</span>(<span class="predefined-constant">self</span>.codepoints):
            <span class="keyword">return</span> <span class="predefined-constant">self</span>.codepoints[index]

s = String([<span class="hex">0x0068</span>, <span class="hex">0x0065</span>, <span class="hex">0x0079</span>, <span class="hex">0x1F600</span>]) <span class="comment"># &quot;hey\N{Grinning Face Emoji}&quot;</span>
print(<span class="predefined">len</span>(s)) <span class="comment"># 4</span>
print(s[<span class="integer">0</span>] == <span class="predefined">ord</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">h</span><span class="delimiter">&quot;</span></span>)) <span class="comment"># True</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In theory, this representation makes sense. A Unicode string is a sequence of code points. Encoding and decoding should only be performed when reading or sending a text to another program.</p>
</div>
<div class="paragraph">
<p>In practice, most Unicode characters land in the first plane (BMP), requiring only two bytes, and a lot of strings are composed of ASCII characters, requiring only one byte. It explains why most programming languages choose to represent strings differently. Unicode support is great but comes with a performance cost that implementations must limit.</p>
</div>
<div class="paragraph">
<p>For example, create a file <code>hello_UTF-8.py</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Voila</span><span class="char">\u0300</span><span class="content"> </span><span class="char">\N{winking face}</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, convert the file in the different Unicode encodings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ iconv -f UTF-8 -t UTF-32 hello.py &gt; hello_UTF-32.py
$ iconv -f UTF-8 -t UTF-16 hello.py &gt; hello_UTF-16.py</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the file representations for the three Unicode encodings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ hexdump hello_UTF-8.py
0000000 70 72 69 6e 74 28 22 56 6f 69 6c 61 5c 4e 7b 63
0000010 6f 6d 62 69 6e 69 6e 67 20 61 63 63 65 6e 74 20
0000020 67 72 61 76 65 7d 20 5c 4e 7b 77 69 6e 6b 69 6e
0000030 67 20 66 61 63 65 7d 22 29 0a
000003a

$ hexdump hello_UTF-16.py
0000000 fe ff 00 70 00 72 00 69 00 6e 00 74 00 28 00 22
0000010 00 56 00 6f 00 69 00 6c 00 61 00 5c 00 4e 00 7b
0000020 00 63 00 6f 00 6d 00 62 00 69 00 6e 00 69 00 6e
0000030 00 67 00 20 00 61 00 63 00 63 00 65 00 6e 00 74
0000040 00 20 00 67 00 72 00 61 00 76 00 65 00 7d 00 20
0000050 00 5c 00 4e 00 7b 00 77 00 69 00 6e 00 6b 00 69
0000060 00 6e 00 67 00 20 00 66 00 61 00 63 00 65 00 7d
0000070 00 22 00 29 00 0a
0000076

$ hexdump hello_UTF-32.py
0000000 00 00 fe ff 00 00 00 70 00 00 00 72 00 00 00 69
0000010 00 00 00 6e 00 00 00 74 00 00 00 28 00 00 00 22
0000020 00 00 00 56 00 00 00 6f 00 00 00 69 00 00 00 6c
0000030 00 00 00 61 00 00 00 5c 00 00 00 4e 00 00 00 7b
0000040 00 00 00 63 00 00 00 6f 00 00 00 6d 00 00 00 62
0000050 00 00 00 69 00 00 00 6e 00 00 00 69 00 00 00 6e
0000060 00 00 00 67 00 00 00 20 00 00 00 61 00 00 00 63
0000070 00 00 00 63 00 00 00 65 00 00 00 6e 00 00 00 74
0000080 00 00 00 20 00 00 00 67 00 00 00 72 00 00 00 61
0000090 00 00 00 76 00 00 00 65 00 00 00 7d 00 00 00 20
00000a0 00 00 00 5c 00 00 00 4e 00 00 00 7b 00 00 00 77
00000b0 00 00 00 69 00 00 00 6e 00 00 00 6b 00 00 00 69
00000c0 00 00 00 6e 00 00 00 67 00 00 00 20 00 00 00 66
00000d0 00 00 00 61 00 00 00 63 00 00 00 65 00 00 00 7d
00000e0 00 00 00 22 00 00 00 29 00 00 00 0a
00000ec</code></pre>
</div>
</div>
<div class="paragraph">
<p>We better understand why UTF-8 is preferred for writing code. The same motivation applies when designing the internal string representation.</p>
</div>
<div class="sect3">
<h4 id="example_java">Example: Java</h4>
<div class="paragraph">
<p>Before Java 9, <a href="https://github.com/openjdk/jdk/blob/jdk8-b120/jdk/src/share/classes/java/lang/String.java"><code>String</code></a> were represented internally as an array of char:</p>
</div>
<div class="listingblock">
<div class="title">java/lang/String.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">String</span>
    <span class="directive">implements</span> java.io.Serializable, <span class="predefined-type">Comparable</span>&lt;<span class="predefined-type">String</span>&gt;, <span class="predefined-type">CharSequence</span> {

    <span class="comment">/** The value is used for character storage. */</span>
    <span class="directive">private</span> <span class="directive">final</span> <span class="type">char</span> value<span class="type">[]</span>; <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">public</span> <span class="predefined-type">String</span>(<span class="type">byte</span> bytes<span class="type">[]</span>, <span class="type">int</span> offset, <span class="type">int</span> length, <span class="predefined-type">Charset</span> charset) {
        <span class="keyword">if</span> (charset == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">charset</span><span class="delimiter">&quot;</span></span>);
        checkBounds(bytes, offset, length);
        <span class="local-variable">this</span>.value =  StringCoding.decode(charset, bytes, offset, length); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="directive">public</span> <span class="type">char</span> charAt(<span class="type">int</span> index) {
        <span class="keyword">if</span> ((index &lt; <span class="integer">0</span>) || (index &gt;= value.length)) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">StringIndexOutOfBoundsException</span>(index);
        }
        <span class="keyword">return</span> value[index]; <i class="conum" data-value="3"></i><b>(3)</b>
    }

    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Javadoc specifies that the <code>char</code> data type is based on the original 16-bits Unicode specification. Only characters in the BMP can be stored in a <code>char</code> and characters in other planes must use surrogate codes. In short, the <code>String</code> data type is a Unicode text encoded in UTF-16.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class <code>StringCoding</code> uses the charset to determine the decoding algorithm to convert the bytes into UTF-16.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The method <code>charAt</code> retrieves a single character from its index.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since, Java adopted <a href="https://openjdk.java.net/jeps/254">compacts strings</a>. A string is now represented in UTF-16 only if it contains at least one non-ASCII character. Otherwise, Java fallbacks to a basic implementation storing each character in a single byte.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/openjdk/jdk/blob/jdk-16+36/src/java.base/share/classes/java/lang/String.java">current <code>String</code> implementation</a> was changed to use an array of bytes instead:</p>
</div>
<div class="listingblock">
<div class="title">java/lang/String.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">String</span>
    <span class="directive">implements</span> java.io.Serializable, <span class="predefined-type">Comparable</span>&lt;<span class="predefined-type">String</span>&gt;, <span class="predefined-type">CharSequence</span>,
               Constable, ConstantDesc {

    <span class="comment">/**
     * The value is used for character storage.
     */</span>
    <span class="annotation">@Stable</span>
    <span class="directive">private</span> <span class="directive">final</span> <span class="type">byte</span><span class="type">[]</span> value; <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="comment">/**
     * The identifier of the encoding used to encode the bytes in
     * {@code value}. The supported values in this implementation are
     *
     * LATIN1
     * UTF16
     */</span>
    <span class="directive">private</span> <span class="directive">final</span> <span class="type">byte</span> coder; <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="directive">public</span> <span class="predefined-type">String</span>(<span class="type">byte</span> bytes<span class="type">[]</span>, <span class="type">int</span> offset, <span class="type">int</span> length, <span class="predefined-type">Charset</span> charset) {
        <span class="keyword">if</span> (charset == <span class="predefined-constant">null</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">charset</span><span class="delimiter">&quot;</span></span>);
        checkBoundsOffCount(offset, length, bytes.length);
        StringCoding.Result ret =
            StringCoding.decode(charset, bytes, offset, length); <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="local-variable">this</span>.value = ret.value;
        <span class="local-variable">this</span>.coder = ret.coder;
    }

    <span class="directive">public</span> <span class="type">char</span> charAt(<span class="type">int</span> index) { <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="keyword">if</span> (isLatin1()) {
            <span class="keyword">return</span> StringLatin1.charAt(value, index);
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> StringUTF16.charAt(value, index);
        }
    }

    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Java <code>byte</code> type has a minimum value of -128 and a maximum value of 127 (inclusive). Depending on the content of the string, the bytes will be ASCII codes or UTF-16 bytes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The field <code>coder</code> is used by most methods in <code>String</code> to detect if the compact string optimization is used. This optimization is implemented by the new class <code>StringLatin1</code>. The former <code>String</code> implementation had been moved to <code>StringUTF16</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The class <code>StringCoding</code> now returns the value as bytes and the coder determined by searching for a non-ASCII character.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The method <code>charAt</code> now delegates to concrete String implementations. <code>StringLatin1</code> continues to return the character at the specified index. <code>StringUTF16</code> needs to read two elements in <code>value</code> to read the two bytes representing a UTF-16 character.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The motivation for compact strings is to reduce the memory footprint when working with ASCII characters only. It can be confirmed easily using a minimalist benchmark:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BenchmarkString</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; results = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(); <span class="comment">// Keep strings to avoid GC</span>
        <span class="predefined-type">Runtime</span> runtime = <span class="predefined-type">Runtime</span>.getRuntime();

        <span class="type">long</span> startTime = <span class="predefined-type">System</span>.nanoTime();
        <span class="type">long</span> memoryBefore = runtime.totalMemory() - runtime.freeMemory();

        <span class="predefined-type">String</span> loremIpsum = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="content">
Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
cillum dolore eu fugiat nulla pariatur.
Excepteur sint occaecat cupidatat non proident,
sunt in culpa qui officia deserunt mollit anim id est laborum.
        </span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;

        <span class="comment">// StringLatin1</span>
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">1000000</span>; i++) {
            results.add((loremIpsum + i).toLowerCase()); <i class="conum" data-value="1"></i><b>(1)</b>
        }

        <span class="type">long</span> timeElapsed = <span class="predefined-type">System</span>.nanoTime() - startTime;
        <span class="type">long</span> memoryAfter = runtime.totalMemory() - runtime.freeMemory();
        <span class="type">long</span> memoryUsed = memoryAfter - memoryBefore;
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">(Latin1) Execution time: </span><span class="delimiter">&quot;</span></span> + (timeElapsed / <span class="integer">1000000</span>) + <span class="string"><span class="delimiter">&quot;</span><span class="content">ms</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">(Latin1) Memory usage: </span><span class="delimiter">&quot;</span></span> +  (memoryUsed / <span class="integer">10000000</span>) + <span class="string"><span class="delimiter">&quot;</span><span class="content">MB</span><span class="delimiter">&quot;</span></span> );

        <span class="comment">// StringUTF16</span>
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">1000000</span>; i++) {
            results.add((loremIpsum + <span class="string"><span class="delimiter">&quot;</span><span class="content">üòÄ</span><span class="delimiter">&quot;</span></span> + i).toLowerCase()); <i class="conum" data-value="2"></i><b>(2)</b>
        }

        timeElapsed = <span class="predefined-type">System</span>.nanoTime() - startTime;
        memoryAfter = runtime.totalMemory() - runtime.freeMemory();
        memoryUsed = memoryAfter - memoryBefore;
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">(UTF-16) Execution time: </span><span class="delimiter">&quot;</span></span> + (timeElapsed / <span class="integer">1000000</span>) + <span class="string"><span class="delimiter">&quot;</span><span class="content">ms</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">(UTF-16) Memory usage: </span><span class="delimiter">&quot;</span></span> +  (memoryUsed / <span class="integer">10000000</span>) + <span class="string"><span class="delimiter">&quot;</span><span class="content">MB</span><span class="delimiter">&quot;</span></span> );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The string contains only ASCII characters, which means Java will use compact strings.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We add the emoji üòÄ <code>GRINNING FACE</code> U+1F600 to force strings to be encoded in UTF-16.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The program outputs on my laptop:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ javac BenchmarkString
$ java BenchmarkString
(Latin1) Execution time: 896ms
(Latin1) Memory usage: 61MB
(UTF-16) Execution time: 3162ms
(UTF-16) Memory usage: 185MB</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we look more closely at the UTF-16 case, we notice that the internal representation is not without consequence. Consider the following program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RepresentationUTF16</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">‚úãHey</span><span class="delimiter">&quot;</span></span>.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">H</span><span class="delimiter">&quot;</span></span>)); <span class="comment">// Output: 1</span>
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ü§öHey</span><span class="delimiter">&quot;</span></span>.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">H</span><span class="delimiter">&quot;</span></span>)); <span class="comment">// Output: 2</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Why does rotating the hand change the result? As discussed in the second part, UTF-16 is a variable-length character encoding. It means characters in the BMP are encoded using two bytes, whereas complementary characters are encoded using a surrogate pair (i.e., the equivalent of two codepoints). The two emojis look alike but are not stored in the same Unicode plane. ‚úã <code>RAISED HAND</code> is assigned the codepoint U+270B (Plane 0) and ü§ö <code>RAISED BACK OF HAND</code> is assigned the codepoint U+1F91A (Plane 1).</p>
</div>
<div class="paragraph">
<p>Using UTF-16 for the internal representation saves bytes compared to using UTF-32, but the abstraction is leaky as the developer is not working with a sequence of Unicode code points:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RepresentationUTF16</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">‚úãHey</span><span class="delimiter">&quot;</span></span>.codePointAt(<span class="integer">1</span>)); <span class="comment">// U+0048 Latin Capital Letter H</span>
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ü§öHey</span><span class="delimiter">&quot;</span></span>.codePointAt(<span class="integer">1</span>)); <span class="comment">// U+DD1A Low Surrogate Code</span>
        <span class="comment">// Or</span>
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">‚úãHey</span><span class="delimiter">&quot;</span></span>.charAt(<span class="integer">1</span>)); <span class="comment">// H</span>
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ü§öHey</span><span class="delimiter">&quot;</span></span>.charAt(<span class="integer">1</span>)); <span class="comment">// ?</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output makes sense when considering the internal representation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> s1 = <span class="keyword">new</span> <span class="predefined-type">String</span>(<span class="string"><span class="delimiter">&quot;</span><span class="char">\u270b</span><span class="char">\u0048</span><span class="char">\u0065</span><span class="char">\u0079</span><span class="delimiter">&quot;</span></span>.getBytes(<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-16</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-16</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">String</span> s2 = <span class="keyword">new</span> <span class="predefined-type">String</span>(<span class="string"><span class="delimiter">&quot;</span><span class="char">\uD83E</span><span class="char">\uDD1A</span><span class="char">\u0048</span><span class="char">\u0065</span><span class="char">\u0079</span><span class="delimiter">&quot;</span></span>.getBytes(<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-16</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-16</span><span class="delimiter">&quot;</span></span>);
<span class="string"><span class="delimiter">&quot;</span><span class="content">‚úãHey</span><span class="delimiter">&quot;</span></span>.equals(s1) <span class="comment">// true</span>
<span class="string"><span class="delimiter">&quot;</span><span class="content">ü§öHey</span><span class="delimiter">&quot;</span></span>.equals(s2) <span class="comment">// true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will continue the discussion of <code>String</code> in the next section when presenting their manipulation.</p>
</div>
</div>
<div class="sect3">
<h4 id="example_go">Example: Go</h4>
<div class="paragraph">
<p>Go encodes strings as <a href="https://blog.golang.org/strings">a read-only slice of bytes</a>. These bytes can be anything, even invalid Unicode code points. But as Go source code is always UTF-8, the slice of bytes for a string literal is also UTF-8 text.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go">s := <span class="string"><span class="delimiter">&quot;</span><span class="content">Hey ü§ö!</span><span class="delimiter">&quot;</span></span> <span class="comment">// String literal stored in a UTF-8 file</span>

fmt.Printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">len=%d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, <span class="predefined">len</span>(s))
<span class="comment">// Print characters</span>
<span class="keyword">for</span> i := <span class="integer">0</span>; i &lt; <span class="predefined">len</span>(s); i++ {
    fmt.Printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">%c </span><span class="delimiter">&quot;</span></span>, s[i])
}
fmt.Println(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
<span class="comment">// Print bytes</span>
<span class="keyword">for</span> i := <span class="integer">0</span>; i &lt; <span class="predefined">len</span>(s); i++ {
    fmt.Printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">%v </span><span class="delimiter">&quot;</span></span>, s[i])
}

<span class="comment">// Output:</span>
<span class="comment">// len=9</span>
<span class="comment">// H e y   √∞   !</span>
<span class="comment">// 72 101 121 32 240 159 164 154 33</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Iterating over strings using this syntax does not work so well. We get bytes, not characters. We observe that these bytes correspond to the UTF-8 encoding, and we also notice that the <code>len</code> function returns the number of bytes in this encoding. This representation is not practical if we are interested by the Unicode code points.</p>
</div>
<div class="paragraph">
<p>To solve this, Go introduces the data type <code>rune</code> (a synonym of code point that is defined as a <code>int32</code>). If we convert the string to a slice of <code>rune</code>, we get a different result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go">s := []<span class="predefined-type">rune</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hey ü§ö!</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>

fmt.Printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">len=%d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, <span class="predefined">len</span>(s))
<span class="comment">// Print the characters</span>
<span class="keyword">for</span> i := <span class="integer">0</span>; i &lt; <span class="predefined">len</span>(s); i++ {
    fmt.Printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">%c </span><span class="delimiter">&quot;</span></span>, s[i])
}
fmt.Println(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
<span class="comment">// Print the code points</span>
<span class="keyword">for</span> i := <span class="integer">0</span>; i &lt; <span class="predefined">len</span>(s); i++ {
    fmt.Printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">%#U </span><span class="delimiter">&quot;</span></span>, s[i])
}

<span class="comment">// Output:</span>
<span class="comment">// len=6</span>
<span class="comment">// H e y   ü§ö !</span>
<span class="comment">// U+0048 'H' U+0065 'e' U+0079 'y' U+0020 ' ' U+1F91A 'ü§ö' U+0021 '!'</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cast the string into a slice of <code>rune</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The output confirms that the string is composed of 6 Unicode code points. The same result can be obtained using a <code>for range</code> loop without having to cast the string explicitly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go">s := <span class="string"><span class="delimiter">&quot;</span><span class="content">Hey ü§ö!</span><span class="delimiter">&quot;</span></span>

<span class="keyword">for</span> index, runeValue := <span class="keyword">range</span> s {
    fmt.Printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">%#U starts at byte position %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, runeValue, index)
}

<span class="comment">// Output:</span>
<span class="comment">// U+0048 'H' starts at byte position 0</span>
<span class="comment">// U+0065 'e' starts at byte position 1</span>
<span class="comment">// U+0079 'y' starts at byte position 2</span>
<span class="comment">// U+0020 ' ' starts at byte position 3</span>
<span class="comment">// U+1F91A 'ü§ö' starts at byte position 4</span>
<span class="comment">// U+0021 '!' starts at byte position 8</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output shows how each code point occupies a different number of bytes. For example, the emoji uses 4 bytes starting at the index 4.</p>
</div>
<div class="paragraph">
<p>Like Java, we can note that the Go internal string representation is not transparent for the developer. What about Python?</p>
</div>
</div>
<div class="sect3">
<h4 id="example_python">Example: Python</h4>
<div class="paragraph">
<p>Python supports, since the version 3.3, <a href="https://www.python.org/dev/peps/pep-0393/">multiple internal representations</a>, depending on the character with the largest Unicode code point (1, 2, or 4 bytes). The implementation saves space in most cases and gives access to the whole "UTF-32" if needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">print(<span class="predefined">len</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">‚úã</span><span class="delimiter">&quot;</span></span>)) <span class="comment"># 1</span>
print(<span class="predefined">len</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">ü§ö</span><span class="delimiter">&quot;</span></span>)) <span class="comment"># 1</span>

<span class="keyword">for</span> c <span class="keyword">in</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hey ü§ö!</span><span class="delimiter">&quot;</span></span>:
    print(c, <span class="predefined">hex</span>(<span class="predefined">ord</span>(c)))
    <span class="comment"># H 0x48</span>
    <span class="comment"># e 0x65</span>
    <span class="comment"># y 0x79</span>
    <span class="comment">#   0x20</span>
    <span class="comment"># ü§ö 0x1f91a</span>
    <span class="comment"># ! 0x21</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The idea behind the Python implementation is similar to the Java implementation, and we will omit the code consequently. However, we observe that the internal implementation is transparent for the Python developer. Strings are sequences of Unicode code points where the length is not affected by the encoding used internally.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-implementation-processing">Processing</h3>
<div class="paragraph">
<p>Programming languages offers many functions operating on strings. We will cover a few of them.</p>
</div>
<div class="sect3">
<h4 id="sect-implementation-processing-length"><code>length()</code></h4>
<div class="paragraph">
<p>Determining the length of a string can be challenging with Unicode. A possible implementation is simply to return the number of code points in the string, but the result can be surprising:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Python 3</span>
print(<span class="predefined">len</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">aÃÄ</span><span class="delimiter">&quot;</span></span>))
<span class="comment"># Output: 2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Why? The result is not as surprising as it may seem. We have mentioned that the Unicode Standard defines combining characters, like when defining accentuated letters. To understand the example, you need to remember that your editor (or browser) is rendering the text using glyphs, and thus have to manage these combining characters. The same example can be rewritten using the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Python 3</span>
print(<span class="predefined">len</span>(<span class="string"><span class="delimiter">&quot;</span><span class="char">\N{LATIN SMALL LETTER A}</span><span class="char">\N{COMBINING GRAVE ACCENT}</span><span class="delimiter">&quot;</span></span>))
<span class="comment"># Or &quot;\u0061\u0300&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Like most examples in this section, you can reproduce the same behavior in other languages like Java or Go. The fact is our Unicode text is really composed of two Unicode characters. The result may be considered correct or wrong depending on what you are looking for.</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-implementation-processing-equals"><code>equals()</code></h4>
<div class="paragraph">
<p>Comparing if two strings are equals is not without surprise neither.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go"><span class="comment">// Golang</span>
<span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">fmt</span><span class="delimiter">&quot;</span></span>

<span class="keyword">func</span> main() {
    fmt.Println(<span class="string"><span class="delimiter">&quot;</span><span class="content">√†</span><span class="delimiter">&quot;</span></span> == <span class="string"><span class="delimiter">&quot;</span><span class="content">aÃÄ</span><span class="delimiter">&quot;</span></span>)
    <span class="comment">// Output: false</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Why? Convertibility is one of the core design principles behind Unicode. Converting between Unicode and any other encoding must be as easy as possible, which means if a character exists in an encoding, it must also exist in Unicode to have a simple one-to-one mapping between the two encodings. So, even if Unicode favors combining characters to represent accentuated letters, prior encodings often include a single character for letters such as <code>√†</code>. The same example can be rewritten using the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go"><span class="comment">// Golang</span>
<span class="keyword">package</span> main

<span class="keyword">import</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">fmt</span><span class="delimiter">&quot;</span></span>

<span class="keyword">func</span> main() {
    fmt.Println(<span class="string"><span class="delimiter">&quot;</span><span class="char">\u00E0</span><span class="delimiter">&quot;</span></span> == <span class="string"><span class="delimiter">&quot;</span><span class="char">\u0061</span><span class="char">\u0300</span><span class="delimiter">&quot;</span></span>)
    <span class="comment">// Output: false</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>According to the Unicode standard, these two strings are canonically equivalent and should be treated as equal even if their sequences of bytes are different.</p>
</div>
<div class="paragraph">
<p>To solve this problem, Unicode defines different normalization algorithms to convert equivalent strings to the same normal form. These algorithms are implemented by programming languages but are rarely applied systematically (normalization isn&#8217;t free). Java, Python, and <a href="https://blog.golang.org/normalization">Go</a> all provide such functions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go"><span class="keyword">package</span> main

<span class="keyword">import</span> (
    <span class="string"><span class="delimiter">&quot;</span><span class="content">fmt</span><span class="delimiter">&quot;</span></span>

    <span class="string"><span class="delimiter">&quot;</span><span class="content">golang.org/x/text/unicode/norm</span><span class="delimiter">&quot;</span></span>
)

<span class="keyword">func</span> main() {
    norm1 := norm.NFD.String(<span class="string"><span class="delimiter">&quot;</span><span class="char">\u00E0</span><span class="delimiter">&quot;</span></span>)
    norm2 := norm.NFD.String(<span class="string"><span class="delimiter">&quot;</span><span class="char">\u0061</span><span class="char">\u0300</span><span class="delimiter">&quot;</span></span>)
    fmt.Println(norm1 == norm2)
    <span class="comment">// Output: true</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In practice, normalization is not always required, and it is crucial to understand why it exists and when to apply it, like when receiving a Unicode text from an external program.</p>
</div>
<div class="paragraph">
<p>Normalization also occurs when you are not expecting it. Consider the following program in Python:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Python 3</span>
‚Ñå = <span class="string"><span class="delimiter">&quot;</span><span class="content">Me</span><span class="delimiter">&quot;</span></span>
H = <span class="string"><span class="delimiter">&quot;</span><span class="content">Funny</span><span class="delimiter">&quot;</span></span>
print(‚Ñå == H)
<span class="comment"># Output: True</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Why? <a href="https://www.python.org/dev/peps/pep-3131/">Python accepts non-ASCII characters in identifiers</a> but all identifiers are passed to a function to normalize their name first. In this example, the character <code>‚Ñå</code> has the same normal form as the character <code>H</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Python 3</span>
<span class="keyword">import</span> <span class="include">unicodedata</span>
print(unicodedata.normalize(<span class="string"><span class="delimiter">'</span><span class="content">NFKC</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">‚Ñå</span><span class="delimiter">&quot;</span></span>))
<span class="comment"># Output: &quot;H&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-implementation-processing-case">Example: <code>upper()</code></h4>
<div class="paragraph">
<p>A function like <code>upper()</code> in Python is often used to make case-insensitive comparisons. But not all scripts use cases, and there aren&#8217;t just two cases (ex: titlecase is used for book titles).</p>
</div>
<div class="paragraph">
<p><em>Case folding</em> is defined by the Unicode Standard as a solution for caseless comparison of text to overcome these limitations, but Unicode also provides support to implement these classic functions using the <em>Unicode Character Database</em>‚Äîthe set of data files containing character properties. In particular, we are looking for the property <code>Simple_Lowercase_Mapping</code> defined in the file <code>UnicodeData.txt</code>.</p>
</div>
<div class="listingblock">
<div class="title">UnicodeData.txt</div>
<div class="content">
<pre class="CodeRay highlight"><code>0041;LATIN CAPITAL LETTER A;Lu;0;L;;;;;N;;;;0061;
...
0061;LATIN SMALL LETTER A;Ll;0;L;;;;;N;;;0041;;0041</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last three columns of the file are the properties <code>Simple_Uppercase_Mapping</code>, <code>Simple_Lowercase_Mapping</code>, and <code>Simple_Titlecase_Mapping</code>.</p>
</div>
<div class="paragraph">
<p>Using this file, it is easy to implement a method to convert a string to uppercase:</p>
</div>
<div class="listingblock">
<div class="title">String.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">String</span>:

    UnicodeData = {}

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, codepoints=[]):
        <span class="predefined-constant">self</span>.codepoints = codepoints

    <span class="keyword">def</span> <span class="function">__len__</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined">len</span>(<span class="predefined-constant">self</span>.codepoints)

    <span class="keyword">def</span> <span class="function">__getitem__</span>(<span class="predefined-constant">self</span>, index):
        <span class="keyword">if</span> index &lt; <span class="predefined">len</span>(<span class="predefined-constant">self</span>.codepoints):
            <span class="keyword">return</span> <span class="predefined-constant">self</span>.codepoints[index]

    <span class="keyword">def</span> <span class="function">upper</span>(<span class="predefined-constant">self</span>):
        res = []
        <span class="keyword">for</span> cl <span class="keyword">in</span> <span class="predefined-constant">self</span>.codepoints:
            cu = String.UnicodeData[cl].get(<span class="string"><span class="delimiter">&quot;</span><span class="content">Simple_Uppercase_Mapping</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">None</span>)
            <span class="keyword">if</span> cu:
                res.append(<span class="predefined">int</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">0x</span><span class="delimiter">&quot;</span></span> + cu, <span class="integer">0</span>))
            <span class="keyword">else</span>:
                res.append(cl)
        <span class="keyword">return</span> String(res)

<span class="keyword">def</span> <span class="function">loadUCD</span>():
    ucd = {}
    <span class="keyword">with</span> <span class="predefined">open</span>(<span class="string"><span class="delimiter">'</span><span class="content">./UnicodeData.txt</span><span class="delimiter">'</span></span>) <span class="keyword">as</span> fp:
        <span class="keyword">for</span> line <span class="keyword">in</span> fp:
            (codepoint, *_, upper, lower, title) = line.split(<span class="string"><span class="delimiter">&quot;</span><span class="content">;</span><span class="delimiter">&quot;</span></span>)
            ucd[<span class="predefined">int</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">0x</span><span class="delimiter">&quot;</span></span> + codepoint, <span class="integer">0</span>)] = {
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Simple_Uppercase_Mapping</span><span class="delimiter">&quot;</span></span>: upper,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Simple_Lowercase_Mapping</span><span class="delimiter">&quot;</span></span>: lower,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Simple_Titlecase_Mapping</span><span class="delimiter">&quot;</span></span>: title,
            }
    String.UnicodeData = ucd

loadUCD()

s = String([<span class="hex">0x0068</span>, <span class="hex">0x0065</span>, <span class="hex">0x0079</span>, <span class="hex">0x1F600</span>]) <span class="comment"># &quot;heyüòÄ&quot;</span>

print(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>.join(<span class="predefined">map</span>(<span class="predefined">chr</span>, s.upper()))) <span class="comment"># Convert bytes to string</span>
<span class="comment"># Output: HEYüòÄ</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation in popular programming languages follows the same logic with optimizations concerning the loading of the Unicode Character Database.</p>
</div>
<div class="sect4">
<h5 id="example_python_2">Example: Python</h5>
<div class="paragraph">
<p>The string type is implemented in C in the file <a href="https://github.com/python/cpython/blob/v3.9.5/Objects/unicodeobject.c"><code>unicodeobject.c</code></a>. Here is the method to test if a character is uppercase:</p>
</div>
<div class="listingblock">
<div class="title">Objects/unicodectype.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span class="keyword">typedef</span> <span class="keyword">struct</span> {
    <span class="comment">/*
       These are either deltas to the character or offsets in
       _PyUnicode_ExtendedCase.
    */</span>
    <span class="directive">const</span> <span class="predefined-type">int</span> upper;
    <span class="directive">const</span> <span class="predefined-type">int</span> lower;
    <span class="directive">const</span> <span class="predefined-type">int</span> title;
    <span class="comment">/* Note if more flag space is needed, decimal and digit could be unified. */</span>
    <span class="directive">const</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">char</span> decimal;
    <span class="directive">const</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">char</span> digit;
    <span class="directive">const</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">short</span> flags;
} _PyUnicode_TypeRecord;

...

<span class="comment">/* Returns 1 for Unicode characters having the category 'Lu', 0
   otherwise. */</span>

<span class="predefined-type">int</span> _PyUnicode_IsUppercase(Py_UCS4 ch)
{
    <span class="directive">const</span> _PyUnicode_TypeRecord *ctype = gettyperecord(ch);

    <span class="keyword">return</span> (ctype-&gt;flags &amp; UPPER_MASK) != <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code relies on a global structure initialized using the Unicode Character Database. The script <code>Tools/unicode/makeunicodedata.py</code> converts Unicode database files (e.g., <code>UnicodeData.txt</code>) to <code>Modules/unicodedata_db.h</code>,
<code>Modules/unicodename_db.h</code>, and <code>Objects/unicodetype_db.h</code>.</p>
</div>
<div class="listingblock">
<div class="title">Tools/unicode/makeunicodedata.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">makeunicodetype</span>(<span class="predefined">unicode</span>, trace): <i class="conum" data-value="1"></i><b>(1)</b>
    ...

    <span class="keyword">for</span> char <span class="keyword">in</span> <span class="predefined">unicode</span>.chars: <i class="conum" data-value="2"></i><b>(2)</b>
        record = <span class="predefined">unicode</span>.table[char]
        <span class="comment"># extract database properties</span>
        category = record.general_category
        bidirectional = record.bidi_class
        properties = record.binary_properties
        flags = <span class="integer">0</span>
        <span class="keyword">if</span> category <span class="keyword">in</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">Lm</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Lt</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Lu</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Ll</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Lo</span><span class="delimiter">&quot;</span></span>]:
            flags |= ALPHA_MASK
        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Lowercase</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> properties:
            flags |= LOWER_MASK
        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Uppercase</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> properties:
            flags |= UPPER_MASK
        ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The method <code>makeunicodetype</code> generates the file <code>Objects/unicodetype_db.h</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The variable <code>unicode</code> contains the content of <code>UnicodeData.txt</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I invite you to check the generated files like <a href="https://github.com/python/cpython/blob/v3.9.5/Objects/unicodetype_db.h"><code>Objects/unicodetype_db.h</code></a>. These files are not a simple list of all Unicode characters but use additional optimizations. We can ignore these low-level details for the purpose of this article.</p>
</div>
</div>
<div class="sect4">
<h5 id="example_java_2">Example: Java</h5>
<div class="paragraph">
<p>Java implements the string data type in the class <a href="https://github.com/openjdk/jdk/blob/jdk-16+36/src/java.base/share/classes/java/lang/String.java"><code>java.lang.String</code></a>. The code is large due to several evolutions like compact strings.</p>
</div>
<div class="paragraph">
<p>Here is the code of the method <code>toUpperCase()</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/java.base/share/classes/java/lang/String.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">java.lang</span>;

<span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">String</span>
    <span class="directive">implements</span> java.io.Serializable, <span class="predefined-type">Comparable</span>&lt;<span class="predefined-type">String</span>&gt;, <span class="predefined-type">CharSequence</span>,
               Constable, ConstantDesc {

    <span class="comment">/**
     * Converts all of the characters in this {@code String} to upper
     * case using the rules of the given {@code Locale}. Case mapping is based
     * on the Unicode Standard version specified by the
     * {@link java.lang.Character Character} class.
     *
     * @param locale use the case transformation rules for this locale
     * @return the {@code String}, converted to uppercase.
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toUpperCase(<span class="predefined-type">Locale</span> locale) {
        <span class="keyword">return</span> isLatin1() ? StringLatin1.toUpperCase(<span class="local-variable">this</span>, value, locale)
                          : StringUTF16.toUpperCase(<span class="local-variable">this</span>, value, locale);
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to check the class <a href="https://github.com/openjdk/jdk/blob/jdk-16+36/src/java.base/share/classes/java/lang/Character.java"><code>java.lang.Character</code></a> to find out more about the conversion:</p>
</div>
<div class="listingblock">
<div class="title">src/java.base/share/classes/java/lang/Character.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">java.lang</span>;

<span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">Character</span> {

    <span class="comment">/**
     * Converts the character (Unicode code point) argument to
     * uppercase using case mapping information from the UnicodeData
     * file.
     *
     * @param   codePoint   the character (Unicode code point) to be converted.
     * @return  the uppercase equivalent of the character, if any;
     *          otherwise, the character itself.
     */</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">int</span> toUpperCase(<span class="type">int</span> codePoint) {
        <span class="keyword">return</span> CharacterData.of(codePoint).toUpperCase(codePoint);
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/openjdk/jdk/blob/jdk-16%2B36/src/java.base/share/classes/java/lang/CharacterData.java"><code>java.lang.CharacterData</code></a> is an abstract class:</p>
</div>
<div class="listingblock">
<div class="title">src/java.base/share/classes/java/lang/CharacterData.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">java.lang</span>;

<span class="directive">abstract</span> <span class="type">class</span> <span class="class">CharacterData</span> {

    <span class="directive">abstract</span> <span class="type">boolean</span> isUpperCase(<span class="type">int</span> ch);
    <span class="directive">abstract</span> <span class="type">int</span> toUpperCase(<span class="type">int</span> ch);
    <span class="comment">// ...</span>

    <span class="directive">static</span> <span class="directive">final</span> CharacterData of(<span class="type">int</span> ch) {
        <span class="keyword">if</span> (ch &gt;&gt;&gt; <span class="integer">8</span> == <span class="integer">0</span>) {     <span class="comment">// fast-path </span><i class="conum" data-value="1"></i><b>(1)</b>
            <span class="keyword">return</span> CharacterDataLatin1.instance;
        } <span class="keyword">else</span> {
            <span class="keyword">switch</span>(ch &gt;&gt;&gt; <span class="integer">16</span>) {  <span class="comment">//plane 00-16</span>
            <span class="keyword">case</span>(<span class="integer">0</span>):
                <span class="keyword">return</span> CharacterData00.instance;
            <span class="keyword">case</span>(<span class="integer">1</span>):
                <span class="keyword">return</span> CharacterData01.instance;
            <span class="keyword">case</span>(<span class="integer">2</span>):
                <span class="keyword">return</span> CharacterData02.instance;
            <span class="keyword">case</span>(<span class="integer">3</span>):
                <span class="keyword">return</span> CharacterData03.instance;
            <span class="keyword">case</span>(<span class="integer">14</span>):
                <span class="keyword">return</span> CharacterData0E.instance;
            <span class="keyword">case</span>(<span class="integer">15</span>):   <span class="comment">// Private Use</span>
            <span class="keyword">case</span>(<span class="integer">16</span>):   <span class="comment">// Private Use</span>
                <span class="keyword">return</span> CharacterDataPrivateUse.instance;
            <span class="keyword">default</span>:
                <span class="keyword">return</span> CharacterDataUndefined.instance;
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The fast-path is an optimization for ASCII characters to avoid traversing the larger Unicode database.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The classes <code>CharacterDataXX</code> contain the properties for each plane of the Unicode Character Table and are generated by the Java build process. The definition is present in <code>make/modules/java.base/gensrc/GensrcCharacterData.gmk</code>:</p>
</div>
<div class="listingblock">
<div class="title">make/modules/java.base/gensrc/GensrcCharacterData.gmk</div>
<div class="content">
<pre class="CodeRay highlight"><code>#
# Rules to create $(SUPPORT_OUTPUTDIR)/gensrc/java.base/sun/lang/CharacterData*.java
#

GENSRC_CHARACTERDATA :=

CHARACTERDATA = $(TOPDIR)/make/data/characterdata
UNICODEDATA = $(TOPDIR)/make/data/unicodedata

define SetupCharacterData
  $(SUPPORT_OUTPUTDIR)/gensrc/java.base/java/lang/$1.java: \
      $(CHARACTERDATA)/$1.java.template
    $$(call LogInfo, Generating $1.java)
    $$(call MakeDir, $$(@D))
    $(TOOL_GENERATECHARACTER) $2 $(DEBUG_OPTION) \
        -template $(CHARACTERDATA)/$1.java.template \
        -spec $(UNICODEDATA)/UnicodeData.txt \ <i class="conum" data-value="1"></i><b>(1)</b>
        -specialcasing $(UNICODEDATA)/SpecialCasing.txt \ <i class="conum" data-value="1"></i><b>(1)</b>
        -proplist $(UNICODEDATA)/PropList.txt \ <i class="conum" data-value="1"></i><b>(1)</b>
        -derivedprops $(UNICODEDATA)/DerivedCoreProperties.txt \ <i class="conum" data-value="1"></i><b>(1)</b>
        -o $(SUPPORT_OUTPUTDIR)/gensrc/java.base/java/lang/$1.java \
        -usecharforbyte $3

  GENSRC_CHARACTERDATA += $(SUPPORT_OUTPUTDIR)/gensrc/java.base/java/lang/$1.java
endef

$(eval $(call SetupCharacterData,CharacterDataLatin1, , -latin1 8))
$(eval $(call SetupCharacterData,CharacterData00, -string -plane 0, 11 4 1))
$(eval $(call SetupCharacterData,CharacterData01, -string -plane 1, 11 4 1))
$(eval $(call SetupCharacterData,CharacterData02, -string -plane 2, 11 4 1))
$(eval $(call SetupCharacterData,CharacterData03, -string -plane 3, 11 4 1))
$(eval $(call SetupCharacterData,CharacterData0E, -string -plane 14, 11 4 1))

$(GENSRC_CHARACTERDATA): $(BUILD_TOOLS_JDK)

TARGETS += $(GENSRC_CHARACTERDATA)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The input files correspond to the UCD files we talked about in the section about the Unicode Character Database.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a preview of the resulting code:</p>
</div>
<div class="listingblock">
<div class="title">/gensrc/java.base/java/lang/CharacterData00.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">java.lang</span>;

<span class="type">class</span> <span class="class">CharacterData00</span> <span class="directive">extends</span> CharacterData {

    <span class="type">int</span> toUpperCase(<span class="type">int</span> ch) {
        <span class="type">int</span> mapChar = ch;
        <span class="type">int</span> val = getProperties(ch);

        <span class="keyword">if</span> ((val &amp; <span class="hex">0x00010000</span>) != <span class="integer">0</span>) {
            <span class="keyword">if</span> ((val &amp; <span class="hex">0x07FC0000</span>) == <span class="hex">0x07FC0000</span>) {
                <span class="keyword">switch</span>(ch) {
                <span class="keyword">case</span> <span class="hex">0x00B5</span> : mapChar = <span class="hex">0x039C</span>; <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="hex">0x017F</span> : mapChar = <span class="hex">0x0053</span>; <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="hex">0x1FBE</span> : mapChar = <span class="hex">0x0399</span>; <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="hex">0x1F80</span> : mapChar = <span class="hex">0x1F88</span>; <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="hex">0x1F81</span> : mapChar = <span class="hex">0x1F89</span>; <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="hex">0x1F82</span> : mapChar = <span class="hex">0x1F8A</span>; <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="hex">0x1F83</span> : mapChar = <span class="hex">0x1F8B</span>; <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="hex">0x1F84</span> : mapChar = <span class="hex">0x1F8C</span>; <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="hex">0x1F85</span> : mapChar = <span class="hex">0x1F8D</span>; <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="hex">0x1F86</span> : mapChar = <span class="hex">0x1F8E</span>; <span class="keyword">break</span>;
                <span class="comment">// Many more</span>
            }
        }
        <span class="keyword">else</span> {
            <span class="type">int</span> offset = val  &lt;&lt; <span class="integer">5</span> &gt;&gt; (<span class="integer">5</span>+<span class="integer">18</span>);
            mapChar =  ch - offset;
        }

        <span class="keyword">return</span> mapChar;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Like Python, we observe various optimizations but the overall idea is similar&#8212;&#8203;we generate static code from the Unicode data files. In Java, accessing the properties of a character is more obvious thanks to <code>switch</code> statements using code points, whereas in Python, we have to manipulate bytes to determine the index of the code point first.</p>
</div>
</div>
<div class="sect4">
<h5 id="example_go_2">Example: Go</h5>
<div class="paragraph">
<p>The Go implementation is really close to previous languages. Go strings are implemented in Go by the file <a href="https://github.com/golang/go/blob/go1.16.5/src/strings/strings.go"><code>src/strings/strings.go</code></a>, which declares the function <code>ToUpper()</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/strings/strings.go</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go"><span class="comment">// ToUpper returns s with all Unicode letters mapped to their upper case.</span>
<span class="keyword">func</span> ToUpper(s <span class="predefined-type">string</span>) <span class="predefined-type">string</span> {
    isASCII, hasLower := <span class="predefined-constant">true</span>, <span class="predefined-constant">false</span>
    <span class="keyword">for</span> i := <span class="integer">0</span>; i &lt; <span class="predefined">len</span>(s); i++ {
        c := s[i]
        <span class="keyword">if</span> c &gt;= utf8.RuneSelf { <i class="conum" data-value="1"></i><b>(1)</b>
            isASCII = <span class="predefined-constant">false</span>
            <span class="keyword">break</span>
        }
        hasLower = hasLower || (<span class="char">'a'</span> &lt;= c &amp;&amp; c &lt;= <span class="char">'z'</span>)
    }

    <span class="keyword">if</span> isASCII { <span class="comment">// optimize for ASCII-only strings.</span>
        <span class="keyword">if</span> !hasLower {
            <span class="keyword">return</span> s
        }
        <span class="keyword">var</span> b Builder
        b.Grow(<span class="predefined">len</span>(s))
        <span class="keyword">for</span> i := <span class="integer">0</span>; i &lt; <span class="predefined">len</span>(s); i++ {
            c := s[i]
            <span class="keyword">if</span> <span class="char">'a'</span> &lt;= c &amp;&amp; c &lt;= <span class="char">'z'</span> {
                c -= <span class="char">'a'</span> - <span class="char">'A'</span> <i class="conum" data-value="2"></i><b>(2)</b>
            }
            b.WriteByte(c)
        }
        <span class="keyword">return</span> b.String()
    }
    <span class="keyword">return</span> Map(unicode.ToUpper, s) <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>RuneSelf</code> is a constant with the value <code>0x80</code> (128) to determine if the code point is an ASCII-compatible character.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Before Unicode, converting a string in uppercase was easily implemented by substracting the differences between the index <code>a</code> and <code>A</code> since characters were ordered in the character set.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The real implementation is defined by the <code>unicode</code> package.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Unicode Character Database (e.g., <code>UnicodeData.txt</code>) is <a href="https://github.com/golang/text/blob/v0.3.6/unicode/rangetable/gen.go">converted</a> to static code in the file <a href="https://github.com/golang/go/blob/2ebe77a2fda1ee9ff6fd9a3e08933ad1ebaea039/src/unicode/tables.go"><code>src/unicode/tables.go</code></a>. Go implements various optimizations using different structures. For example, instead of storing the mapping between every single uppercase and lowercase letter, Go groups them in instances of <code>CaseRange</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/unicode/letter.go</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go"><span class="comment">// Indices into the Delta arrays inside CaseRanges for case mapping.</span>
<span class="keyword">const</span> (
    UpperCase = <span class="predefined-constant">iota</span>
    LowerCase
    TitleCase
    MaxCase
)

<span class="keyword">type</span> d [MaxCase]<span class="predefined-type">rune</span> <span class="comment">// to make the CaseRanges text shorter</span>

<span class="comment">// CaseRange represents a range of Unicode code points for simple (one</span>
<span class="comment">// code point to one code point) case conversion.</span>
<span class="comment">// The range runs from Lo to Hi inclusive, with a fixed stride of 1. Deltas</span>
<span class="comment">// are the number to add to the code point to reach the code point for a</span>
<span class="comment">// different case for that character. They may be negative. If zero, it</span>
<span class="comment">// means the character is in the corresponding case. There is a special</span>
<span class="comment">// case representing sequences of alternating corresponding Upper and Lower</span>
<span class="comment">// pairs. It appears with a fixed Delta of</span>
<span class="comment">//  {UpperLower, UpperLower, UpperLower}</span>
<span class="comment">// The constant UpperLower has an otherwise impossible delta value.</span>
<span class="keyword">type</span> CaseRange <span class="keyword">struct</span> {
    Lo    <span class="predefined-type">uint32</span>
    Hi    <span class="predefined-type">uint32</span>
    Delta d
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="title">src/unicode/tables.go</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go"><span class="keyword">var</span> _CaseRanges = []CaseRange{
    {<span class="hex">0x0041</span>, <span class="hex">0x005A</span>, d{<span class="integer">0</span>, <span class="integer">32</span>, <span class="integer">0</span>}},    <i class="conum" data-value="1"></i><b>(1)</b>
    {<span class="hex">0x0061</span>, <span class="hex">0x007A</span>, d{<span class="integer">-32</span>, <span class="integer">0</span>, <span class="integer">-32</span>}}, <i class="conum" data-value="2"></i><b>(2)</b>
    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For Unicode characters in the range <code>A</code>‚Äî<code>Z</code>, add 32 to the code point to get the uppercase character.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For Unicode characters in the range <code>a</code>‚Äî<code>z</code>, subtract 32 to the code point to get the lowercase or titlecase character.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This variable is then used by the function <code>to</code>, which is called by higher-level functions such as <code>ToUpper</code>, <code>ToLower</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/unicode/letter.go</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="go"><span class="comment">// to maps the rune using the specified case mapping.</span>
<span class="comment">// It additionally reports whether caseRange contained a mapping for r.</span>
<span class="keyword">func</span> to(_case <span class="predefined-type">int</span>, r <span class="predefined-type">rune</span>, caseRange []CaseRange) (mappedRune <span class="predefined-type">rune</span>, foundMapping <span class="predefined-type">bool</span>) { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">if</span> _case &lt; <span class="integer">0</span> || MaxCase &lt;= _case {
        <span class="keyword">return</span> ReplacementChar, <span class="predefined-constant">false</span> <span class="comment">// as reasonable an error as any</span>
    }
    <span class="comment">// binary search over ranges</span>
    lo := <span class="integer">0</span>
    hi := <span class="predefined">len</span>(caseRange)
    <span class="keyword">for</span> lo &lt; hi { <i class="conum" data-value="2"></i><b>(2)</b>
        m := lo + (hi-lo)/<span class="integer">2</span>
        cr := caseRange[m]
        <span class="keyword">if</span> <span class="predefined-type">rune</span>(cr.Lo) &lt;= r &amp;&amp; r &lt;= <span class="predefined-type">rune</span>(cr.Hi) {
            delta := cr.Delta[_case]
            <span class="keyword">if</span> delta &gt; MaxRune {
                <span class="comment">// In an Upper-Lower sequence, which always starts with</span>
                <span class="comment">// an UpperCase letter, the real deltas always look like:</span>
                <span class="comment">//  {0, 1, 0}    UpperCase (Lower is next)</span>
                <span class="comment">//  {-1, 0, -1}  LowerCase (Upper, Title are previous)</span>
                <span class="comment">// The characters at even offsets from the beginning of the</span>
                <span class="comment">// sequence are upper case; the ones at odd offsets are lower.</span>
                <span class="comment">// The correct mapping can be done by clearing or setting the low</span>
                <span class="comment">// bit in the sequence offset.</span>
                <span class="comment">// The constants UpperCase and TitleCase are even while LowerCase</span>
                <span class="comment">// is odd so we take the low bit from _case.</span>
                <span class="keyword">return</span> <span class="predefined-type">rune</span>(cr.Lo) + ((r-<span class="predefined-type">rune</span>(cr.Lo))&amp;^<span class="integer">1</span> | <span class="predefined-type">rune</span>(_case&amp;<span class="integer">1</span>)), <span class="predefined-constant">true</span>
            }
            <span class="keyword">return</span> r + delta, <span class="predefined-constant">true</span> <i class="conum" data-value="3"></i><b>(3)</b>
        }
        <span class="keyword">if</span> r &lt; <span class="predefined-type">rune</span>(cr.Lo) { <i class="conum" data-value="2"></i><b>(2)</b>
            hi = m
        } <span class="keyword">else</span> {
            lo = m + <span class="integer">1</span>
        }
    }
    <span class="keyword">return</span> r, <span class="predefined-constant">false</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The function is called with a constant <code>UpperCase</code> or <code>LowerCase</code> as the first argument and a single character to convert.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Go uses binary search to locate the Unicode range in O(log N).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Once the range is found, simply add the delta to the code point.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-implementation-processing-regex"><code>matches()</code></h4>
<div class="paragraph">
<p>We will close the string manipulation section with a classic example: regular expressions.</p>
</div>
<div class="paragraph">
<p>Consider the following example in Python 3:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Python 3</span>
<span class="keyword">import</span> <span class="include">re</span>

s = <span class="string"><span class="delimiter">&quot;</span><span class="content">100 ¬µAh 10 mAh</span><span class="delimiter">&quot;</span></span>
res = re.findall(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">\\</span><span class="content">d+ </span><span class="content">\\</span><span class="content">wAh</span><span class="delimiter">'</span></span>, s)
print(<span class="predefined">len</span>(res))
<span class="comment"># Output: 1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, consider the same program with a small difference (we declare the regular expression using a <code>str</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Python 3</span>
<span class="keyword">import</span> <span class="include">re</span>
s = <span class="string"><span class="delimiter">&quot;</span><span class="content">100 ¬µAh 10 mAh</span><span class="delimiter">&quot;</span></span>
res = re.findall(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">d+ </span><span class="char">\\</span><span class="content">wAh</span><span class="delimiter">&quot;</span></span>, s)
print(<span class="predefined">len</span>(res))
<span class="comment"># Output: 2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Why? The reason is specific to the Python regex engine implementation. If the regex pattern is in bytes (e.g., when using <code>r'\\w'</code>),<code>\w</code> matches any alphanumeric character (<code>[a-zA-Z0-9_]</code>). If the regex pattern is a string (e.g., when using <code>"\\w"</code>), <code>\w</code> matches all characters marked as letters in the Unicode database.</p>
</div>
<div class="paragraph">
<p>In practice, most languages are subject to this restriction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.text.Normalizer</span>;
<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.regex.Matcher</span>;
<span class="keyword">import</span> <span class="include">java.util.regex.Pattern</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">StringTest</span> {

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        <span class="predefined-type">String</span> s = <span class="string"><span class="delimiter">&quot;</span><span class="content">100 ¬µAh 10 mAh</span><span class="delimiter">&quot;</span></span>;
        <span class="predefined-type">Pattern</span> p = <span class="predefined-type">Pattern</span>.compile(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">d+ </span><span class="char">\\</span><span class="content">wAh</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">Matcher</span> m = p.matcher(s);
        <span class="predefined-type">System</span>.out.println(m.results().count());
        <span class="comment">// Output: 1</span>

        <span class="comment">// Using a special character class</span>
        p = <span class="predefined-type">Pattern</span>.compile(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">d+ </span><span class="char">\\</span><span class="content">p{L}Ah</span><span class="delimiter">&quot;</span></span>);
        m = p.matcher(s);
        <span class="predefined-type">System</span>.out.print(m.results().count());
        <span class="comment">// Output: 2</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Java, the metacharacter <code>\w</code> also matches <code>[a-zA-Z_0-9]</code> (which is faster than checking the Unicode Character Database). Other character classes exist like <code>\p{L}</code>. (<code>L</code> matches a single code point in the category "letter", but other values are possible: <code>N</code> for any kind of numeric character in any script, etc.) This syntax is also supported by Go.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Emojis in identifiers?</div>
<div class="paragraph">
<p>Most languages require source files to be encoded in Unicode, but that does not mean these languages accept any Unicode character in variable names. <a href="https://rosettacode.org/wiki/Unicode_variable_names">Rules differs among languages</a> but most languages like Java, <a href="https://www.python.org/dev/peps/pep-3131/">Python</a>, and <a href="https://golang.org/ref/spec#Identifiers">Go</a> accept only characters considered as letters or digits in the Unicode table (ex: „ÉÑ, Œî, œÄ).</p>
</div>
<div class="paragraph">
<p>Some languages do not have these restrictions. You can write <a href="https://twitter.com/t3xtm0de/status/600711130324008961">hieroglyphs in Hashell</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="haskell">ìÜ≤ :: (ìÖÇ -&gt; ìÉÄ) -&gt; [ìÖÇ] -&gt; [ìÉÄ]
ìÜ≤ ìÜë (ìáã:ìáå) = ìÜë ìáã : ìÜ≤ ìÜë ìáå
ìÜ≤ _ _ = []</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or write entire programs in PHP without using any ASCII character for identifiers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="php"><span class="inline-delimiter">&lt;?php</span>

<span class="keyword">class</span> <span class="class">üòÄ</span> {
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">üçΩ</span>(...<span class="local-variable">$ü•™</span>) {
        <span class="local-variable">$üìú</span> = [
            <span class="string"><span class="delimiter">'</span><span class="content">ü•ù</span><span class="delimiter">'</span></span> =&gt; <span class="integer">61</span>,
            <span class="string"><span class="delimiter">'</span><span class="content">üç´</span><span class="delimiter">'</span></span> =&gt; <span class="integer">546</span>,
            <span class="string"><span class="delimiter">'</span><span class="content">üç™</span><span class="delimiter">'</span></span> =&gt; <span class="integer">502</span>,
            <span class="string"><span class="delimiter">'</span><span class="content">üçî</span><span class="delimiter">'</span></span> =&gt; <span class="integer">515</span>,
            <span class="string"><span class="delimiter">'</span><span class="content">üçü</span><span class="delimiter">'</span></span> =&gt; <span class="integer">624</span>,
            <span class="string"><span class="delimiter">'</span><span class="content">üçè</span><span class="delimiter">'</span></span> =&gt; <span class="integer">52</span>,
            <span class="string"><span class="delimiter">'</span><span class="content">ü•ó</span><span class="delimiter">'</span></span> =&gt; <span class="integer">280</span>,
        ];

        <span class="local-variable">$‚àë</span> = <span class="integer">0</span>;
        <span class="keyword">foreach</span>(<span class="local-variable">$ü•™</span> <span class="keyword">as</span> <span class="local-variable">$üçû</span>) {
            <span class="local-variable">$‚àë</span> += <span class="local-variable">$üìú</span>[<span class="local-variable">$üçû</span>];
        }
        <span class="keyword">if</span> (<span class="local-variable">$‚àë</span> &lt; <span class="integer">1000</span>) {
            <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">üôÇ</span><span class="delimiter">'</span></span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="local-variable">$‚àë</span> &lt; <span class="integer">2000</span>) {
            <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">ü§¢</span><span class="delimiter">'</span></span>;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">ü§Æ</span><span class="delimiter">'</span></span>;
        }
    }
}

<span class="local-variable">$üôç‚Äç‚ôÄÔ∏è</span> = <span class="keyword">new</span> üòÄ();
<span class="local-variable">$üôç‚Äç‚ôÇÔ∏è</span> = <span class="keyword">new</span> üòÄ();
<span class="predefined">echo</span> <span class="local-variable">$üôç‚Äç‚ôÄÔ∏è</span>-&gt;üçΩ(<span class="string"><span class="delimiter">'</span><span class="content">ü•ù</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">üçè</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">ü•ó</span><span class="delimiter">'</span></span>);
<span class="predefined">echo</span> <span class="local-variable">$üôç‚Äç‚ôÇÔ∏è</span>-&gt;üçΩ(<span class="string"><span class="delimiter">'</span><span class="content">üç™</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">üçî</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">üçü</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">üç´</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-implementation-writing">Writing</h3>
<div class="paragraph">
<p>A program should usually output some texts, for example, when printing messages in the console or when sending documents to another program when calling a remote API.</p>
</div>
<div class="paragraph">
<p>What this means is we have to convert Unicode texts to bytes. We need to encode them using one of the Unicode encodings.</p>
</div>
<div class="paragraph">
<p>For example, when printing a hello message in the standard output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># output.py</span>
print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello üëã</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Python interpreter outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ python3 output.py | hexdump
0000000 48 65 6c 6c 6f 20 f0 9f 91 8b 0a <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The BOM is not included in the resulting representation. The emoji is the single character using four bytes (<code>f0 9f 91 8b</code>), which confirms the UTF-8 encoding.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Writing to the console is no different than writing to a file. The function <code>print</code> will send bytes to the file descriptor 1 ("stdout") using a specific encoding. The same rules that we covered before apply here too.</p>
</div>
<div class="paragraph">
<p>Here is a different version of the same code showing the logic explicitly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">os</span>

<span class="keyword">with</span> os.fdopen(<span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">wb</span><span class="delimiter">'</span></span>) <span class="keyword">as</span> stdout:
    stdout.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello üëã</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>.encode(<span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Writing texts to the console, a file, or a socket makes no difference concerning Unicode.</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-implementation-rendering">Rendering</h3>
<div class="paragraph">
<p>Until now, we still haven&#8217;t try to render Unicode text. Sooner or later, the text will have to be displayed on the screen of a computer device.</p>
</div>
<div class="paragraph">
<p><strong>Rendering a text means converting a Unicode sequence of code points into a sequence of glyphs</strong>. These glyphs are present in font files, which are often provided by your operating system.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/unicode-standard-figure-2-3.png" alt="unicode standard figure 2 3" width="550">
</div>
<div class="title">Figure 16. Unicode Character Code to Rendered Glyphs (From Unicode Standard, Figure 2.3)</div>
</div>
<div class="paragraph">
<p>Here are the fonts available under MacOS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ ls -1 /System/Library/Fonts/
Apple Braille Outline 6 Dot.ttf
Apple Braille Outline 8 Dot.ttf
Apple Braille Pinpoint 6 Dot.ttf
Apple Braille Pinpoint 8 Dot.ttf
Apple Braille.ttf
Apple Color Emoji.ttc
Apple Symbols.ttf
AppleSDGothicNeo.ttc
AquaKana.ttc
ArabicUIDisplay.ttc
ArabicUIText.ttc
ArialHB.ttc
Avenir Next Condensed.ttc
Avenir Next.ttc
Avenir.ttc
Courier.dfont
GeezaPro.ttc
Geneva.dfont
HelveLTMM
Helvetica.ttc
HelveticaNeue.ttc
HelveticaNeueDeskInterface.ttc
Hiragino Sans GB.ttc
Keyboard.ttf
Kohinoor.ttc
KohinoorBangla.ttc
KohinoorGujarati.ttc
KohinoorTelugu.ttc
LastResort.otf
LucidaGrande.ttc
MarkerFelt.ttc
Menlo.ttc
Monaco.dfont
MuktaMahee.ttc
NewYork.ttf
NewYorkItalic.ttf
Noteworthy.ttc
NotoNastaliq.ttc
NotoSansArmenian.ttc
NotoSansKannada.ttc
NotoSansMyanmar.ttc
NotoSansOriya.ttc
NotoSerifMyanmar.ttc
Optima.ttc
Palatino.ttc
PingFang.ttc
SFCompactDisplay.ttf
SFCompactRounded.ttf
SFCompactText.ttf
SFCompactTextItalic.ttf
SFNS.ttf
SFNSDisplayCondensed-Black.otf
SFNSDisplayCondensed-Bold.otf
SFNSDisplayCondensed-Heavy.otf
SFNSDisplayCondensed-Light.otf
SFNSDisplayCondensed-Medium.otf
SFNSDisplayCondensed-Regular.otf
SFNSDisplayCondensed-Semibold.otf
SFNSDisplayCondensed-Thin.otf
SFNSDisplayCondensed-Ultralight.otf
SFNSItalic.ttf
SFNSMono.ttf
SFNSMonoItalic.ttf
SFNSRounded.ttf
SFNSTextCondensed-Bold.otf
SFNSTextCondensed-Heavy.otf
SFNSTextCondensed-Light.otf
SFNSTextCondensed-Medium.otf
SFNSTextCondensed-Regular.otf
SFNSTextCondensed-Semibold.otf
STHeiti Light.ttc
STHeiti Medium.ttc
Supplemental
Symbol.ttf
Thonburi.ttc
Times.ttc
TimesLTMM
ZapfDingbats.ttf
„Éí„É©„Ç≠„Çô„Éé‰∏∏„Ç≥„Çô ProN W4.ttc
„Éí„É©„Ç≠„Çô„ÉéÊòéÊúù ProN.ttc
„Éí„É©„Ç≠„Çô„ÉéËßí„Ç≥„Çô„Ç∑„ÉÉ„ÇØ W0.ttc
„Éí„É©„Ç≠„Çô„ÉéËßí„Ç≥„Çô„Ç∑„ÉÉ„ÇØ W1.ttc
„Éí„É©„Ç≠„Çô„ÉéËßí„Ç≥„Çô„Ç∑„ÉÉ„ÇØ W2.ttc
„Éí„É©„Ç≠„Çô„ÉéËßí„Ç≥„Çô„Ç∑„ÉÉ„ÇØ W3.ttc
„Éí„É©„Ç≠„Çô„ÉéËßí„Ç≥„Çô„Ç∑„ÉÉ„ÇØ W4.ttc
„Éí„É©„Ç≠„Çô„ÉéËßí„Ç≥„Çô„Ç∑„ÉÉ„ÇØ W5.ttc
„Éí„É©„Ç≠„Çô„ÉéËßí„Ç≥„Çô„Ç∑„ÉÉ„ÇØ W6.ttc
„Éí„É©„Ç≠„Çô„ÉéËßí„Ç≥„Çô„Ç∑„ÉÉ„ÇØ W7.ttc
„Éí„É©„Ç≠„Çô„ÉéËßí„Ç≥„Çô„Ç∑„ÉÉ„ÇØ W8.ttc
„Éí„É©„Ç≠„Çô„ÉéËßí„Ç≥„Çô„Ç∑„ÉÉ„ÇØ W9.ttc</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fonts comes in different formats, like the OpenType format (<code>.otf</code>, <code>.otc</code>, <code>.ttf</code>, <code>.ttc</code>). A font is a collection of tables of glyphs. Here is a preview of the font <code>NotoSansArmenian.ttf</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/NotoSansArmenian.png" alt="NotoSansArmenian">
</div>
<div class="title">Figure 17. Examples of glyphs present in the font <em>Noto Sans Armenian</em> using FontGoggles.</div>
</div>
<div class="paragraph">
<p>Most fonts (if not all) do not contain glyphs for every Unicode character.<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup> For example, trying to display "Hello" using the same font found no glyphs and shows empty squares ‚òê:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/NotoSansArmenian-hello.png" alt="NotoSansArmenian hello">
</div>
<div class="title">Figure 18. The same font found no glyphs to display ASCII characters.</div>
</div>
<div class="paragraph">
<p>Applications use therefore a mechanism called <em>font fallback</em> during text rendering. If some characters in a string are not supported in a given font, several fonts are tried successively until finding a matching font. If no glyph can be found, a white square ‚òê will be displayed instead.</p>
</div>
<div class="paragraph">
<p>To illustrate this point, I created a basic HTML page printing a sample of characters from every script defined by Unicode. The page is rendered by Chrome like this (or <a href="https://codepen.io/julien-sobczak/pen/JjWmvVw">try it in your browser</a>):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/UnicodeScripts.png" alt="UnicodeScripts">
</div>
<div class="title">Figure 19. HTML page using characters from all Unicode scripts rendered in Chrome.</div>
</div>
<div class="paragraph">
<p>Using Chrome DevTools, we can easily find out which fonts were used to render characters on screen:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/UnicodeScripts-DevTools.png" alt="UnicodeScripts DevTools">
</div>
<div class="title">Figure 20. Demo HTML page displayed in Chrome using characters from all Unicode scripts.</div>
</div>
<div class="paragraph">
<p>If we inspect the Greek script:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/UnicodeScripts-Greek.png" alt="UnicodeScripts Greek">
</div>
<div class="title">Figure 21. The Greek character <code>Greek Capital Letter Pamphylian Digamma</code> \U0376 is displayed using the font <em>Athelas</em>.</div>
</div>
<div class="paragraph">
<p>In addition, CSS allows us to influence the order of fonts tried during the font fallback mechanism. For example, if we import the <a href="https://fonts.google.com/specimen/Oi">font "Oi"</a>, available from Google Fonts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;head&gt;</span>
...
    <span class="tag">&lt;link</span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">preconnect</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://fonts.gstatic.com</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;link</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://fonts.googleapis.com/css2?family=Oi</span><span class="content">&amp;</span><span class="content">display=swap</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...
<span class="tag">&lt;/head&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And add the CSS declaration <code>font-family: 'Oi', Serif;</code> in our stylesheet:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/UnicodeScripts-Greek-Oi.png" alt="UnicodeScripts Greek Oi">
</div>
<div class="title">Figure 22. The Chrome rendering engine favors the font <em>Oi</em> when glyphs exist, and fallbacks to other fonts otherwise.</div>
</div>
<div class="paragraph">
<p><strong>The challenge to render Unicode text is thus to convert a sequence of Unicode characters into a sequence of glyphs, using a list of available fonts</strong>. This process is called <em>text shaping</em>.</p>
</div>
<div class="paragraph">
<p>The logic is not simple. There is not always a 1-1 mapping between characters and glyphs. Unicode contains, for example, combining characters, emojis characters, and some emojis like flags are made by combining two abstract characters (ex: the US flag üá∫üá∏ is represented by the two characters <code>REGIONAL INDICATOR SYMBOL LETTER U</code> + <code>REGIONAL INDICATOR SYMBOL LETTER S</code>). Implementing these rules is the job of the shaping engine.</p>
</div>
<div class="paragraph">
<p>Not all programs have to implement this logic from scratch. The library <a href="https://www.freetype.org/">FreeType</a> is used by major systems (GNU/Linux, iOS, Android, Firefox, Ghostscript, etc.). This represents billions of devices!</p>
</div>
<div class="paragraph">
<p>Under the hood, this library depends on the shaping engine <a href="https://github.com/harfbuzz/harfbuzz">HarfBuzz</a>, which does a lot of the hard work. Both programs are written in C and are low-level code. Here is a simple program using FreeType to render a sequence of Unicode characters (the original code appears in this <a href="https://gist.github.com/jokertarot/7583938">StackOverflow thread</a>):</p>
</div>
<div class="listingblock">
<div class="title">clfontpng.cc</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="comment">// = Requirements: freetype 2.5, libpng, libicu, libz, libzip2</span>
<span class="comment">// = How to compile:</span>
<span class="comment">//  % export CXXFLAGS=`pkg-config --cflags freetype2 libpng`</span>
<span class="comment">//  % export LDFLAGS=`pkg-config --libs freetype2 libpng`</span>
<span class="comment">//  % clang++ -o clfontpng -static $(CXXFLAGS) clfontpng.cc $(LDFLAGS) \
//    -licuuc -lz -lbz2</span>
<span class="preprocessor">#include</span> <span class="include">&lt;cassert&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;cctype&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;iostream&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;memory&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;vector&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;string&gt;</span>

<span class="preprocessor">#include</span> <span class="include">&lt;stdio.h&gt;</span>

<span class="preprocessor">#include</span> <span class="include">&lt;unicode/umachine.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;unicode/utf.h&gt;</span>

<span class="preprocessor">#include</span> <span class="include">&lt;ft2build.h&gt;</span>
<span class="preprocessor">#include</span> FT_FREETYPE_H
<span class="preprocessor">#include</span> FT_TRUETYPE_TABLES_H

<span class="preprocessor">#define</span> PNG_SKIP_SETJMP_CHECK
<span class="preprocessor">#include</span> <span class="include">&lt;png.h&gt;</span>

<span class="keyword">namespace</span> {

<span class="directive">const</span> <span class="predefined-type">char</span>* kDefaultOutputFile = <span class="string"><span class="delimiter">&quot;</span><span class="content">out.png</span><span class="delimiter">&quot;</span></span>;
<span class="directive">const</span> <span class="predefined-type">int</span> kBytesPerPixel = <span class="integer">4</span>; <span class="comment">// RGBA</span>
<span class="directive">const</span> <span class="predefined-type">int</span> kDefaultPixelSize = <span class="integer">128</span>;
<span class="directive">const</span> <span class="predefined-type">int</span> kSpaceWidth = kDefaultPixelSize / <span class="integer">2</span>;

FT_Library gFtLibrary;

<span class="comment">// Only support horizontal direction.</span>
<span class="keyword">class</span> <span class="class">DrawContext</span> {
 <span class="directive">public</span>:
  DrawContext()
      : pos_(<span class="integer">0</span>), width_(<span class="integer">0</span>), height_(<span class="integer">0</span>) {}
  uint8_t* Bitmap() { <span class="keyword">return</span> &amp;bitmap_[<span class="integer">0</span>]; }
  <span class="directive">const</span> uint32_t Width() <span class="directive">const</span> { <span class="keyword">return</span> width_; }
  <span class="directive">const</span> uint32_t Height() <span class="directive">const</span> { <span class="keyword">return</span> height_; }
  <span class="directive">void</span> SetSize(<span class="predefined-type">int</span> width, <span class="predefined-type">int</span> height) {
    width_ = width;
    height_ = height;
    <span class="predefined-type">int</span> size = width * height * kBytesPerPixel;
    bitmap_.resize(size);
    bitmap_.assign(size, <span class="hex">0x00</span>);
  }
  <span class="directive">void</span> Advance(<span class="predefined-type">int</span> dx) { pos_ += dx; }
  uint8_t* GetDrawPosition(<span class="predefined-type">int</span> row) {
    uint32_t index =(row * width_ + pos_) * kBytesPerPixel;
    assert(index &lt; bitmap_.size());
    <span class="keyword">return</span> &amp;bitmap_[index];
  }
 <span class="directive">private</span>:
  DrawContext(<span class="directive">const</span> DrawContext&amp;) = <span class="keyword">delete</span>;
  DrawContext&amp; <span class="directive">operator</span>=(<span class="directive">const</span> DrawContext&amp;) = <span class="keyword">delete</span>;

  uint32_t pos_;
  uint32_t width_;
  uint32_t height_;
  std::vector&lt;uint8_t&gt; bitmap_;
};

<span class="keyword">struct</span> FaceOptions {
  <span class="predefined-type">int</span> pixel_size;
  <span class="predefined-type">int</span> load_flags;
  FT_Render_Mode render_mode;
  FaceOptions()
      : pixel_size(kDefaultPixelSize)
      , load_flags(<span class="integer">0</span>), render_mode(FT_RENDER_MODE_NORMAL) {}
};

<span class="keyword">class</span> <span class="class">FreeTypeFace</span> {
 <span class="directive">public</span>:
  FreeTypeFace(<span class="directive">const</span> std::<span class="predefined-type">string</span>&amp; font_file)
      : font_file_(font_file)
      , options_()
      , face_(<span class="predefined-constant">nullptr</span>)
  {
    error_ = FT_New_Face(gFtLibrary, font_file_.c_str(), <span class="integer">0</span>, &amp;face_);
    <span class="keyword">if</span> (error_) {
      face_ = <span class="predefined-constant">nullptr</span>;
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (IsColorEmojiFont())
      SetupColorFont();
    <span class="keyword">else</span>
      SetupNormalFont();
  }
  ~FreeTypeFace() {
    <span class="keyword">if</span> (face_)
      FT_Done_Face(face_);
  }
  FreeTypeFace(FreeTypeFace&amp;&amp; rhs)
      : font_file_(rhs.font_file_)
      , options_(rhs.options_)
      , face_(rhs.face_)
      , error_(rhs.error_)
  {
    rhs.face_ = <span class="predefined-constant">nullptr</span>;
  }
  <span class="predefined-type">bool</span> CalculateBox(uint32_t codepoint, uint32_t&amp; width, uint32_t&amp; height) {
    <span class="keyword">if</span> (!RenderGlyph(codepoint))
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    width += (face_-&gt;glyph-&gt;advance.x &gt;&gt; <span class="integer">6</span>);
    height = std::max(
        height, <span class="keyword">static_cast</span>&lt;uint32_t&gt;(face_-&gt;glyph-&gt;metrics.height &gt;&gt; <span class="integer">6</span>));
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
  }
  <span class="predefined-type">bool</span> DrawCodepoint(DrawContext&amp; context, uint32_t codepoint) {
    <span class="keyword">if</span> (!RenderGlyph(codepoint))
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">U+%08X -&gt; %s</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, codepoint, font_file_.c_str());
    <span class="keyword">return</span> DrawBitmap(context, face_-&gt;glyph);
  }
  <span class="predefined-type">int</span> Error() <span class="directive">const</span> { <span class="keyword">return</span> error_; }

 <span class="directive">private</span>:
  FreeTypeFace(<span class="directive">const</span> FreeTypeFace&amp;) = <span class="keyword">delete</span>;
  FreeTypeFace&amp; <span class="directive">operator</span>=(<span class="directive">const</span> FreeTypeFace&amp;) = <span class="keyword">delete</span>;

  <span class="predefined-type">bool</span> RenderGlyph(uint32_t codepoint) {
    <span class="keyword">if</span> (!face_)
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    uint32_t glyph_index = FT_Get_Char_Index(face_, codepoint);
    <span class="keyword">if</span> (glyph_index == <span class="integer">0</span>)
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    error_ = FT_Load_Glyph(face_, glyph_index, options_.load_flags);
    <span class="keyword">if</span> (error_)
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    error_ = FT_Render_Glyph(face_-&gt;glyph, options_.render_mode);
    <span class="keyword">if</span> (error_)
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
  }
  <span class="predefined-type">bool</span> IsColorEmojiFont() {
    <span class="directive">static</span> <span class="directive">const</span> uint32_t tag = FT_MAKE_TAG(<span class="char">'C'</span>, <span class="char">'B'</span>, <span class="char">'D'</span>, <span class="char">'T'</span>);
    <span class="predefined-type">unsigned</span> <span class="predefined-type">long</span> length = <span class="integer">0</span>;
    FT_Load_Sfnt_Table(face_, tag, <span class="integer">0</span>, <span class="predefined-constant">nullptr</span>, &amp;length);
    <span class="keyword">if</span> (length) {
      std::cout &lt;&lt; font_file_ &lt;&lt; <span class="string"><span class="delimiter">&quot;</span><span class="content"> is color font</span><span class="delimiter">&quot;</span></span> &lt;&lt; std::endl;
      <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }
    <span class="keyword">return</span> <span class="predefined-constant">false</span>;
  }
  <span class="directive">void</span> SetupNormalFont() {
    error_ = FT_Set_Pixel_Sizes(face_, <span class="integer">0</span>, options_.pixel_size);
  }
  <span class="directive">void</span> SetupColorFont() {
    options_.load_flags |= FT_LOAD_COLOR;

    <span class="keyword">if</span> (face_-&gt;num_fixed_sizes == <span class="integer">0</span>)
      <span class="keyword">return</span>;
    <span class="predefined-type">int</span> best_match = <span class="integer">0</span>;
    <span class="predefined-type">int</span> diff = std::abs(options_.pixel_size - face_-&gt;available_sizes[<span class="integer">0</span>].width);
    <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">1</span>; i &lt; face_-&gt;num_fixed_sizes; ++i) {
      <span class="predefined-type">int</span> ndiff =
          std::abs(options_.pixel_size - face_-&gt;available_sizes[i].width);
      <span class="keyword">if</span> (ndiff &lt; diff) {
        best_match = i;
        diff = ndiff;
      }
    }
    error_ = FT_Select_Size(face_, best_match);
  }
  <span class="predefined-type">bool</span> DrawBitmap(DrawContext&amp; context, FT_GlyphSlot slot) {
    <span class="predefined-type">int</span> pixel_mode = slot-&gt;bitmap.pixel_mode;
    <span class="keyword">if</span> (pixel_mode == FT_PIXEL_MODE_BGRA)
      DrawColorBitmap(context, slot);
    <span class="keyword">else</span>
      DrawNormalBitmap(context, slot);
    context.Advance(slot-&gt;advance.x &gt;&gt; <span class="integer">6</span>);
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
  }
  <span class="directive">void</span> DrawColorBitmap(DrawContext&amp; context, FT_GlyphSlot slot) {
    uint8_t* src = slot-&gt;bitmap.buffer;
    <span class="comment">// FIXME: Should use metrics for drawing. (e.g. calculate baseline)</span>
    <span class="predefined-type">int</span> yoffset = context.Height() - slot-&gt;bitmap.rows;
    <span class="keyword">for</span> (<span class="predefined-type">int</span> y = <span class="integer">0</span>; y &lt; slot-&gt;bitmap.rows; ++y) {
      uint8_t* dest = context.GetDrawPosition(y + yoffset);
      <span class="keyword">for</span> (<span class="predefined-type">int</span> x = <span class="integer">0</span>; x &lt; slot-&gt;bitmap.width; ++x) {
        uint8_t b = *src++, g = *src++, r = *src++, a = *src++;
        *dest++ = r; *dest++ = g; *dest++ = b; *dest++ = a;
      }
    }
  }
  <span class="directive">void</span> DrawNormalBitmap(DrawContext&amp; context, FT_GlyphSlot slot) {
    uint8_t* src = slot-&gt;bitmap.buffer;
    <span class="comment">// FIXME: Same as DrawColorBitmap()</span>
    <span class="predefined-type">int</span> yoffset = context.Height() - slot-&gt;bitmap.rows;
    <span class="keyword">for</span> (<span class="predefined-type">int</span> y = <span class="integer">0</span>; y &lt; slot-&gt;bitmap.rows; ++y) {
      uint8_t* dest = context.GetDrawPosition(y + yoffset);
      <span class="keyword">for</span> (<span class="predefined-type">int</span> x = <span class="integer">0</span>; x &lt; slot-&gt;bitmap.width; ++x) {
        *dest++ = <span class="integer">255</span> - *src;
        *dest++ = <span class="integer">255</span> - *src;
        *dest++ = <span class="integer">255</span> - *src;
        *dest++ = *src; <span class="comment">// Alpha</span>
        ++src;
      }
    }
  }

  std::<span class="predefined-type">string</span> font_file_;
  FaceOptions options_;
  FT_Face face_;
  <span class="predefined-type">int</span> error_;
};

<span class="keyword">class</span> <span class="class">FontList</span> {
  <span class="keyword">typedef</span> std::vector&lt;std::unique_ptr&lt;FreeTypeFace&gt;&gt; FaceList;
 <span class="directive">public</span>:
  FontList() {}

  <span class="directive">void</span> AddFont(<span class="directive">const</span> std::<span class="predefined-type">string</span>&amp; font_file) {
    <span class="directive">auto</span> face = std::unique_ptr&lt;FreeTypeFace&gt;(<span class="keyword">new</span> FreeTypeFace(font_file));
    face_list_.push_back(std::move(face));
  }
  <span class="directive">void</span> CalculateBox(uint32_t codepoint, uint32_t&amp; width, uint32_t&amp; height) {
    <span class="directive">static</span> <span class="directive">const</span> uint32_t kSpace = <span class="hex">0x20</span>;
    <span class="keyword">if</span> (codepoint == kSpace) {
      width += kSpaceWidth;
    } <span class="keyword">else</span> {
      <span class="keyword">for</span> (<span class="directive">auto</span>&amp; face : face_list_) {
        <span class="keyword">if</span> (face-&gt;CalculateBox(codepoint, width, height))
          <span class="keyword">return</span>;
      }
    }
  }
  <span class="directive">void</span> DrawCodepoint(DrawContext&amp; context, uint32_t codepoint) {
    <span class="keyword">for</span> (<span class="directive">auto</span>&amp; face : face_list_) {
      <span class="keyword">if</span> (face-&gt;DrawCodepoint(context, codepoint))
        <span class="keyword">return</span>;
    }
    std::cerr &lt;&lt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Missing glyph for codepoint: </span><span class="delimiter">&quot;</span></span> &lt;&lt; codepoint &lt;&lt; std::endl;
  }

 <span class="directive">private</span>:
  FontList(<span class="directive">const</span> FontList&amp;) = <span class="keyword">delete</span>;
  FontList&amp; <span class="directive">operator</span>=(<span class="directive">const</span> FontList&amp;) = <span class="keyword">delete</span>;
  FaceList face_list_;
};

<span class="keyword">class</span> <span class="class">PngWriter</span> {
 <span class="directive">public</span>:
  PngWriter(<span class="directive">const</span> std::<span class="predefined-type">string</span>&amp; outfile)
      : outfile_(outfile), png_(<span class="predefined-constant">nullptr</span>), info_(<span class="predefined-constant">nullptr</span>)
  {
    fp_ = fopen(outfile_.c_str(), <span class="string"><span class="delimiter">&quot;</span><span class="content">wb</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">if</span> (!fp_) {
      std::cerr &lt;&lt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to open: </span><span class="delimiter">&quot;</span></span> &lt;&lt; outfile_ &lt;&lt; std::endl;
      Cleanup();
      <span class="keyword">return</span>;
    }
    png_ = png_create_write_struct(
        PNG_LIBPNG_VER_STRING, <span class="predefined-constant">nullptr</span>, <span class="predefined-constant">nullptr</span>, <span class="predefined-constant">nullptr</span>);
    <span class="keyword">if</span> (!png_) {
      std::cerr &lt;&lt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to create PNG file</span><span class="delimiter">&quot;</span></span> &lt;&lt; std::endl;
      Cleanup();
      <span class="keyword">return</span>;
    }
    info_ = png_create_info_struct(png_);
    <span class="keyword">if</span> (!info_) {
      std::cerr &lt;&lt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to create PNG file</span><span class="delimiter">&quot;</span></span> &lt;&lt; std::endl;
      Cleanup();
      <span class="keyword">return</span>;
    }
  }
  ~PngWriter() { Cleanup(); }
  <span class="predefined-type">bool</span> Write(uint8_t* rgba, <span class="predefined-type">int</span> width, <span class="predefined-type">int</span> height) {
    <span class="directive">static</span> <span class="directive">const</span> <span class="predefined-type">int</span> kDepth = <span class="integer">8</span>;
    <span class="keyword">if</span> (!png_) {
      std::cerr &lt;&lt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Writer is not initialized</span><span class="delimiter">&quot;</span></span> &lt;&lt; std::endl;
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    <span class="keyword">if</span> (setjmp(png_jmpbuf(png_))) {
      std::cerr &lt;&lt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to write PNG</span><span class="delimiter">&quot;</span></span> &lt;&lt; std::endl;
      Cleanup();
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }
    png_set_IHDR(png_, info_, width, height, kDepth,
                 PNG_COLOR_TYPE_RGB_ALPHA, PNG_INTERLACE_NONE,
                 PNG_COMPRESSION_TYPE_DEFAULT, PNG_FILTER_TYPE_DEFAULT);
    png_init_io(png_, fp_);
    png_byte** row_pointers =
        <span class="keyword">static_cast</span>&lt;png_byte**&gt;(png_malloc(png_, height * <span class="keyword">sizeof</span>(png_byte*)));
    uint8_t* src = rgba;
    <span class="keyword">for</span> (<span class="predefined-type">int</span> y = <span class="integer">0</span>; y &lt; height; ++y) {
      png_byte* row =
          <span class="keyword">static_cast</span>&lt;png_byte*&gt;(png_malloc(png_, width * kBytesPerPixel));
      row_pointers[y] = row;
      <span class="keyword">for</span> (<span class="predefined-type">int</span> x = <span class="integer">0</span>; x &lt; width; ++x) {
        *row++ = *src++;
        *row++ = *src++;
        *row++ = *src++;
        *row++ = *src++;
      }
      assert(row - row_pointers[y] == width * kBytesPerPixel);
    }
    assert(src - rgba == width * height * kBytesPerPixel);
    png_set_rows(png_, info_, row_pointers);
    png_write_png(png_, info_, PNG_TRANSFORM_IDENTITY, <span class="integer">0</span>);
    <span class="keyword">for</span> (<span class="predefined-type">int</span> y = <span class="integer">0</span>; y &lt; height; y++)
      png_free(png_, row_pointers[y]);
    png_free(png_, row_pointers);
    Cleanup();
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
  }
 <span class="directive">private</span>:
  PngWriter(<span class="directive">const</span> PngWriter&amp;) = <span class="keyword">delete</span>;
  PngWriter <span class="directive">operator</span>=(<span class="directive">const</span> PngWriter&amp;) = <span class="keyword">delete</span>;
  <span class="directive">void</span> Cleanup() {
    <span class="keyword">if</span> (fp_) { fclose(fp_); }
    <span class="keyword">if</span> (png_) png_destroy_write_struct(&amp;png_, &amp;info_);
    fp_ = <span class="predefined-constant">nullptr</span>; png_ = <span class="predefined-constant">nullptr</span>; info_ = <span class="predefined-constant">nullptr</span>;
  }

  std::<span class="predefined-type">string</span> outfile_;
  FILE* fp_;
  png_structp png_;
  png_infop info_;
  <span class="predefined-type">char</span>* rgba_;
  uint32_t width_;
  uint32_t height_;
};

<span class="keyword">class</span> <span class="class">App</span> {
 <span class="directive">public</span>:
  <span class="directive">void</span> AddFont(<span class="directive">const</span> std::<span class="predefined-type">string</span>&amp; font_file) { font_list_.AddFont(font_file); }
  <span class="predefined-type">bool</span> SetText(<span class="directive">const</span> <span class="predefined-type">char</span>* text) { <span class="keyword">return</span> UTF8ToCodepoint(text); }
  <span class="predefined-type">bool</span> Execute() {
    CalculateImageSize();
    Draw();
    <span class="keyword">return</span> Output();
  }
 <span class="directive">private</span>:
  <span class="predefined-type">bool</span> UTF8ToCodepoint(<span class="directive">const</span> <span class="predefined-type">char</span>* text) {
    int32_t i = <span class="integer">0</span>, length = strlen(text), c;
    <span class="keyword">while</span> (i &lt; length) {
      U8_NEXT(text, i, length, c);
      <span class="keyword">if</span> (c &lt; <span class="integer">0</span>) {
        std::cerr &lt;&lt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid input text</span><span class="delimiter">&quot;</span></span> &lt;&lt; std::endl;
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
      }
      codepoints_.push_back(c);
    }
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
  }
  <span class="directive">void</span> CalculateImageSize() {
    uint32_t width = <span class="integer">0</span>, height = <span class="integer">0</span>;
    <span class="keyword">for</span> (<span class="directive">auto</span> c : codepoints_)
      font_list_.CalculateBox(c, width, height);
    printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">width: %u, height: %u</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, width, height);
    draw_context_.SetSize(width, height);
  }
  <span class="directive">void</span> Draw() {
    <span class="keyword">for</span> (<span class="directive">auto</span> c : codepoints_)
      font_list_.DrawCodepoint(draw_context_, c);
  }
  <span class="predefined-type">bool</span> Output() {
    PngWriter writer(kDefaultOutputFile);
    <span class="keyword">return</span> writer.Write(draw_context_.Bitmap(),
                        draw_context_.Width(),
                        draw_context_.Height());
  }

  std::vector&lt;uint32_t&gt; codepoints_;
  FontList font_list_;
  DrawContext draw_context_;
};

<span class="predefined-type">bool</span> Init() {
  <span class="predefined-type">int</span> error = FT_Init_FreeType(&amp;gFtLibrary);
  <span class="keyword">if</span> (error) {
    std::cerr &lt;&lt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to initialize freetype</span><span class="delimiter">&quot;</span></span> &lt;&lt; std::endl;
    <span class="keyword">return</span> error;
  }
  <span class="keyword">return</span> error == <span class="integer">0</span>;
}

<span class="directive">void</span> Finish() {
  FT_Done_FreeType(gFtLibrary);
}

<span class="directive">void</span> Usage() {
  std::cout
      &lt;&lt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Usage: clfontpng font1.ttf [font2.ttf ...] text</span><span class="delimiter">&quot;</span></span>
      &lt;&lt; std::endl;
  std::exit(<span class="integer">1</span>);
}

<span class="predefined-type">bool</span> ParseArgs(App&amp; app, <span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>** argv) {
  <span class="keyword">if</span> (argc &lt; <span class="integer">2</span>)
    <span class="keyword">return</span> <span class="predefined-constant">false</span>;
  <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">1</span>; i &lt; argc - <span class="integer">1</span>; ++i)
    app.AddFont(argv[i]);
  <span class="keyword">return</span> app.SetText(argv[argc - <span class="integer">1</span>]);
}

<span class="predefined-type">bool</span> Start(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>** argv) {
  App app;
  <span class="keyword">if</span> (!ParseArgs(app, argc, argv))
    Usage();
  <span class="keyword">return</span> app.Execute();
}

} <span class="comment">// namespace</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>** argv) {
  <span class="keyword">if</span> (!Init())
    std::exit(<span class="integer">1</span>);
  <span class="predefined-type">bool</span> success = Start(argc, argv);
  Finish();
  <span class="keyword">return</span> success ? <span class="integer">0</span> : <span class="integer">1</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try the program on a simple Unicode emoji using the font <a href="https://www.google.com/get/noto/help/emoji/"><em>Noto Color Emoji</em></a>. This font, developed by Google, is available by default on Ubuntu Desktop but not on Ubuntu Server, so we need to install it first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ sudo apt install fonts-noto-color-emoji
$ sudo apt install fontconfig  # Install the command fc-list
$ fc-list  # List of the fonts on your system
/usr/share/fonts/truetype/dejavu/DejaVuSerif-Bold.ttf: DejaVu Serif:style=Bold
/usr/share/fonts/truetype/dejavu/DejaVuSansMono.ttf: DejaVu Sans Mono:style=Book
/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf: DejaVu Sans:style=Book
/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf: DejaVu Sans:style=Bold
/usr/share/fonts/truetype/dejavu/DejaVuSansMono-Bold.ttf: DejaVu Sans Mono:style=Bold
/usr/share/fonts/truetype/noto/NotoColorEmoji.ttf: Noto Color Emoji:style=Regular
/usr/share/fonts/truetype/dejavu/DejaVuSerif.ttf: DejaVu Serif:style=Book</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ ./clfontpng /usr/share/fonts/truetype/noto/NotoColorEmoji.ttf üî´
/usr/share/fonts/truetype/noto/NotoColorEmoji.ttf is color font
width: 136, height: 128
U+0001F52B -&gt; /usr/share/fonts/truetype/noto/NotoColorEmoji.ttf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The emoji is correctly rendered:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/freetype-pistol-Noto.png" alt="freetype pistol Noto">
</div>
</div>
<div class="paragraph">
<p>This pistol has not always being a toy. If I rerun the same command using <a href="https://github.com/googlefonts/noto-emoji/blob/v2017-09-13-design-refresh/fonts/NotoColorEmoji.ttf">a previous version of the font</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">root@vagrant:/vagrant# ./clfontpng NotoColorEmoji-v2017.ttf üî´
NotoColorEmoji-v2017.ttf is color font
width: 136, height: 128
U+0001F52B -&gt; NotoColorEmoji-v2017.ttf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The pistol is now a weapon:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/freetype-pistol-Noto-v2017.png" alt="freetype pistol Noto v2017">
</div>
</div>
<div class="paragraph">
<p>The explanation dates back to 2016, when <a href="https://money.cnn.com/2016/08/01/technology/apple-pistol-emoji/index.html">Apple announced that in iOS 10, the pistol emoji (U+1F52B üî´ ) would be changed from a real revolver to a water pistol</a>. At the same time, Microsoft decided the pistol emoji would be changed from a toy ray-gun to a real revolver to be more in line with industry-standard designs&#8230;&#8203; Finally, in 2018, most platforms such as Google, Microsoft, Samsung, Facebook, and Twitter had transitioned their rendering of the pistol emoji to match Apple&#8217;s water gun implementation, which means that during two years, the pistol could be understood as a joke or as a threat, depending on if the sender was running on Android or iOS. This is not the only example of <a href="https://en.wikipedia.org/wiki/Emoji#Controversial_emoji">controversial emojis</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now try a font that does not support emojis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ ./clfontpng SourceSansPro-Bold.ttf üî´
width: 0, height: 0
Missing glyph for codepoint: 128299
libpng warning: Image width is zero in IHDR
libpng warning: Image height is zero in IHDR
libpng error: Invalid IHDR data
Failed to write PNG</code></pre>
</div>
</div>
<div class="paragraph">
<p>The program correctly reports the missing glyph. Now, let&#8217;s try to combine several fonts to simulate the font fallback mechanism:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ ./clfontpng SourceSansPro-Bold.ttf NotoColorEmoji.ttf —í·Ω≥lL∆†üéâ
NotoColorEmoji.ttf is color font
width: 460, height: 128
U+00000452 -&gt; SourceSansPro-Bold.ttf
U+00001F73 -&gt; SourceSansPro-Bold.ttf
U+0000006C -&gt; SourceSansPro-Bold.ttf
U+0000004C -&gt; SourceSansPro-Bold.ttf
U+000001A0 -&gt; SourceSansPro-Bold.ttf
U+0001F389 -&gt; NotoColorEmoji.ttf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output reveals that glyphs from different font files are used to render the final text:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/freetype-hello.png" alt="freetype hello">
</div>
</div>
<div class="paragraph">
<p>If you are curious about this text rendering process, you can inspect the <a href="https://github.com/chromium/chromium/tree/93.0.4540.1/third_party/blink/renderer/platform/fonts">Chromium rendering engine</a> or read the <a href="https://harfbuzz.github.io/index.html:">documentation of the project HarfBuff</a>.</p>
</div>
<div class="sect3">
<h4 id="example_slack_emojis">Example: Slack Emojis</h4>
<div class="paragraph">
<p>Slack and emojis are inseparable. Emojis make long messages less boring and are indispensable to communicate your mood so that others can interpret your messages correctly. Slack even support custom emojis. How does Slack support so many different emojis? It&#8217;s simple. They are not Unicode emojis.</p>
</div>
<div class="paragraph">
<p>Indeed, Unicode is an evolving standard. Slack cannot wait for Unicode to approve your custom emoji during the next meeting. Slack cannot either use the private-use range of characters as it would mean regenerating new font files with your emojis and making sure your recipient receives the new font too. So, Slack is using images, even for standard Unicode characters when using the Slack web client (ex: the image <span class="image"><a class="image" href="https://a.slack-edge.com/production-standard-emoji-assets/13.0/apple-large/1f52b@2x.png"><img src="/posts_resources/2021-06-19-unicode-for-curious-developers/slack-pistol-emoji.png" alt="slack pistol emoji" height="18px"></a></span> represents the <code>PISTOL EMOJI</code> üî´ U+1F52B).</p>
</div>
<div class="paragraph">
<p><strong>Using images instead of Unicode characters is not problematic when the same application is used on both sides</strong>. When you are sending a message on Slack Desktop, you know that your recipient will check it using one of the clients supported by Slack. Therefore, it is easy for Slack to make sure that the images for the emojis are available everywhere. The problem occurs when you try to copy/paste some text from Slack to a different application. In this case, what Slack is doing is replacing these images with textual representation like <code>:slightly_smiling_face:</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/slack-message.png" alt="slack message" width="300">
</div>
</div>
<div class="paragraph">
<p>When copied into a different application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Hey :wave:,
What‚Äôs up? :slightly_smiling_face:</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example_gmail">Example: Gmail</h4>
<div class="paragraph">
<p>Gmail is using the same approach as Slack. As a web application, Gmail cannot be sure of the fonts available on every device, and therefore, Gmail relies on images too so that the recipient can see the email as the sender viewed it.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/gmail-message.png" alt="gmail message">
</div>
</div>
<div class="paragraph">
<p>The HTLM source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">:hb</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Am Al editable LW-avf tS-tW</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">hidefocus</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">aria-label</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Message Body</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">g_editable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">textbox</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">aria-multiline</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">contenteditable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">tabindex</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">direction</span>: <span class="value">ltr</span>; <span class="key">min-height</span>: <span class="float">204px</span>;<span class="delimiter">&quot;</span></span>
     <span class="attribute-name">itacorner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">6,7:1,1,0,0</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">spellcheck</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  Hey<span class="entity">&amp;nbsp;</span>
  <span class="tag">&lt;img</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">//ssl.gstatic.com/mail/emoji/v7/png48/emoji_u1f44b.png</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">alt</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Ôëã</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">goomoji</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1f44b</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">data-goomoji</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1f44b</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">vertical-align</span>: <span class="value">middle</span>; <span class="key">height</span>: <span class="float">24px</span>; <span class="key">width</span>: <span class="float">24px</span>;<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;div&gt;</span>What's up?<span class="entity">&amp;nbsp;</span>
    <span class="tag">&lt;img</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">//ssl.gstatic.com/mail/emoji/v7/png48/emoji_u1f642.png</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">alt</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ÔôÇ</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">goomoji</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1f642</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">data-goomoji</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1f642</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">vertical-align</span>: <span class="value">middle</span>; <span class="key">height</span>: <span class="float">24px</span>; <span class="key">width</span>: <span class="float">24px</span>;<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
<span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example_yat">Example: YAT</h4>
<div class="paragraph">
<p>YAT allows you to generate a unique chain of emoji characters to be used as your universal identifier on the Internet. Interoperability is thus important. Your YAT name will be used on many other sites, and YAT is restricted by the emojis defined by Unicode.</p>
</div>
<div class="paragraph">
<p>After creating your YAT account, YAT offers you a unique YAT URL to redirect to your profile using your emoji chain in the path:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/yat-url-website.png" alt="yat url website" width="250">
</div>
</div>
<div class="paragraph">
<p>When copying this URL to my browser:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/yat-url-browser.png" alt="yat url browser" width="750">
</div>
</div>
<div class="paragraph">
<p>When pressing the Enter key, the URL becomes:</p>
</div>
<div class="paragraph">
<p><a href="https://y.at/%F0%9F%93%96%F0%9F%92%BB%E2%9C%8D%EF%B8%8F%E2%9D%A4%EF%B8%8F" class="bare">https://y.at/%F0%9F%93%96%F0%9F%92%BB%E2%9C%8D%EF%B8%8F%E2%9D%A4%EF%B8%8F</a></p>
</div>
<div class="paragraph">
<p>The fact is a URI must be composed of a limited set of ASCII characters consisting of digits, letters, and a few graphic symbols‚Äîsome unreserved (<code>-</code>, <code>.</code>, <code>_</code>, <code>~</code>), some reserved (<code>:</code>, <code>/</code>, <code>?</code>, <code>#</code>, &#8230;&#8203;) as used as delimiters. Emojis are not directly supported. For these characters, the <a href="https://datatracker.ietf.org/doc/html/rfc3986">URI RFC</a> defines a percent-encoding mechanism.</p>
</div>
<div class="paragraph">
<p>A percent-encoded octet is encoded as a character triplet, consisting of the percent character <code>%</code> followed by the two hexadecimal digits representing that octet&#8217;s numeric value. For example, <code>%20</code> is the percent-encoding for the binary octet <code>00100000</code>. And <code>%F0%9F%93%96</code> is the encoding for the binary <code>11110000 10011111 10010011 10010110</code>, which is the UTF-8 representation (<code>F0 9F 95 AE</code>) for the book emoji U+1F56E.</p>
</div>
<div class="paragraph">
<p>If you navigate on the YAT website, you will also see a ton of beautiful emojis displayed in large definition. These emojis are not Unicode emojis but hand-crafted illustrations in PNG format that you can also <a href="https://emojis.y.at/our-emojis#download">browse online</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/YAT-Exploding_head.png" alt="YAT Exploding head" width="350">
</div>
<div class="title">Figure 23. Shocked Face With Exploding Head Emoji U+1F92F rendered using the YAT artwork</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/Unicode-Exploding_head.png" alt="Unicode Exploding head" width="300">
</div>
<div class="title">Figure 24. Shocked Face With Exploding Head Emoji U+1F92F rendered using the HTML character</div>
</div>
<div class="paragraph">
<p>The Unicode character does not look good when displayed as a large text. The reason is most fonts like <em>Noto Color Emoji</em> or <em>Apple Color Emoji</em> are distributed with bitmap emoji glyphs. The <a href="https://help.fontself.com/en/articles/1241232-color-fonts-101">OpenType-SVG specification</a> adds support for vector-based glyphs using SVG. Font files will be larger as a consequence but the rendering will not be affected when scaling a glyph. The support is still partial, but Adobe is already supporting <a href="https://github.com/adobe-fonts/noto-emoji-svg">an OpenType-SVG font for Noto Color Emoji</a>. Here is the rendering in Chrome:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2021-06-19-unicode-for-curious-developers/Unicode-Exploding_head-SVG.png" alt="Unicode Exploding head SVG" width="300]">
</div>
<div class="title">Figure 25. Shocked Face With Exploding Head Emoji U+1F92F rendered using an OpenType-SVG font</div>
</div>
<div class="paragraph">
<p>The output is still not ideal (colors are missing), but we observe that the browser enlarges the glyph like any vector illustration.</p>
</div>
<div class="paragraph">
<p>This ends the part about the implementation of Unicode.</p>
</div>
<hr>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-future">The Future</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unicode provides a unique code for every character, in every program, on every platform. Unicode exists to preserve the world‚Äôs heritage. But with <a href="http://www.unicode.org/education/consortwork.html">approximately 6,000 languages spoken in the world today</a>, there are still many characters, writing systems to encode, and many new emojis to make Unicode even more popular.</p>
</div>
<div class="paragraph">
<p>Unicode is widely supported. Modern operating systems, programming languages, and software applications have support for Unicode, but the devil is in the details. Unicode support does not mean you can ignore Unicode completely. You need to understand what Unicode is and how your programming language implements it to create truly multilingual applications.</p>
</div>
<div class="admonitionblock note experiment">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">To Go Further</div>
<div class="paragraph">
<p>The scope of Unicode is wider than simply assigning code points to characters. Unicode gives programmers a vast amount of data about the handling of text:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.unicode.org/reports/tr14/">How to divide words and break lines</a>,</p>
</li>
<li>
<p><a href="http://unicode.org/reports/tr10/">How to sort text</a>,</p>
</li>
<li>
<p><a href="http://cldr.unicode.org/">How to format numbers, dates, times</a>, and other elements appropriate to different locales,</p>
</li>
<li>
<p><a href="https://unicode.org/reports/tr9/">How to display text for languages whose written form flows from right to left</a>, such as Arabic or Hebrew,</p>
</li>
<li>
<p><a href="https://unicode.org/reports/tr36/">How to deal with security concerns</a> regarding the many look-alike characters from writing systems around the world.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. The motivation for ASCII to save bytes was not really new. The problem occurred with the publication of the first books. <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.41.9729">Gutenberg used 250 characters to produce in 1455 the 42-line Bible</a>, the first printed book. Then, character sets became smaller and smaller in successive fonts, to reduce the costs of cutting, founding, composing, and distributing type.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Nowadays, a byte is always considered to be 8 bits but first computers did use different sizes for a byte, which was based on the size of information it needed to hold.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. In the document <em>Unicode 88</em>, the authors estimate the total number of characters to be less than 2<sup>14</sup> = 16,384, based on the union of all newspapers and magazines printed in the world in 1988.
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. Yat was created recently with the ambitious <a href="https://thedefiant.io/emoji-based-username-project-yat-wants-to-become-universal-internet-identity-system/">goal to create a new censorship resistant internet identity system</a> using a personalized string of emojis as your universal username.
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. Unicode includes <a href="https://scripts.sil.org/cms/scripts/page.php?site_id=nrsi&amp;id=IWS-Chapter04b">more than 10,000 characters that compromise the design principles behind the Standard</a>, like unification or dynamic composition.
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. Rob Pike and Ken Thompson discuss the benefits of using many little fonts compared to one big font during <a href="https://archive.org/details/hello-world-plan9">the implementation of the Plan 9 operating system</a>. It breaks the huge Unicode codespace into manageable components promoting sharing. For example, you can have only one font with the set of Japanese characters but dozens of fonts for Latin characters.
</div>
</div>
      </div>

      <div class="author-bio">
  <img src="/img/me.jpg" />
  <p><strong>About the author</strong></p>
  <p>Julien Sobczak works as a software developer for Scaleway, a French cloud provider. He is a passionate reader who likes to see the world differently to measure the extent of his ignorance. His main areas of interest are productivity (doing less and better), human potential, and everything that contributes in being a better person (including a better dad and a better developer).</p>
  <a href="https://fr.linkedin.com/in/julien-sobczak-56780a91">Read Full Profile</a>
</div>

    </article>

  </div>
</section>





  
<section id="labels" class="labels">
  <div class="container">

  <div>
    <h2>Tags</h2>
    <hr class="star-light">
  </div>


  <ul class="labels">
    <!-- TODO refactor remove useless tags and rename them. Ex: agile => people -->
    <!-- <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/agile.html"><span class="label-icon label-team-icon label-white-icon"></span><span class="label-text">People<span class="label-count">0</span></span></a>
      </div>
    </li> -->
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/architecture.html"><span class="label-icon label-architecture-icon label-white-icon"></span><span class="label-text">Architecture<span class="label-count">13</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/classics.html"><span class="label-icon label-classics-icon label-white-icon"></span><span class="label-text">Classics<span class="label-count">3</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/craftsmanship.html"><span class="label-icon label-craftsmanship-icon label-white-icon"></span><span class="label-text">Craftsmanship<span class="label-count">11</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/computer-science.html"><span class="label-icon label-computer-science-icon label-white-icon"></span><span class="label-text">Computer Science<span class="label-count">9</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/data.html"><span class="label-icon label-data-icon label-white-icon"></span><span class="label-text">Data<span class="label-count">6</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/devops.html"><span class="label-icon label-devops-icon label-white-icon"></span><span class="label-text">Devops<span class="label-count">11</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/frameworks.html"><span class="label-icon label-frameworks-icon label-white-icon"></span><span class="label-text">Frameworks<span class="label-count">10</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/human.html"><span class="label-icon label-human-icon label-white-icon"></span><span class="label-text">Human<span class="label-count">11</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/languages.html"><span class="label-icon label-languages-icon label-white-icon"></span><span class="label-text">Languages<span class="label-count">6</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/learning.html"><span class="label-icon label-reversing-icon label-white-icon"></span><span class="label-text">Learning<span class="label-count">31</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/management.html"><span class="label-icon label-management-icon label-white-icon"></span><span class="label-text">Management<span class="label-count">28</span></span></a>
      </div>
    </li>
    <!-- Not pertinent
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/popular.html"><span class="label-icon label-popular-icon label-white-icon"></span><span class="label-text">Popular<span class="label-count">0</span></span></a>
      </div>
    </li>
    -->
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/productivity.html"><span class="label-icon label-productivity-icon label-white-icon"></span><span class="label-text">Productivity<span class="label-count">16</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/tools.html"><span class="label-icon label-tools-icon label-white-icon"></span><span class="label-text">Tools<span class="label-count">9</span></span></a>
      </div>
    </li>
  </ul>

  </div>
</section>

  <footer id="footer">
    <img src="/img/me-torso-scaleway.png" class="footer-me" />
    <div class="footer-above">
        <div class="footer-col">
            <h3>Location</h3>
            <p>Lille<br>France</p>
        </div>
        <div class="footer-col">
            <h3>Around the Web</h3>
            <ul class="list-inline">
                <!-- <li>
                    <a href="https://www.goodreads.com/user/show/104485538-sobczak-julien" alt="Goodreads" title="Goodreads" class="btn-social btn-outline"><i class="fab fa-goodreads-g"></i></a>
                </li> -->
                <li>
                    <a href="https://literal.club/julien-sobczak" alt="Goodreads" title="Library.club" class="btn-social btn-outline"><i class="fa fa-book"></i></a>
                </li>
                <li>
                    <a href="https://github.com/julien-sobczak" alt="GitHub" title="GitHub" class="btn-social btn-outline"><i class="fab fa-github"></i></a>
                </li>
                <li>
                    <a href="https://fr.linkedin.com/in/julien-sobczak-56780a91" alt="LinkedIn" title="LinkedIn" class="btn-social btn-outline"><i class="fab fa-linkedin"></i></a>
                </li>
            </ul>
        </div>
    </div>
    <div class="footer-below">
        <span>Opinions are my own and don't reflect the views of my employer.</span><br/>
        <span class="manuscript">In addition, as anybody with an open mind, my opinions are likely to change from time to time...</span><br/><br/>
        <small class="copyright">Copyright &copy; 2024 Julien Sobczak</small><br/>
    </div>
</footer>

  <div id="easter-egg">
  <div id="water"></div>
  <div id="bikini-bottom">
    <img id="spongebob" src="/img/easter-egg/spongebob.png" width="20%">
  </div>
</div>
  <!-- Font Awesome CDN -->
<!-- <script src="https://kit.fontawesome.com/d54861fcaa.js" crossorigin="anonymous"></script> -->
<script src="/js/index.js"></script>

<!-- Masonry effect -->
<!-- <script src="https://unpkg.com/colcade@0/colcade.js"></script> -->
<script src="/vendor/fontawesome.js"></script>

<!-- Custom logic -->
<script src="/vendor/colcade.js"></script>


</body>
</html>
