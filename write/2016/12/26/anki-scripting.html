<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="Julien Sobczak">
<meta name="robots" content="index,follow,noodp">
<meta name="googlebot" content="index,follow">
<meta name="subject" content="Programming">


    <title>Anki Scripting: Automate your flashcards</title>

    <!-- To make search engines use the HTTPS url -->
<link rel="canonical" href="https://www.juliensobczak.com/write/2016/12/26/anki-scripting.html">
<link rel="alternate" type="application/atom+xml" title="I'm Lovin' I.T. - Julien Sobczak" href="https://www.juliensobczak.com/feed.xml">

<!-- Asciidoctor assets -->
<link href="/css/coderay.css" rel="stylesheet" />

<!-- Theme CSS -->
<link href="/css/app.css" rel="stylesheet">

<!-- Custom Fonts -->
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i|Oswald" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Nothing+You+Could+Do" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Righteous" rel="stylesheet">

<!-- Favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

</head>

<body id="page-post">
  <!-- Custom loader -->
<div id="loader-wrapper">
  <div id="loader"></div>
</div>


  <!-- Navigation -->

  <nav id="mainNav" class="navbar-default">

    
    
    <div id="reading-bar"></div>
    
    

    <div class="container">
      <a class="navbar-brand" href="/index.html">I'm lovin' I.T.</a>
      <div class="navbar-collabsible">
        <input id="collapsible" class="navbar-checkbox-toggle" type="checkbox">
        <label for="collapsible" class="navbar-label-toggle">Menu <i class="fas fa-bars"></i></label>
        <div class="navbar-collapse">
          <ul>

            
            <li>
            
                <a href="/categories/read.html">I'm readin' I.T.</a>
            </li>

            
            <li class="active">
            
                <a href="/categories/write.html">I'm writin' I.T.</a>
            </li>

            
            <li>
            
                <a href="/categories/inspect.html">I'm inspectin' I.T.</a>
            </li>

            <li class="page-scroll">
                <a href="https://fr.linkedin.com/in/julien-sobczak-56780a91">About Me</a>
            </li>
          </ul>
        </div>
      </div>
      <button id="zen-mode-in"><i class="fas fa-minus"></i></button>
      <button id="zen-mode-out"><i class="fas fa-plus"></i></button>
    </div>
  </nav>


  <header class="post-title post-write">
  <!-- see https://www.elastic.co/blog/elasticsearch-5-0-0-released -->
  <div class="container">

    <div class="icon-category">
    </div>

    <div class="metadata">
      <span class="date">December 26, 2016</span>

      
      <a href="/tags/tools" class="label">
      Tools
      </a>
      
      <a href="/tags/learning" class="label">
      Learning
      </a>
      

      
      <span class="label">
        Flashcards
      </span>
      

      <ul class="language">
        <li class="current-language"><a class="active" href="#">EN</a></li>
      </ul>

      <h2>Anki Scripting: Automate your flashcards</h2>
      

      <p class="author-name">
        
        <span>By </span>
        
        <a href="/#about-me">Julien Sobczak</a>
      </p>

     </div>
    </div>
  </div>
</header>

<section class="content">

  <div class="container sticky-container">

    
    <article>
    

      <div class="content">
      <div class="admonitionblock caution license">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There is a newer version of this article, <a href="/write/2020/12/26/anki-scripting-for-non-programmers.html"><em>Anki Scripting for Non-Programmers</em></a>. This new post is shorter and is a great introduction to the subject. You can come back to this older article if you want more details about Anki and/or learn about some advanced use cases like converting an ebook into flashcards.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="a_look_inside_the_anki_model">A look inside the Anki model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the first part in this lengthy article on Anki and how to use it to create your flashcards programmatically. We will begin by presenting the inner model of Anki, how the different classes interact and when the database is updated when we are using the desktop application. In the next part, we will be doing the same thing without using the GUI, using only the internal API of Anki. We will also cover how to script Anki to bulk load flashcards, useful for example when you need to learn the 5000 most common words in a new language. Let&#8217;s get started!</p>
</div>
<div class="sect2">
<h3 id="anki_reverse_engineering">Anki Reverse Engineering</h3>
<div class="paragraph">
<p>A good start is to begin by cloning the official repository of Anki:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git clone https://github.com/dae/anki.git</pre>
</div>
</div>
<div class="paragraph">
<p>When the clone of the repository is finished, enter into this new directory <code>anki</code> et let&#8217;s see how the code is organized.</p>
</div>
<div class="sect3">
<h4 id="project_organization">Project organization</h4>
<div class="paragraph">
<p>Not all directories are pertinent for our analysis. Here is an annotated description of each folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>anki/          -&gt; Main Anki logic. Contains the model and the SRS algorithm
  | importing/ -&gt; Logic to import various file formats including Anki1, Anki2,
                  Supermemo (a paid Anki-like tool)
  | template/  -&gt; Anki uses a modified version of Pystache to provide
                  Mustache-like syntax.
                  The templating is using to render flashcard's content.
aqt/           -&gt; Contains Python scripts using PyQT to build the widgets,
                  dialogs and other graphical components
                  that composed the Anki Desktop Application.
designer/      -&gt; Contains PyQT 4 UI files created using Qt Designer.
                  These files are generated using the command pyuic4.
tests/         -&gt; Unit tests based on the framework Nose
  | support/   -&gt; Fixtures (anki and anki2 files, PNG media file, ...)
tools/         -&gt; Simple shell scripts to launch the tests or the UI generation
Makefile       -&gt; Basic build script to install or uninstall Anki
                  (create folders and move files using mkdir
                  and mv Unix commands)</pre>
</div>
</div>
<div class="paragraph">
<p>The two most important folders are <code>anki</code> and <code>aqt</code>: the first contains all the core logic behind Anki (model, SRS algorithm) while the second contains all the code concerning the Desktop GUI, using the QT library.</p>
</div>
<div class="paragraph">
<p>When you click on the Anki icon, the script <code>runanki.py</code> is executed. This script does not do much except launching the GUI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">aqt</span>
aqt.run()</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Where are stored my cards?</div>
<div class="paragraph">
<p>Anki stores your decks in the folder associated with your profile. This folder stores all of your Anki data in a single location, to make backups easy. By default, Anki uses the folder ~/Documents/Anki under your home directory:</p>
</div>
<div class="listingblock">
<div class="title">aqt/profiles.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">_defaultBase</span>(<span class="predefined-constant">self</span>):
    <span class="keyword">if</span> isWin:
        <span class="keyword">if</span> <span class="predefined-constant">False</span>: <span class="comment">#qtmajor &gt;= 5:</span>
            loc = QStandardPaths.writeableLocation(
                      QStandardPaths.DocumentsLocation)
        <span class="keyword">else</span>:
            loc = QDesktopServices.storageLocation(
                      QDesktopServices.DocumentsLocation)
        <span class="keyword">return</span> os.path.join(loc, <span class="string"><span class="delimiter">&quot;</span><span class="content">Anki</span><span class="delimiter">&quot;</span></span>)
    <span class="keyword">elif</span> isMac:
        <span class="keyword">return</span> os.path.expanduser(<span class="string"><span class="delimiter">&quot;</span><span class="content">~/Documents/Anki</span><span class="delimiter">&quot;</span></span>)
    <span class="keyword">else</span>:
        <span class="comment"># use Documents/Anki on new installs, ~/Anki on existing ones</span>
        p = os.path.expanduser(<span class="string"><span class="delimiter">&quot;</span><span class="content">~/Anki</span><span class="delimiter">&quot;</span></span>)
        <span class="keyword">if</span> os.path.exists(p):
            <span class="keyword">return</span> p
        <span class="keyword">else</span>:
            loc = QDesktopServices.storageLocation(
                      QDesktopServices.DocumentsLocation)
            <span class="keyword">if</span> loc[:-<span class="integer">1</span>] == QDesktopServices.storageLocation(
                    QDesktopServices.HomeLocation):
                <span class="comment"># occasionally &quot;documentsLocation&quot; will return the home</span>
                <span class="comment"># folder because the Documents folder isn't configured</span>
                <span class="comment"># properly; fall back to an English path</span>
                <span class="keyword">return</span> os.path.expanduser(<span class="string"><span class="delimiter">&quot;</span><span class="content">~/Documents/Anki</span><span class="delimiter">&quot;</span></span>)
            <span class="keyword">else</span>:
                <span class="keyword">return</span> os.path.join(loc, <span class="string"><span class="delimiter">&quot;</span><span class="content">Anki</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To tell Anki to use a different location, please see: <a href="https://ankisrs.net/docs/manual.html#startupopts" class="bare">https://ankisrs.net/docs/manual.html#startupopts</a>
This could be very useful when you experiment with Anki to avoid corrupting our data!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, we know where is stored our database, let&#8217;s inspect the different files present under this directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>~/Documents/Anki
 |- addons: a list of third-party add-ons that you can install directly
 |          from Anki &gt; Tools &gt; Add-ons &gt; ...
 |          On fresh install, this folder is empty as no add-ons are installed
 |- User 1: A folder named after your profile name
 |   |- backups: The most recent backups automatically created by Anki
 |   |   |       (the last 30 backups are saved by default)
 |   |   |- backup-88.apkg
 |   |   | ...
 |   |   \- backup-117.apkg
 |   |- collection.media: The list of media included in the cards
 |   |   |- hello.png
 |   |   \- ... (hundreds of images, sounds for my personal folder)
 |   |- collection.anki2: A SQLite database containing all
 |   |                    of your decks, cards, ...
 |   |- collection.anki2-journal: A binary file
 |   |- collection.log: A log file containing the list of actions
 |   |                  (method calls) with their timestamp
 |   |- collection.media.db2: An SQLite database listing all of the media
 |   \- deleted.txt: A log of card deletions acting as the trash bin.
 |                   The file is always appended by Anki but never read directly
 \- prefs.db: A SQLite database to contains your preferences.</pre>
</div>
</div>
<div class="paragraph">
<p>The most important files are clearly the SQLite databases (<code>collection.anki2</code> and <code>collection.media.db2</code>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">What is SQLite?</div>
<div class="paragraph">
<p>SQLite is a self-contained, zero-configuration, transactional SQL database engine. SQLite is not directly comparable to client/server SQL database engines such as MySQL, Oracle, PostgreSQL, or SQL Server since SQLite is trying to solve a different problem.</p>
</div>
<div class="paragraph">
<p>Client/server SQL database engines strive to implement a shared repository of enterprise data. They emphasis scalability, concurrency, centralization, and control. SQLite strives to provide local data storage for individual applications and devices. SQLite emphasizes economy, efficiency, reliability, independence, and simplicity.</p>
</div>
<div class="paragraph">
<p>So, SQLite does not compete with client/server databases. SQLite competes with <code>fopen()</code> and is particularly well adapted in these situations: as the datastore for an embedded devices, as an application file format (such as Anki), or as the main storage for a medium website or just as a file archive.</p>
</div>
<div class="paragraph">
<p>Refer to the <a href="https://www.sqlite.org/">official documentation</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist TIP">
<div class="title">apkg, anki2, what are these file extensions?</div>
<ul class="TIP">
<li>
<p>A <strong>anki2</strong> file is a DB2 database archive (SQLite).</p>
</li>
<li>
<p>A <strong>apkg file</strong> is just an archive (you could use 7zip or your favorite decompression utility to see its content) containing the anki2 file that we just described and a file media. This media file is a simple text file containing an empty JSON object. As mentioned inside the Preferences dialog, Medias are not backed up. We need to create a periodic backup of our Anki folder to be safe. If you use AnkiWeb, our media are already synchronized in the cloud but be careful, decks stored in your account may be archived and eventually deleted if they are not accessed for 3 months or longer. If you are not planning to study for a few months, the manual backup of the content on your own computer is still required.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To understand Anki, we need at least a basic understanding of how the data are organized. Let&#8217;s inspect the database to determine its schema and the different tables.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="anki_database_schema">Anki Database Schema</h3>
<div class="paragraph">
<p>The most complete "official" description of the database schema is available on GitHub under the Android application source:
<a href="https://github.com/ankidroid/Anki-Android/wiki/Database-Structure" class="bare">https://github.com/ankidroid/Anki-Android/wiki/Database-Structure</a></p>
</div>
<div class="paragraph">
<p>We will start from this description and complete where information is missing.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">How to inspect the Anki database?</div>
<div class="ulist">
<ul>
<li>
<p>Download the SQLite DB Browser: <a href="https://sqlitebrowser.org/" class="bare">https://sqlitebrowser.org/</a></p>
</li>
<li>
<p>Unzip the .apkg file that has been generated</p>
</li>
<li>
<p>Open the collection.anki2 with SQLiteBrowser (launch the executable on Windows) (be sure to consider all file extensions)</p>
</li>
<li>
<p>You should see a dialog like this:</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/sqlitebrowser-anki2-collection.png" alt="sqlitebrowser anki2 collection" width="750">
</div>
</div>
<div class="paragraph">
<p>What follows is the complete annotated schema. You could safely skim this part and use it as a reference. Note: the model in Python files is rarely documented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment">-- Cards are what you review.</span>
<span class="comment">-- There can be multiple cards for each note, as determined by the Template.</span>
<span class="class">CREATE</span> <span class="type">TABLE</span> cards (
    id              <span class="predefined-type">integer</span> <span class="directive">primary</span> <span class="type">key</span>,
    <span class="comment">-- The card id, could be generated randomly</span>
    <span class="comment">-- Anki uses the epoch milliseconds of when the card was created</span>

    nid             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- nodes.id</span>

    did             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- deck id (available in col table)</span>

    ord             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- ordinal : identifies which of the card templates it corresponds to</span>
    <span class="comment">-- valid values are from 0 to num templates - 1</span>
    <span class="comment">-- see the model JSON representation (field tmpls)</span>

    mod             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- modification time as epoch seconds</span>

    usn             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
     <span class="comment">-- update sequence number: used to do diffs when syncing with AnkiWeb</span>
     <span class="comment">-- value of -1 indicates changes that need to be pushed to server.</span>
     <span class="comment">--  usn &lt; server usn indicates changes that need to be pulled from server.</span>

    type            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- 0=new, 1=learning, 2=due</span>

    queue           <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Same as type, but -1=suspended, -2=user buried, -3=sched buried</span>

    due             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Due is used differently for different card types:</span>
    <span class="comment">--   new queue: note id or random int</span>
    <span class="comment">--   due/rev queue: integer day, relative to the collection's creation time</span>
    <span class="comment">--   learning queue: integer timestamp</span>

    ivl             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- interval (used in SRS algorithm). Negative = seconds, possitive = days</span>

    factor          <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- factor (used in SRS algorithm)</span>

    reps            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- The number of reviews (used in SRS algorithm)</span>

    lapses          <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- The number of times the card went from a &quot;was answered correctly&quot;</span>
    <span class="comment">-- to &quot;was answered incorrectly&quot; state (used in SRS algorithm)</span>

    <span class="keyword">left</span>            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- reps left till graduation (used in SRS algorithm)</span>

    odue            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- original due: only used when the card is currently in filtered deck</span>
    <span class="comment">-- (used in SRS algorithm)</span>

    odid            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- original did: only used when the card is currently in filtered deck</span>
    <span class="comment">-- (used in SRS algorithm)</span>

    flags           <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- currently unused (always 0)</span>

    data            <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>
    <span class="comment">-- currently unused (always empty string)</span>
)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment">-- The collection (contains one or many decks)</span>
<span class="comment">-- col contains a single row that holds various information about the collection</span>
<span class="class">CREATE</span> <span class="type">TABLE</span> col (
    id              <span class="predefined-type">integer</span> <span class="directive">primary</span> <span class="type">key</span>,
    <span class="comment">-- An integer identifier (1, 2, 3,...)</span>
    <span class="comment">-- arbitrary number since there is only one row</span>

    crt             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Creation date, timestamp in seconds</span>
    <span class="comment">-- (Ex: 1415070000 for the 2014, 4th November)</span>

    mod             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Modification date, timestamp in milliseconds.</span>
    <span class="comment">-- Last time you create a new card or study our flashcards.</span>
    <span class="comment">-- (Ex: 1466770067192 for the 2016, 24th June at 14:07)</span>

    scm             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Last schema modification date, timestamp in milliseconds</span>
    <span class="comment">-- If server scm is different from the client scm a full-sync is required</span>

    ver             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Schema version number of the record.</span>
    <span class="comment">-- Should be the same as constant SCHEMA_VERSION defined in anki/consts.py</span>

    dty             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- No longer used. Use 0.</span>

    usn             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- The update sequence number</span>

    ls              <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Last sync timestamp in ms.</span>

    conf            <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- json object containing configuration options that are synced</span>
    <span class="comment">-- see below</span>

    models          <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- json array of json objects containing the models (aka Note types)</span>
    <span class="comment">-- see below</span>

    decks           <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- json array of json objects containing the deck</span>
    <span class="comment">-- see below</span>

    dconf           <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- json array of json objects containing the deck options</span>
    <span class="comment">-- see below</span>

    tags            <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>
    <span class="comment">-- a cache of tags used in the collection (probably for autocomplete etc)</span>
    <span class="comment">-- see below</span>
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Field <code>conf</code> contains various deck configuration options used by the SRS algorithm:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">activeDecks</span><span class="delimiter">&quot;</span></span>: [<span class="integer">1</span>],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">curDeck</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">newSpread</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">collapseTime</span><span class="delimiter">&quot;</span></span>: <span class="integer">1200</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">timeLim</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">estTimes</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">dueCounts</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">curModel</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">nextPos</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">sortType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">noteFld</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">sortBackwards</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">addToCur</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whose definition follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">activeDecks</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">List of active decks</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">curDeck</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">decks.id of the deck to highlight when opening Anki</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">newSpread</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">whether new cards should be mixed with reviews, </span><span class="content">\
</span><span class="content">        or shown first or last: NEW_CARDS_DISTRIBUTE(0), NEW_CARDS_LAST(1),
        NEW_CARDS_FIRST(2)</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">collapseTime</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Used in SRS algorithm</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">timeLim</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Timeboxing limit when reviewing cards (0 =&gt; disabed)</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">estTimes</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Unused</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">dueCounts</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Unused</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">curModel</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Default model for new cards</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">nextPos</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Select max(due)+1 from cards where type = 0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">sortType</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">On which columns to sort when retrieving cards?</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">sortBackwards</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Should the order be reversed?</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">addToCur</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Add new to currently selected deck?</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Field <code>models</code> contains the JSON representation of a ModelManager (<code>anki/models.py</code>):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">1355577990691</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">vers</span><span class="delimiter">&quot;</span></span>: [],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1. Minimal Pairs</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">tags</span><span class="delimiter">&quot;</span></span>: [],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">did</span><span class="delimiter">&quot;</span></span>: <span class="integer">1382740944947</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">usn</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">req</span><span class="delimiter">&quot;</span></span>: [
         [<span class="integer">0</span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">any</span><span class="delimiter">&quot;</span></span>,[<span class="integer">0</span>,<span class="integer">1</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">4</span>,<span class="integer">6</span>,<span class="integer">7</span>]],
         [<span class="integer">1</span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">any</span><span class="delimiter">&quot;</span></span>,[<span class="integer">0</span>,<span class="integer">2</span>,<span class="integer">3</span>,<span class="integer">4</span>,<span class="integer">5</span>,<span class="integer">6</span>,<span class="integer">7</span>]],
         [<span class="integer">2</span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">all</span><span class="delimiter">&quot;</span></span>,[<span class="integer">8</span>]],
         [<span class="integer">3</span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">all</span><span class="delimiter">&quot;</span></span>,[<span class="integer">8</span>]],
         [<span class="integer">4</span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">all</span><span class="delimiter">&quot;</span></span>,[<span class="integer">8</span>,<span class="integer">12</span>]],
         [<span class="integer">5</span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">all</span><span class="delimiter">&quot;</span></span>,[<span class="integer">8</span>,<span class="integer">12</span>]]
      ],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">flds</span><span class="delimiter">&quot;</span></span>: [
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Word 1</span><span class="delimiter">&quot;</span></span>,                    <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">0</span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Recording 1</span><span class="delimiter">&quot;</span></span>,               <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Word 1 IPA</span><span class="delimiter">&quot;</span></span>,                <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Word 1 English</span><span class="delimiter">&quot;</span></span>,            <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">3</span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Word 2</span><span class="delimiter">&quot;</span></span>,                    <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">4</span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Recording 2</span><span class="delimiter">&quot;</span></span>,               <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">5</span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Word 2 IPA</span><span class="delimiter">&quot;</span></span>,                <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">6</span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Word 2 English</span><span class="delimiter">&quot;</span></span>,            <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">7</span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Word 3</span><span class="delimiter">&quot;</span></span>,                    <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">8</span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Recording 3</span><span class="delimiter">&quot;</span></span>,               <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">9</span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Word 3 IPA</span><span class="delimiter">&quot;</span></span>,                <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">10</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Word 3 English</span><span class="delimiter">&quot;</span></span>,            <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">11</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> },
         { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Compare Word 2 to Word 3?</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>:[], <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>:<span class="integer">12</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Arial</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>:<span class="integer">20</span> }
      ],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">sortf</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">tmpls</span><span class="delimiter">&quot;</span></span>: [
         {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Card 1</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">qfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;i&gt;Do you hear&lt;/i&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="content">&lt;div class=container&gt;</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 1}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 1 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 1 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=or&gt;&lt;i&gt; or &lt;/i&gt;&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 2}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 2 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 2 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;br&gt;{{Recording 1}} </span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">did</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bafmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">afmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">{{FrontSide}}</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;hr id=answer&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">You heard: &lt;div class=box&gt;{{Word 1}}&lt;/div&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">{{Recording 1}}</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bqfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
         },
         {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Card 2</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">qfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;i&gt;Do you hear&lt;/i&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="content">&lt;div class=container&gt;</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 1}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 1 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 1 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=or&gt;&lt;i&gt; or &lt;/i&gt;&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 2}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 2 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 2 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;br&gt;{{Recording 2}} </span><span class="char">\n</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">did</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bafmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">afmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">{{FrontSide}}</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;hr id=answer&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">You heard: &lt;div class=box&gt;{{Word 2}}&lt;/div&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="content">{{Recording 2}}</span><span class="char">\n</span><span class="content">  </span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bqfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
         },
         {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Card 3</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">qfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">{{#Word 3}}</span><span class="char">\n</span><span class="content">&lt;i&gt;Do you hear&lt;/i&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="content">&lt;div class=container&gt;</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 1}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 1 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 1 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=or&gt;&lt;i&gt; or &lt;/i&gt;&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 3}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 3 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 3 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;br&gt;{{Recording 3}} </span><span class="char">\n</span><span class="content">{{/Word 3}}</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">did</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bafmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">afmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">{{FrontSide}}</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;hr id=answer&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">You heard: &lt;div class=box&gt;{{Word 3}}&lt;/div&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">{{Recording 3}}</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>: <span class="integer">2</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bqfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
         },
         {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Card 4</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">qfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">{{#Word 3}}</span><span class="char">\n</span><span class="content">&lt;i&gt;Do you hear&lt;/i&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="content">&lt;div class=container&gt;</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 1}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 1 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 1 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=or&gt;&lt;i&gt; or &lt;/i&gt;&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 3}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 3 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 3 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;br&gt;{{Recording 1}} </span><span class="char">\n</span><span class="content">{{/Word 3}}</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">did</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bafmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">afmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">{{FrontSide}}</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;hr id=answer&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">You heard: &lt;div class=box&gt;{{Word 1}}&lt;/div&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">{{Recording 1}}</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>: <span class="integer">3</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bqfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
         },
         {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Card 5</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">qfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">{{#Compare Word 2 to Word 3?}}</span><span class="char">\n</span><span class="content">{{#Word 3}}</span><span class="char">\n</span><span class="content">&lt;i&gt;Do you hear&lt;/i&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="content">&lt;div class=container&gt;</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 2}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 2 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 2 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=or&gt;&lt;i&gt; or &lt;/i&gt;&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 3}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 3 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 3 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;br&gt;{{Recording 2}} </span><span class="char">\n</span><span class="content">{{/Word 3}}</span><span class="char">\n</span><span class="content">{{/Compare Word 2 to Word 3?}}</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">did</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bafmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">afmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">{{FrontSide}}</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;hr id=answer&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">You heard: &lt;div class=box&gt;{{Word 2}}&lt;/div&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">{{Recording 2}}</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>: <span class="integer">4</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bqfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
         },
         {
            <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Card 6</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">qfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">{{#Compare Word 2 to Word 3?}}</span><span class="char">\n</span><span class="content">{{#Word 3}}</span><span class="char">\n</span><span class="content">&lt;i&gt;Do you hear&lt;/i&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="content">&lt;div class=container&gt;</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 2}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 2 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 2 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=or&gt;&lt;i&gt; or &lt;/i&gt;&lt;/div&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;div class=box&gt;{{Word 3}}</span><span class="char">\n</span><span class="content">&lt;span class=ipa&gt;[{{Word 3 IPA}}]&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;span class=translation&gt;{{Word 3 English}}&lt;/span&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;/div&gt;</span><span class="char">\n</span><span class="content">&lt;br&gt;{{Recording 3}} </span><span class="char">\n</span><span class="content">{{/Word 3}}</span><span class="char">\n</span><span class="content">{{/Compare Word 2 to Word 3?}}</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">did</span><span class="delimiter">&quot;</span></span>: <span class="value">null</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bafmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">afmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">{{FrontSide}}</span><span class="char">\n</span><span class="char">\n</span><span class="content">&lt;hr id=answer&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">You heard: &lt;div class=box&gt;{{Word 3}}&lt;/div&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;</span><span class="char">\n</span><span class="char">\n</span><span class="content">{{Recording 3}}</span><span class="delimiter">&quot;</span></span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>: <span class="integer">5</span>,
            <span class="key"><span class="delimiter">&quot;</span><span class="content">bqfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
         }
      ],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">mod</span><span class="delimiter">&quot;</span></span>: <span class="integer">1466769421</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">latexPost</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">end{document}</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="integer">1355577990691</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">css</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">.card {</span><span class="char">\n</span><span class="content"> font-family: arial;</span><span class="char">\n</span><span class="content"> font-size: 20px;</span><span class="char">\n</span><span class="content"> text-align: center;</span><span class="char">\n</span><span class="content"> color: black;</span><span class="char">\n</span><span class="content"> background-color: white;</span><span class="char">\n</span><span class="content">}</span><span class="char">\n</span><span class="content">.box {</span><span class="char">\n</span><span class="content"> display:inline-block;</span><span class="char">\n</span><span class="content">border:2px solid black;</span><span class="char">\n</span><span class="content">padding:5px;</span><span class="char">\n</span><span class="content">font-size:1.4em</span><span class="char">\n</span><span class="content">}</span><span class="char">\n</span><span class="char">\n</span><span class="content">.ipa {</span><span class="char">\n</span><span class="content">font-size:0.7em;</span><span class="char">\n</span><span class="content">display:block;</span><span class="char">\n</span><span class="content">color:blue;</span><span class="char">\n</span><span class="content">padding:0 0 5px 0px;</span><span class="char">\n</span><span class="content">}</span><span class="char">\n</span><span class="char">\n</span><span class="content">.container {</span><span class="char">\n</span><span class="content">border:0px solid;</span><span class="char">\n</span><span class="content">display:table;</span><span class="char">\n</span><span class="content">margin:auto;</span><span class="char">\n</span><span class="content">}</span><span class="char">\n</span><span class="char">\n</span><span class="content">.or {</span><span class="char">\n</span><span class="content">display:table-cell;</span><span class="char">\n</span><span class="content">vertical-align:middle;</span><span class="char">\n</span><span class="content">padding:0 10px</span><span class="char">\n</span><span class="content">}</span><span class="char">\n</span><span class="content">.translation {</span><span class="char">\n</span><span class="content">font-size:0.6em;</span><span class="char">\n</span><span class="content">display:block;</span><span class="char">\n</span><span class="content">color:gray;</span><span class="char">\n</span><span class="content">}</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">latexPre</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">documentclass[12pt]{article}</span><span class="char">\n</span><span class="char">\\</span><span class="content">special{papersize=3in,5in}</span><span class="char">\n</span><span class="char">\\</span><span class="content">usepackage{amssymb,amsmath}</span><span class="char">\n</span><span class="char">\\</span><span class="content">pagestyle{empty}</span><span class="char">\n</span><span class="char">\\</span><span class="content">setlength{</span><span class="char">\\</span><span class="content">parindent}{0in}</span><span class="char">\n</span><span class="char">\\</span><span class="content">begin{document}</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whose definition follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">css</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">CSS, shared for all templates</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">did</span><span class="delimiter">&quot;</span></span>:
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Long specifying the id of the deck that cards are added to by default</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">flds</span><span class="delimiter">&quot;</span></span>: [
       <span class="string"><span class="delimiter">&quot;</span><span class="content">JSONArray containing object for each field in the model as follows:</span><span class="delimiter">&quot;</span></span>,
       {
         <span class="key"><span class="delimiter">&quot;</span><span class="content">font</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">display font</span><span class="delimiter">&quot;</span></span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">array of media. appears to be unused</span><span class="delimiter">&quot;</span></span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">field name</span><span class="delimiter">&quot;</span></span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ordinal of the field - goes from 0 to num fields -1</span><span class="delimiter">&quot;</span></span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">rtl</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">boolean, right-to-left script</span><span class="delimiter">&quot;</span></span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">size</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">font size</span><span class="delimiter">&quot;</span></span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">sticky</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">sticky fields retain the value that was last added </span><span class="content">\
</span><span class="content">                    when adding new notes</span><span class="delimiter">&quot;</span></span>
      }
    ],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">model ID, matches cards.mid</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">latexPost</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">String added to end of LaTeX expressions</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">latexPre</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">preamble for LaTeX expressions</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">mod</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">modification time in milliseconds</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">model name</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">req</span><span class="delimiter">&quot;</span></span>: [
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Array of arrays describing which fields are required </span><span class="content">\
</span><span class="content">       for each card to be generated</span><span class="delimiter">&quot;</span></span>,
      [
        <span class="string"><span class="delimiter">&quot;</span><span class="content">array index, 0, 1, ...</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">? string, all</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">another array</span><span class="delimiter">&quot;</span></span>,
        [<span class="string"><span class="delimiter">&quot;</span><span class="content">appears to be the array index again</span><span class="delimiter">&quot;</span></span>]
      ]
    ],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">sortf</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Integer specifying which field is used for sorting (browser)</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">tags</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Anki saves the tags of the last added note to the current model</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">tmpls</span><span class="delimiter">&quot;</span></span>: [
      <span class="string"><span class="delimiter">&quot;</span><span class="content">JSONArray containing object of CardTemplate for each card in model</span><span class="delimiter">&quot;</span></span>,
      {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">afmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">answer template string</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">bafmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">browser answer format: used for displaying answer in browser</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">bqfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">browser question format: </span><span class="content">\
</span><span class="content">                  used for displaying question in browser</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">did</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">deck override (null by default)</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">template name</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">ord</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">template number, see flds</span><span class="delimiter">&quot;</span></span>,
        <span class="key"><span class="delimiter">&quot;</span><span class="content">qfmt</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">question format string</span><span class="delimiter">&quot;</span></span>
      }
    ],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Integer specifying what type of model. 0 for standard, 1 for cloze</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">usn</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Update sequence number: used in same way as other usn vales in db</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">vers</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Legacy version number (unused)</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Field <code>decks</code> contains the JSON representation of a DeckManager (anki/decks.py). One key-value for each deck present in this collection:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Default</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">extendRev</span><span class="delimiter">&quot;</span></span>: <span class="integer">50</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">usn</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">collapsed</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">browserCollapsed</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">newToday</span><span class="delimiter">&quot;</span></span>: [<span class="integer">598</span>,<span class="integer">0</span>],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">timeToday</span><span class="delimiter">&quot;</span></span>: [<span class="integer">598</span>,<span class="integer">0</span>],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">dyn</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">extendNew</span><span class="delimiter">&quot;</span></span>: <span class="integer">10</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">conf</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">revToday</span><span class="delimiter">&quot;</span></span>: [<span class="integer">598</span>,<span class="integer">0</span>],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">lrnToday</span><span class="delimiter">&quot;</span></span>: [<span class="integer">598</span>,<span class="integer">0</span>],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">mod</span><span class="delimiter">&quot;</span></span>: <span class="integer">1417423954</span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whose definition follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">name of deck</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">extendRev</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">extended review card limit (for custom study)</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">collapsed</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">true when deck is collapsed</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">usn</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Update sequence number: used in same way as other usn vales in db</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">browserCollapsed</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">true when deck collapsed in browser</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">newToday</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">two number array used somehow for custom study</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">timeToday</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">two number array used somehow for custom study</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">dyn</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1 if dynamic (AKA filtered) deck</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">extendNew</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">extended new card limit (for custom study)</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">conf</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">id of option group from dconf in `col` table</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">revToday</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">two number array used somehow for custom study</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">lrnToday</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">two number array used somehow for custom study</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">deck ID (automatically generated long)</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">mod</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">last modification time</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">deck description</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Field <code>dconf</code> contains the JSON representation of a Deck Configuration:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/deck-configuration.png" alt="deck configuration">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>: {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Default</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">maxTaken</span><span class="delimiter">&quot;</span></span>: <span class="integer">60</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">timer</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">autoplay</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">replayq</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">dyn</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">usn</span><span class="delimiter">&quot;</span></span>: <span class="integer">47</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">mod</span><span class="delimiter">&quot;</span></span>: <span class="integer">1419273593</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">new</span><span class="delimiter">&quot;</span></span>: {
         <span class="key"><span class="delimiter">&quot;</span><span class="content">delays</span><span class="delimiter">&quot;</span></span>: [<span class="integer">1</span>,<span class="integer">10</span>],
         <span class="key"><span class="delimiter">&quot;</span><span class="content">order</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">perDay</span><span class="delimiter">&quot;</span></span>: <span class="integer">1000</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">ints</span><span class="delimiter">&quot;</span></span>: [<span class="integer">1</span>,<span class="integer">4</span>,<span class="integer">7</span>],
         <span class="key"><span class="delimiter">&quot;</span><span class="content">initialFactor</span><span class="delimiter">&quot;</span></span>: <span class="integer">2500</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">bury</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">separate</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>
      },
      <span class="key"><span class="delimiter">&quot;</span><span class="content">rev</span><span class="delimiter">&quot;</span></span>: {
         <span class="key"><span class="delimiter">&quot;</span><span class="content">perDay</span><span class="delimiter">&quot;</span></span>: <span class="integer">100</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">ease4</span><span class="delimiter">&quot;</span></span>: <span class="float">1.3</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">ivlFct</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">maxIvl</span><span class="delimiter">&quot;</span></span>: <span class="integer">36500</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">bury</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">minSpace</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">fuzz</span><span class="delimiter">&quot;</span></span>: <span class="float">0.05</span>
      },
      <span class="key"><span class="delimiter">&quot;</span><span class="content">lapse</span><span class="delimiter">&quot;</span></span>: {
         <span class="key"><span class="delimiter">&quot;</span><span class="content">delays</span><span class="delimiter">&quot;</span></span>: [<span class="integer">10</span>],
         <span class="key"><span class="delimiter">&quot;</span><span class="content">mult</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">minInt</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">leechFails</span><span class="delimiter">&quot;</span></span>: <span class="integer">8</span>,
         <span class="key"><span class="delimiter">&quot;</span><span class="content">leechAction</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>
      }
   }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Field <code>tags</code> contains the JSON representation of TagManager (anki/tags.py). Contains all tags in the collection with the usn number. (see above):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Web</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Git</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Java</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">vi</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Hadoop</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Productivity</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Python</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Refactoring</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">ElasticSearch</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Bash</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Training</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Eclipse</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Gradle</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Craftsmanship</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Patterns</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Spring</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Memory</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Concurrency</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">Algorithms</span><span class="delimiter">&quot;</span></span>: <span class="integer">336</span>,
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment">-- Deletion log (content of the file deleted.txt in your Anki home directory)</span>
<span class="comment">-- Contains deleted cards, notes, and decks that need to be synced.</span>
<span class="comment">-- usn ,</span>
<span class="comment">-- oid is the original id.</span>
<span class="comment">-- type: 0 for a card, 1 for a note and 2 for a deck</span>
<span class="class">CREATE</span> <span class="type">TABLE</span> graves (
    usn             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- should be set to -1</span>

    oid             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- original id of the Card/Note/Deck</span>

    type            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>
    <span class="comment">-- type: 0 for a card, 1 for a note and 2 for a deck</span>
)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment">-- Notes contain the raw information that is formatted into a number of cards</span>
<span class="comment">-- according to the models</span>
<span class="class">CREATE</span> <span class="type">TABLE</span> notes (
    id              <span class="predefined-type">integer</span> <span class="directive">primary</span> <span class="type">key</span>,
    <span class="comment">-- The note id, epoch seconds of when the note was created</span>

    guid            <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- A globally unique identifier (G8c7ZUgMvt) generated randomly,</span>
    <span class="comment">-- almost certainly used for syncing</span>

    mid             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- The model id</span>

    mod             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Modification timestamp, epoch seconds</span>

    usn             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- update sequence number: for finding diffs when syncing with AnkiWeb.</span>
    <span class="comment">-- See the description in the cards table for more info</span>

    tags            <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- A space-separated list of tags</span>
    <span class="comment">-- includes space at the beginning and end, for LIKE &quot;% tag %&quot; queries</span>

    flds            <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- the values of the fields in this note. separated by 0x1f (31) character.</span>
    <span class="comment">-- For example, contains: &lt;question&gt;\x1f&lt;answer&gt;.</span>

    sfld            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- sort field: used for quick sorting and duplicate check</span>
    <span class="comment">-- The value of the field having the index 'sortf' as defined by the model</span>

    csum            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Field checksum used for duplicate check.</span>
    <span class="comment">-- 32 bits unsigned integer of the first 8 digits of sha1 hash</span>
    <span class="comment">-- of the first field of the note</span>

    flags           <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- unused. Always 0</span>

    data            <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>
    <span class="comment">-- unused. Always an empty string</span>
)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment">-- revlog is a review history; it has a row for every review you've ever done!</span>
<span class="class">CREATE</span> <span class="type">TABLE</span> revlog (
    id              <span class="predefined-type">integer</span> <span class="directive">primary</span> <span class="type">key</span>,
    <span class="comment">-- Epoch-seconds timestamp of when you did the review.</span>
    <span class="comment">-- Initialized to &quot;int(time.time()*1000)&quot;</span>

    cid             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- cards.id</span>

    usn             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- The update sequence number of the collection: for finding diffs</span>
    <span class="comment">-- See the description in the cards table for more info</span>

    ease            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Which button you pushed to score your recall.</span>
    <span class="comment">-- 1(wrong), 2(hard), 3(ok), 4(easy)</span>

    ivl             <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Interval. Used by SRS algorithm</span>

    lastIvl         <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Last Interval. Used by SRS algorithm</span>

    factor          <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- Factor. Used by SRS algorithm</span>

    <span class="predefined-type">time</span>            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- How many milliseconds your review took, up to 60000 (60s)</span>

    type            <span class="predefined-type">integer</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>
    <span class="comment">-- 0=lrn, 1=rev, 2=relrn, 3=cram</span>
)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="anki_media_database_schema">Anki Media Database Schema</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> media (
    fname <span class="predefined-type">text</span> <span class="keyword">not</span> <span class="predefined-constant">null</span> <span class="directive">primary</span> <span class="type">key</span>,
    <span class="comment">-- The filename relative (no path, filename is always relative</span>
    <span class="comment">-- to media directory)</span>

    csum <span class="predefined-type">text</span>,
    <span class="comment">-- SHA1 hash on the media file content (null indicates deleted file)</span>

    mtime <span class="predefined-type">int</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>,
    <span class="comment">-- mtime of media file. Zero if deleted</span>

    dirty <span class="predefined-type">int</span> <span class="keyword">not</span> <span class="predefined-constant">null</span>
    <span class="comment">-- 0 if file up-to-date</span>
)

<span class="comment">-- Only one row present</span>
<span class="class">CREATE</span> <span class="type">TABLE</span> meta (
    dirMod <span class="predefined-type">int</span>,
    <span class="comment">-- _mtime of the folder containing the media</span>

    lastUsn <span class="predefined-type">int</span>
    <span class="comment">-- Last synch update timestamp concerning the media folder only</span>
    <span class="comment">-- (different from Cards USN)</span>
)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="step_by_step">Step by Step</h3>
<div class="paragraph">
<p>In this part, we will create through the GUI a new deck and add a new card. We use a fresh anki installation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">How to inspect database changes when using Anki?</div>
<div class="paragraph">
<p>We could use the sqlite CLI to generate a dump before and after each operation executed through the Anki Desktop application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download the executable : <a href="https://www.sqlite.org/download.html" class="bare">https://www.sqlite.org/download.html</a> (make sure that the mention "including the command-line shell program" is present on the binary description).</p>
</li>
<li>
<p>Place the <code>sqlite3.exe</code> along your <code>collection.anki2</code> file.</p>
</li>
<li>
<p>Open an interpreter prompt (<code>cmd</code> on Windows)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ sqlite3 collection.anki2
sqlite&gt;.databases
seq name  file
--- ----- --------------------
0   main  C:\collection.anki2
sqlite&gt;.once dump.sql
sqlite&gt;.dump</pre>
</div>
</div>
<div class="paragraph">
<p>By default, sqlite3 sends query results to standard output. So, we use the ".once" command to redirect query results to a file.
(Use the ".output" option to redirect all commands and not just the next one). Check the official documentation for help about the CLI options: <a href="https://www.sqlite.org/cli.html" class="bare">https://www.sqlite.org/cli.html</a></p>
</div>
<div class="paragraph">
<p>Finally, we can use the generated dumps to compare the data and determine what was exactly updated by Anki.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To force Anki to use a fresh installation, we will override the folder location to point to an empty directory (see <a href="https://ankisrs.net/docs/manual.html#startupopts" class="bare">https://ankisrs.net/docs/manual.html#startupopts</a> for more information about the option <code>-b</code>).</p>
</div>
<div class="paragraph">
<p>On Windows, just click right on the icon and update the target field to add the option. Ex:
<code>"C:\Program Files (x86)\Anki\anki.exe" -b "D:\AnkiTmp"</code></p>
</div>
<div class="paragraph">
<p>Relaunch Anki, select your language, and the home screen should appear, containing only the deck "Default":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/anki-home.png" alt="anki home">
</div>
</div>
<div class="paragraph">
<p>By default, Anki creates a default collection. This is the only row present in database at first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">col</span><span class="delimiter">&quot;</span></span>
  (id, crt, mod, scm, ver, dty, usn, ls, conf, models, decks, dconf, tags)
  <span class="keyword">VALUES</span> (
    <span class="integer">1</span>,
    <span class="integer">1468375200</span>,
    <span class="integer">1468406322822</span>,
    <span class="integer">1468406322821</span>,
    <span class="integer">11</span>,
    <span class="integer">0</span>,
    <span class="integer">0</span>,
    <span class="integer">0</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">{&quot;id&quot;: 1, &quot;mod&quot;: 0, &quot;curDeck&quot;: 1, &quot;dueCounts&quot;: true, ... }</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">{}</span><span class="delimiter">'</span></span>
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try to create a new deck.</p>
</div>
<div class="sect3">
<h4 id="deck_creation">Deck creation</h4>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/anki-new_deck.png" alt="anki new deck">
</div>
</div>
<div class="paragraph">
<p>Internally Anki just update the default collection to add the new deck in the <code>dconf</code> field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>:             { <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Default</span><span class="delimiter">&quot;</span></span> <span class="error">.</span><span class="error">.</span><span class="error">.</span> }
  <span class="key"><span class="delimiter">&quot;</span><span class="content">1468406431488</span><span class="delimiter">&quot;</span></span>: {<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">French</span><span class="delimiter">&quot;</span></span>,  <span class="error">.</span><span class="error">.</span><span class="error">.</span> }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code: (<code>aqt/deckbrowser.py#53</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">deck = getOnlyText(_(<span class="string"><span class="delimiter">&quot;</span><span class="content">Name for deck:</span><span class="delimiter">&quot;</span></span>))
<span class="keyword">if</span> deck:
    <span class="predefined-constant">self</span>.mw.col.decks.id(deck)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And in <code>anki/decks.py#125</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">id</span>(<span class="predefined-constant">self</span>, name, create=<span class="predefined-constant">True</span>, type=defaultDeck):
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Add a deck with NAME. Reuse deck if already exists. Return id as int.</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="card_creation">Card creation</h4>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/anki-new_card.png" alt="anki new card">
</div>
</div>
<div class="paragraph">
<p>Anki updates the collection to add the new tag (field <code>tags</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">UPDATE</span> col <span class="class">SET</span> tags = <span class="string"><span class="delimiter">'</span><span class="content">{&quot;vocabulary&quot;: -1}</span><span class="delimiter">'</span></span> <span class="keyword">WHERE</span> id = <span class="integer">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(<code>-1</code> is used to tell Anki to synchronize this tag with the server on the next synchronization with AnkiWeb)</p>
</div>
<div class="paragraph">
<p>Anki inserts a new row in the table <code>notes</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">notes</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">VALUES</span>(
    <span class="integer">1468406595423</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">c}s`dBG4e-</span><span class="delimiter">'</span></span>,
    <span class="integer">1468406557944</span>,
    <span class="integer">1468406609</span>,
    <span class="integer">-1</span>,
    <span class="string"><span class="delimiter">'</span><span class="content"> vocabulary </span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">Pain Bread</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">Pain</span><span class="delimiter">'</span></span>,
    <span class="integer">2687916407</span>,
    <span class="integer">0</span>,
    <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>
  );</code></pre>
</div>
</div>
<div class="paragraph">
<p>And a new row in the table <code>cards</code> as it is a Basic card:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">cards</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">VALUES</span>(
    <span class="integer">1468406609380</span>,
    <span class="integer">1468406595423</span>,
    <span class="integer">1468406570134</span>,
    <span class="integer">0</span>,
    <span class="integer">1468406609</span>,
    <span class="integer">-1</span>,<span class="integer">0</span>,<span class="integer">0</span>,<span class="integer">1</span>,<span class="integer">0</span>,<span class="integer">0</span>,<span class="integer">0</span>,<span class="integer">0</span>,<span class="integer">0</span>,<span class="integer">0</span>,<span class="integer">0</span>,<span class="integer">0</span>,<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code: (<code>aqt/addcards.py</code>)</p>
</div>
<div class="paragraph">
<p>On dialog opening:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, mw):
    f = <span class="predefined-constant">self</span>.mw.col.newNote()
    <span class="predefined-constant">self</span>.editor.setNote(f, focus=<span class="predefined-constant">True</span>)

When clicking on the Add button:

<span class="keyword">def</span> <span class="function">addCards</span>(<span class="predefined-constant">self</span>):
    <span class="predefined-constant">self</span>.editor.saveTags()
    <span class="predefined-constant">self</span>.editor.saveAddModeVars()
    note = <span class="predefined-constant">self</span>.editor.note
    note = <span class="predefined-constant">self</span>.addNote(note)

<span class="keyword">def</span> <span class="function">saveTags</span>(<span class="predefined-constant">self</span>):
    <span class="predefined-constant">self</span>.note.tags = <span class="predefined-constant">self</span>.mw.col.tags.canonify(
        <span class="predefined-constant">self</span>.mw.col.tags.split(<span class="predefined-constant">self</span>.tags.text()))
    <span class="predefined-constant">self</span>.tags.setText(<span class="predefined-constant">self</span>.mw.col.tags.join(<span class="predefined-constant">self</span>.note.tags).strip())

<span class="keyword">def</span> <span class="function">saveAddModeVars</span>(<span class="predefined-constant">self</span>):
    <span class="comment"># save tags to model</span>
    m = <span class="predefined-constant">self</span>.note.model()
    m[<span class="string"><span class="delimiter">'</span><span class="content">tags</span><span class="delimiter">'</span></span>] = <span class="predefined-constant">self</span>.note.tags
    <span class="predefined-constant">self</span>.mw.col.models.save(m)

<span class="keyword">def</span> <span class="function">addNote</span>(<span class="predefined-constant">self</span>, note):
    note.model()[<span class="string"><span class="delimiter">'</span><span class="content">did</span><span class="delimiter">'</span></span>] = <span class="predefined-constant">self</span>.deckChooser.selectedId()
    cards = <span class="predefined-constant">self</span>.mw.col.addNote(note)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>anki/collection.py</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">addNote</span>(<span class="predefined-constant">self</span>, note):
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Add a note to the collection. Return number of new cards.</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try a card of type "Reversed":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/anki-new_reversed_card.png" alt="anki new reversed card">
</div>
</div>
<div class="paragraph">
<p>Adding a reversed card does not change anything in the UI code. The only difference is that the previous method <code>addNode</code> defined in <code>collection.py</code> will returned two cards instead of one in our first example. In database, two rows will be added in the table <code>cards</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">notes</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">VALUES</span>(<span class="integer">1468406642317</span>,<span class="string"><span class="delimiter">'</span><span class="content">OfSY=ipt]-</span><span class="delimiter">'</span></span>,<span class="integer">1468406557940</span>,<span class="integer">1468406643</span>,
         <span class="integer">-1</span>,<span class="string"><span class="delimiter">'</span><span class="content"> vocabulary </span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">Car Voiture</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">Car</span><span class="delimiter">'</span></span>,<span class="integer">3158811612</span>,<span class="integer">0</span>,<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>);
<span class="class">INSERT</span> <span class="class">INTO</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">cards</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">VALUES</span>(<span class="integer">1468406643702</span>,<span class="integer">1468406642317</span>,<span class="integer">1468406570134</span>,<span class="integer">0</span>,...);
<span class="class">INSERT</span> <span class="class">INTO</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">cards</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">VALUES</span>(<span class="integer">1468406643703</span>,<span class="integer">1468406642317</span>,<span class="integer">1468406570134</span>,<span class="integer">1</span>,...);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="studying">Studying</h4>
<div class="paragraph">
<p>Studying is the act of reviewing our previously created card. After each review, the SRS algorithm runs to reschedule the card. The metadata required by the algorithm is updated to reflect the new due date.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/anki-study.png" alt="anki study">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/anki-study_card.png" alt="anki study card">
</div>
</div>
<div class="paragraph">
<p>For this card, we choose the second button, to study again the card in 10 minutes from now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">UPDATE</span> cards
<span class="class">SET</span> type   = <span class="integer">1</span>          <span class="comment">-- new =&gt; learning</span>
    queue  = <span class="integer">1</span>          <span class="comment">-- new queue =&gt; learning queue</span>
    due    = <span class="integer">1468407304</span> <span class="comment">-- now + 10 minutes</span>
    ivl    = <span class="integer">0</span>          <span class="comment">-- 1 day</span>
    reps   = <span class="integer">1</span>          <span class="comment">-- We just did the first review!</span>
    lapses = <span class="integer">0</span>          <span class="comment">-- We don't have forgot the answer</span>
    <span class="keyword">left</span>   = <span class="integer">1001</span>       <span class="comment">-- 1001 repetitions left till graduation</span>
<span class="keyword">WHERE</span> id = <span class="integer">1468406609380</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We register the review in the table <code>revlog</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">revlog</span><span class="delimiter">&quot;</span></span> (id, cid, usn, ease, ivl, lastIvl, factor, <span class="predefined-type">time</span>, type)
    <span class="keyword">VALUES</span>(
        <span class="integer">1468406665035</span>,
        <span class="integer">1468406609380</span>, <span class="comment">-- card id</span>
        <span class="integer">-1</span>,            <span class="comment">-- to send on next synchronization</span>
        <span class="integer">2</span>,             <span class="comment">--
        -600,          -- negative = second (10 minutes)</span>
        <span class="integer">-60</span>,           <span class="comment">-- last ivl was 1 minutes</span>
        <span class="integer">0</span>,
        <span class="integer">2016</span>,          <span class="comment">-- 2 seconds to answer</span>
        <span class="integer">0</span>              <span class="comment">-- learning</span>
    );</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the code: (<code>aqt/reviewer.py#259</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">_answerCard</span>(<span class="predefined-constant">self</span>, ease):
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Reschedule card and show next.</span><span class="delimiter">&quot;</span></span>
    <span class="predefined-constant">self</span>.mw.col.sched.answerCard(<span class="predefined-constant">self</span>.card, ease)
    <span class="predefined-constant">self</span>.mw.autosave()
    <span class="predefined-constant">self</span>.nextCard()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>answerCard</code> is defined in <code>anki/sched.py#58</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">answerCard</span>(<span class="predefined-constant">self</span>, card, ease):
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Entry point to the SRS algorithm</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>anki/collection.py#136</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">autosave</span>(<span class="predefined-constant">self</span>):
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Save if 5 minutes has passed since last save.</span><span class="delimiter">&quot;</span></span>
    <span class="keyword">if</span> time.time() - <span class="predefined-constant">self</span>._lastSave &gt; <span class="integer">300</span>:
        <span class="predefined-constant">self</span>.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method <code>autosave</code> explain why Anki need to synchronize when we quit the application. Anki does not save systematically after each command but wait 5 minutes between two saves to minimize the interaction with the database.</p>
</div>
<div class="paragraph">
<p>This marks the end of the reverse engineering of Anki. We have seen how Anki works under the hood&#8201;&#8212;&#8201;when we add a new deck or a new card and what happens when we study. We understand the database schema and have a better comprehension of the internal API of Anki.</p>
</div>
<div class="paragraph">
<p>In the next part, we are going to use this knowledge to create programmatically flashcards in record time, without interacting with the Anki application!</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="anki_scripting_background">Anki Scripting Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Creating a flashcard is the first step to learn something new. To make it more memorable, you could customize the content of your flashcard: add a sound with the pronunciation of a new word, add a funny picture, and so one. Therefore, creating flashcards manually is important. But creating flashcards through the UI is also time-consuming in some cases. What if we need to create thousands of flashcards to learn the 5000 most common words in a new language?</strong></p>
</div>
<div class="sect2">
<h3 id="introduction">Introduction</h3>
<div class="paragraph">
<p>Anki is an open-source solution, published on GitHub. The code source is accessible to anyone going on the repository. With minimal programming skills, it is easy to script Anki to add new flashcards. Several options are possible:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Insert data directly in the SQLite database used by Anki</p>
</li>
<li>
<p>Write a Python program using the internal API of Anki</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This post will concentrate on the second option. The first option could be implemented based on the information published in the first part but is not the optimal solution (high coupling, necessity to specify all fields when most of them are irrelevant). This solution was already partially <a href="https://decks.wikia.com/wiki/Anki_APKG_format_documentation">documented online</a>. The Python solution is more powerful. You could use a Python module to read a PDF or an Epub and generate the associated flashcards. You could use the Google Images API to retrieve funny pictures to integrate in our flashcards. The only limit is our imagination.</p>
</div>
</div>
<div class="sect2">
<h3 id="python_scripting">Python Scripting</h3>
<div class="paragraph">
<p>The Anki source is not intended to be reused in other program so the code is not packaged as a Python module we could install as easily as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ pip install anki
# Doesn't work</pre>
</div>
</div>
<div class="paragraph">
<p>One solution is to clone the official repository and put our code along the Anki code source but this solution is not optimal. To decouple our code from the Anki Source, a better strategy is to use a Git submodule.</p>
</div>
<div class="paragraph">
<p>First, create new project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git init anki-scripting
$ cd anki-scripting/</pre>
</div>
</div>
<div class="paragraph">
<p>Clone Anki using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git submodule add https://github.com/dae/anki.git
Cloning into 'anki'...
remote: Counting objects: 4890, done.
remote: Total 4890 (delta 0), reused 0 (delta 0), pack-reused 4890
Receiving objects: 100% (4890/4890), 2.09 MiB | 1.41 MiB/s, done.
Resolving deltas: 100% (3374/3374), done.
Checking connectivity... done.
$ ls
anki</pre>
</div>
</div>
<div class="paragraph">
<p>Then, we need to download Anki dependencies. In this post, we will use <a href="https://pypi.python.org/pypi/pip">Pip</a>, the classic tool for installing Python packages. To avoid polluting existing Python projects you could have in local, we will use <a href="https://virtualenv.pypa.io/en/stable/">virtualenv</a>. The recommended way to do that in Python is to use virtualenv to isolate our project from other projects, so two projects could depend on conflicting versions of the same dependency. To install virtualenv globally, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ sudo pip install virtualenv</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>virtualenv</strong> is probably the only dependency you need to install globally when doing Python. Once installed, add a new virtual environment to each Python project, so their dependencies get installed under their directory.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At the root of the repository, execute the following command to create a new virtual environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ virtualenv venv
$ source venv/bin/activate</pre>
</div>
</div>
<div class="paragraph">
<p>When you need to switch to another project, just run the commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ deactivate  # added by the activate script
$ source &lt;myotherproject&gt;/venv/bin/activate</pre>
</div>
</div>
<div class="paragraph">
<p>So, to install Anki dependencies, everything we need to do is run the Pip installer, passing the <code>requirements.txt</code> file present at the root of the Anki repository. This file contains the list of Python modules required by Anki.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ pip install -r anki/requirements.txt</pre>
</div>
</div>
<div class="paragraph">
<p>We could now create our first script. Add a new file at the root of the project:</p>
</div>
<div class="listingblock">
<div class="title">listcards.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">sys</span>, <span class="include">os</span>

<span class="comment"># Load Anki library</span>
sys.path.append(<span class="string"><span class="delimiter">&quot;</span><span class="content">anki</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="keyword">from</span> <span class="include">anki.storage</span> <span class="keyword">import</span> <span class="include">Collection</span>

<span class="comment"># Define the path to the Anki SQLite collection</span>
PROFILE_HOME = os.path.expanduser(<span class="string"><span class="delimiter">&quot;</span><span class="content">~/Documents/Anki/User 1</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
cpath = os.path.join(PROFILE_HOME, <span class="string"><span class="delimiter">&quot;</span><span class="content">collection.anki2</span><span class="delimiter">&quot;</span></span>)

<span class="comment"># Load the Collection</span>
col = Collection(cpath, log=<span class="predefined-constant">True</span>) <span class="comment"># Entry point to the API</span>

<span class="comment"># Use the available methods to list the notes</span>
<span class="keyword">for</span> cid <span class="keyword">in</span> col.findNotes(<span class="string"><span class="delimiter">&quot;</span><span class="content">tag:English</span><span class="delimiter">&quot;</span></span>): <i class="conum" data-value="3"></i><b>(3)</b>
    note = col.getNote(cid)
    front =  note.fields[<span class="integer">0</span>] <span class="comment"># &quot;Front&quot; is the first field of these cards</span>
    print(front)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We need to add the Anki project in our path</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use the default installation folder of Anki on Linux. Please update the variable <code>PROFILE_HOME</code> to match your configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We filter the cards to only keep the card concerning the <code>English</code> language. Use <code>tag:*</code> to select all of your cards.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When running the script, you will see the "Front" field of each card displayed to the console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Car
Dog
House
Train
Computer</pre>
</div>
</div>
<div class="paragraph">
<p>Congratulations! You just have created your first Python script using the Anki API.</p>
</div>
<div class="paragraph">
<p>As time passes, Anki source will be updated. To update our submodule, just move to the submodule directory and update the HEAD reference like any other repository. Do not forget to commit in order to update the reference maintained by the parent repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cd anki
$ git pull
$ cd ..
$ git commit -am "Update Anki source"</pre>
</div>
</div>
<div class="paragraph">
<p>This ends our introduction of the Anki API. We covered enough information to get started but before tackling the problem of bulk loading, let&#8217;s begin with a simple use case: export all our flashcards to HTML, probably the most universal format today. If one day, we choose an alternative solution to Anki, it would be easy to import-export our cards to this other tool (most modern tool like Evernote, Google Keep, and many others offers a REST API for this purpose).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="case_study_exporting_flashcards_in_html">Case Study: Exporting flashcards in HTML</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s begin with a basic version to dump each card answer in its own HTML file.</p>
</div>
<div class="paragraph">
<p>First, we create a new file <code>generate_site.py</code> inside a new folder <code>userscripts</code> at the root of the project. The folder hierarchy should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>anki/ &lt;-- submodule
  anki/
  aqt/
  ...
userscripts/ &lt;-- custom code
  generate_site.py</pre>
</div>
</div>
<div class="paragraph">
<p>As for the previous example, we need to include the anki source in our path to be able to exploit the Anki API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">sys.path.append(<span class="string"><span class="delimiter">&quot;</span><span class="content">../anki</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">from</span> <span class="include">anki.storage</span> <span class="keyword">import</span> <span class="include">Collection</span> <span class="comment"># OK</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We define constants to configure our environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">PROFILE_HOME = <span class="string"><span class="delimiter">&quot;</span><span class="content">~/Documents/Anki/User 1</span><span class="delimiter">&quot;</span></span>
OUTPUT_DIRECTORY = <span class="string"><span class="delimiter">&quot;</span><span class="content">/tmp/out</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We start by loading the existing anki collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">cpath = os.path.join(PROFILE_HOME, <span class="string"><span class="delimiter">&quot;</span><span class="content">collection.anki2</span><span class="delimiter">&quot;</span></span>)
col = Collection(cpath, log=<span class="predefined-constant">True</span>) <span class="comment"># Entry point to the API</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The class <code>Collection</code> contains a long list of methods and attributes to access the notes, the cards, and the models.
We use the method <code>findCards</code> to restrict the cards to export:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">for</span> cid <span class="keyword">in</span> col.findCards(<span class="string"><span class="delimiter">&quot;</span><span class="content">tag:Git</span><span class="delimiter">&quot;</span></span>):

    card = col.getCard(cid)

    <span class="comment"># Retrieve the node to determine the card type model</span>
    note = col.getNote(card.nid)
    model = col.models.get(note.mid)

    <span class="comment"># Card contains the index of the template to use</span>
    template = model[<span class="string"><span class="delimiter">'</span><span class="content">tmpls</span><span class="delimiter">'</span></span>][card.ord]

    <span class="comment"># We use a convenient method to evaluate the templates (question/answer)</span>
    rendering = col.renderQA([cid], <span class="string"><span class="delimiter">&quot;</span><span class="content">card</span><span class="delimiter">&quot;</span></span>)[<span class="integer">0</span>]
    <span class="comment"># Only one element when coming from a given card (cid)</span>
    <span class="comment"># Could be more when passing a note of type &quot;Basic (with reversed card)&quot;</span>

    question = rendering[<span class="string"><span class="delimiter">'</span><span class="content">q</span><span class="delimiter">'</span></span>]
    answer = rendering[<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>]

    css = model[<span class="string"><span class="delimiter">'</span><span class="content">css</span><span class="delimiter">'</span></span>]

    html = <span class="string"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">&lt;!doctype html&gt;</span><span class="content">
</span><span class="content">&lt;html lang=&quot;fr&quot;&gt;</span><span class="content">
</span><span class="content">&lt;head&gt;</span><span class="content">
</span><span class="content">  &lt;meta charset=&quot;utf-8&quot;&gt;</span><span class="content">
</span><span class="content">  &lt;title&gt;Card&lt;/title&gt;</span><span class="content">
</span><span class="content">  &lt;style&gt;</span><span class="content">
</span><span class="content">  %s</span><span class="content">
</span><span class="content">  &lt;/style&gt;</span><span class="content">
</span><span class="content">&lt;/head&gt;</span><span class="content">
</span><span class="content">&lt;body&gt;</span><span class="content">
</span><span class="content">  &lt;div class=&quot;card&quot;&gt;</span><span class="content">
</span><span class="content">  %s</span><span class="content">
</span><span class="content">  &lt;/div&gt;</span><span class="content">
</span><span class="content">&lt;/body&gt;</span><span class="content">
</span><span class="content">&lt;/html&gt;</span><span class="delimiter">&quot;&quot;&quot;</span></span> % (css, answer)

    card_filename = <span class="string"><span class="delimiter">&quot;</span><span class="content">card-%s.html</span><span class="delimiter">&quot;</span></span> % cid
    card_file = codecs.open(
        os.path.join(OUTPUT_DIRECTORY, card_filename), <span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>)
    card_file.write(html)
    card_file.close()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code iterate over the card identifiers and begin by collecting required information about the card (template, css, &#8230;&#8203;). Once this is done, we create the HTML content by injecting the model CSS and the rendered card content (fields are replaced by values with the method <code>renderQA</code>).</p>
</div>
<div class="paragraph">
<p>When running, the program generate a list of files inside the folder defined by the constant <code>OUTPUT_DIRECTORY</code>. Here is the content of the file <code>card-1429876617511.html</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/card-export-HTML.png" alt="card export HTML">
</div>
</div>
<div class="paragraph">
<p>To generate an index page listing all the exported cards, we need to update the previous code to store the list of processed card:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">cards = {} <span class="comment"># Keep a log of processed cards</span>
<span class="keyword">for</span> cid <span class="keyword">in</span> col.findCards(<span class="string"><span class="delimiter">&quot;</span><span class="content">tag:Git</span><span class="delimiter">&quot;</span></span>):
    <span class="comment"># ...</span>
    cards[cid] = {
        <span class="string"><span class="delimiter">'</span><span class="content">file</span><span class="delimiter">'</span></span>: card_filename,
        <span class="string"><span class="delimiter">'</span><span class="content">question</span><span class="delimiter">'</span></span>: question
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we iterate over this list to generate an HTML list before injecting it in an HTML document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">card_list = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>
<span class="keyword">for</span> cid, props <span class="keyword">in</span> cards.iteritems():
    card_list += <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;li&gt;&lt;a href=</span><span class="char">\&quot;</span><span class="content">%s</span><span class="char">\&quot;</span><span class="content">&gt;%s&lt;/a&gt;&lt;/li&gt;</span><span class="delimiter">&quot;</span></span> %
                     (props[<span class="string"><span class="delimiter">'</span><span class="content">file</span><span class="delimiter">'</span></span>], props[<span class="string"><span class="delimiter">'</span><span class="content">question</span><span class="delimiter">'</span></span>])

html = <span class="string"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">&lt;!doctype html&gt;</span><span class="content">
</span><span class="content">&lt;html lang=&quot;fr&quot;&gt;</span><span class="content">
</span><span class="content">&lt;head&gt;</span><span class="content">
</span><span class="content">  &lt;meta charset=&quot;utf-8&quot;&gt;</span><span class="content">
</span><span class="content">  &lt;title&gt;Anki Export&lt;/title&gt;</span><span class="content">
</span><span class="content">&lt;/head&gt;</span><span class="content">
</span><span class="content">&lt;body&gt;</span><span class="content">
</span><span class="content">  &lt;ul&gt;</span><span class="content">
</span><span class="content">  %s</span><span class="content">
</span><span class="content">  &lt;/ul&gt;</span><span class="content">
</span><span class="content">&lt;/body&gt;</span><span class="content">
</span><span class="content">&lt;/html&gt;</span><span class="delimiter">&quot;&quot;&quot;</span></span> % (card_list)

index_filename = <span class="string"><span class="delimiter">&quot;</span><span class="content">index.html</span><span class="delimiter">&quot;</span></span>
index_file = codecs.open(os.path.join(OUTPUT_DIRECTORY, index_filename), \
                         <span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>)
index_file.write(html)
index_file.close()</code></pre>
</div>
</div>
<div class="paragraph">
<p>When running the program, a new file <code>index.html</code> is generated in the target directory:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/cards-export-HTML.png" alt="cards export HTML">
</div>
</div>
<div class="paragraph">
<p>The code works but there remains a concern to address: the medias. Indeed, cards could reference external resources like images or sounds, which are all stored in a single folder <code>collection.media</code> under your profile directory. So, we need to extract there resources too and update the links inside the card text to reflect the new location.</p>
</div>
<div class="paragraph">
<p>A basic strategy could be to duplicate the whole folder. To avoid copying resources from cards that we don&#8217;t want to export, we will instead copy each file independently while processing the card. So, we need to update again the card processing code again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">for</span> cid <span class="keyword">in</span> col.findCards(<span class="string"><span class="delimiter">&quot;</span><span class="content">tag:Git</span><span class="delimiter">&quot;</span></span>):
    <span class="comment"># ...</span>
    rendering = col.renderQA([cid], <span class="string"><span class="delimiter">&quot;</span><span class="content">card</span><span class="delimiter">&quot;</span></span>)[<span class="integer">0</span>]
    question = extractMedia(rendering[<span class="string"><span class="delimiter">'</span><span class="content">q</span><span class="delimiter">'</span></span>])
    answer = extractMedia(rendering[<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>])


<span class="keyword">def</span> <span class="function">extractMedia</span>(text):
    regex = <span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">&lt;img src=&quot;(.*?)&quot;</span><span class="content">\s</span><span class="content">?/?&gt;</span><span class="delimiter">'</span></span>
    pattern = re.compile(regex)

    src_media_folder = os.path.join(PROFILE_HOME, <span class="string"><span class="delimiter">&quot;</span><span class="content">collection.media/</span><span class="delimiter">&quot;</span></span>)
    dest_media_folder = os.path.join(OUTPUT_DIRECTORY, <span class="string"><span class="delimiter">&quot;</span><span class="content">medias</span><span class="delimiter">&quot;</span></span>)

    <span class="comment"># Create target directory if not exists</span>
    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(dest_media_folder):
        os.makedirs(dest_media_folder)

    <span class="comment"># Copy each images referenced by this card</span>
    <span class="keyword">for</span> (media) <span class="keyword">in</span> re.findall(pattern, text):
        src = os.path.join(src_media_folder, media)
        dest = os.path.join(dest_media_folder, media)
        shutil.copyfile(src, dest)

    <span class="comment"># And don't forget to change the href attribute to reflect the new location</span>
    text_with_prefix_folder = re.sub(regex, <span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">&lt;img src=&quot;medias/</span><span class="content">\1</span><span class="content">&quot; /&gt;</span><span class="delimiter">'</span></span>, text)

    <span class="keyword">return</span> text_with_prefix_folder</code></pre>
</div>
</div>
<div class="paragraph">
<p>When running the program again, a new folder <code>medias</code> will be created inside the target directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>out/
  medias/
    paste-2911987826689.jpg</pre>
</div>
</div>
<div class="paragraph">
<p>If we open the associated card in our browser, we should see this picture displayed correctly:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/card-export-img.png" alt="card export img">
</div>
</div>
<div class="paragraph">
<p>Great! We have successfully exported our Anki collection into a standard format but the result does not look good. Let&#8217;s add a little bit of JavaScript and CSS to make the application looks better.</p>
</div>
<div class="paragraph">
<p>What we want is a basic single-page application (SPA) that displays our flashcards. A search field will be available at the top of the page to help us filter the cards. Flashcard content will only be displayed when selecting the flashcard title in the list. The following is a draft of this application demo:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/app-export-html.png" alt="app export html">
</div>
</div>
<div class="paragraph">
<p>To add dynamic behavior to our SPA, we will use AngularJS. AngularJS keep our code clean by separating our model from the view and controller (Pattern MVC). To do that, we are going to convert the static HTML list of cards to JSON format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">card_list = <span class="string"><span class="delimiter">'</span><span class="content">[</span><span class="delimiter">'</span></span>
<span class="keyword">for</span> cid, props <span class="keyword">in</span> cards.iteritems():
    card_list += <span class="string"><span class="delimiter">&quot;</span><span class="content">{ 'name': </span><span class="char">\&quot;</span><span class="content">%s</span><span class="char">\&quot;</span><span class="content">, 'file': '%s', 'tags': [ %s ] },</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> % (
        props[<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>],
        props[<span class="string"><span class="delimiter">'</span><span class="content">question_file</span><span class="delimiter">'</span></span>],
        props[<span class="string"><span class="delimiter">'</span><span class="content">answer_file</span><span class="delimiter">'</span></span>],
        <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span> + <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">,</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>.join(props[<span class="string"><span class="delimiter">'</span><span class="content">tags</span><span class="delimiter">'</span></span>]) + <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
card_list += <span class="string"><span class="delimiter">'</span><span class="content">]</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also exploit the card&#8217;s tags, easily retrieved from the note object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">cards[cid] = {
    <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>: rawText(question), <span class="comment"># rawText remove HTML tags from card content</span>
    <span class="string"><span class="delimiter">'</span><span class="content">file</span><span class="delimiter">'</span></span>: card_filename,
    <span class="string"><span class="delimiter">'</span><span class="content">tags</span><span class="delimiter">'</span></span>: note.tags
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We could now redesign our HTML template to integrate the new layout:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">html = <span class="string"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">&lt;!doctype html&gt;</span><span class="content">
</span><span class="content">&lt;html lang=&quot;fr&quot; ng-app=&quot;ankiApp&quot;&gt;</span><span class="content">
</span><span class="content">&lt;head&gt;</span><span class="content">
</span><span class="content">  &lt;meta charset=&quot;utf-8&quot;&gt;</span><span class="content">
</span><span class="content">  &lt;title&gt;Anki Export&lt;/title&gt;</span><span class="content">
</span><span class="content">  &lt;script src=&quot;//ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js&quot;&gt;</span><span class="content">
</span><span class="content">  &lt;/script&gt;</span><span class="content">
</span><span class="content">  &lt;script&gt;</span><span class="content">
</span><span class="content">angular.module('ankiApp', [])</span><span class="content">
</span><span class="content">  .controller('AnkiController', function() {</span><span class="content">
</span><span class="content">    var anki = this;</span><span class="content">
</span><span class="content">    anki.cardList = %s;</span><span class="content">
</span><span class="content">    anki.selectedCard = anki.cardList[0];</span><span class="content">
</span><span class="content">
</span><span class="content">    anki.select = function(card) {</span><span class="content">
</span><span class="content">      anki.selectedCard = card;</span><span class="content">
</span><span class="content">    }</span><span class="content">
</span><span class="content">  });</span><span class="content">
</span><span class="content">  &lt;/script&gt;</span><span class="content">
</span><span class="content">&lt;/head&gt;</span><span class="content">
</span><span class="content">&lt;body&gt;</span><span class="content">
</span><span class="content">  &lt;div ng-controller=&quot;AnkiController as anki&quot;&gt;</span><span class="content">
</span><span class="content">      &lt;div id=&quot;search&quot;&gt;</span><span class="content">
</span><span class="content">        &lt;input type=&quot;text&quot; ng-model=&quot;anki.search&quot; placeholder=&quot;Search...&quot;&gt;</span><span class="content">
</span><span class="content">      &lt;/div&gt;</span><span class="content">
</span><span class="content">      &lt;nav id=&quot;list&quot;&gt;</span><span class="content">
</span><span class="content">        &lt;ul&gt;</span><span class="content">
</span><span class="content">          &lt;li ng-repeat=&quot;card in anki.cardList | filter:anki.search </span><span class="char">\
</span><span class="content">                       | orderBy:'name'&quot;&quot; ng-click=&quot;anki.select(card)&quot;&gt;</span><span class="content">
</span><span class="content">            {{card.name}}</span><span class="content">
</span><span class="content">            &lt;span class=&quot;tag&quot; ng-repeat=&quot;tag in card.tags&quot;&gt;{{tag}}&lt;/span&gt;</span><span class="content">
</span><span class="content">          &lt;/li&gt;</span><span class="content">
</span><span class="content">        &lt;/ul&gt;</span><span class="content">
</span><span class="content">      &lt;/nav&gt;</span><span class="content">
</span><span class="content">      &lt;div id=&quot;card&quot;&gt;</span><span class="content">
</span><span class="content">        &lt;iframe ng-src=&quot;{{anki.selectedCard.file}}&quot; width=&quot;80%%&quot;&gt;</span><span class="content">
</span><span class="content">        &lt;/iframe&gt;</span><span class="content">
</span><span class="content">      &lt;/div&gt;</span><span class="content">
</span><span class="content">  &lt;/div&gt;</span><span class="content">
</span><span class="content">&lt;/body&gt;</span><span class="content">
</span><span class="content">&lt;/html&gt;</span><span class="delimiter">&quot;&quot;&quot;</span></span> % (card_list)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We iterate over the JSON array containing the cards we just created. When the user clicks on a card title, the method <code>select</code> defined in the controller is called. This method stores the selected card in the model. AngularJS refreshes our page and the iframe is updated with the content of the selected flashcard. Last thing to notice, we only display the flashcards matching the query entered by the user in the search field.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add the "final touch", the CSS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;style&gt;</span>
<span class="inline"> <span class="tag">body</span> {
     <span class="key">background-color</span>: <span class="color">#0079bf</span>;
 }
 <span class="id">#search</span> {
     <span class="key">position</span>: <span class="value">fixed</span>;
     <span class="key">height</span>: <span class="float">70px</span>;
     <span class="key">width</span>: <span class="float">100%</span>;
     <span class="key">padding-top</span>: <span class="float">20px</span>;
     <span class="key">text-align</span>: <span class="value">center</span>;
 }
 <span class="id">#search</span> <span class="tag">input</span> {
     <span class="key">width</span>: <span class="float">80%</span>;
     <span class="key">height</span>: <span class="float">30px</span>;
     <span class="key">border-radius</span>: <span class="float">15px</span>;
     <span class="key">text-align</span>: <span class="value">center</span>;
     <span class="key">border</span>: <span class="value">none</span>;
     <span class="key">box-shadow</span>: <span class="float">2px</span> <span class="float">2px</span> <span class="color">#222</span>;
 }
 <span class="id">#list</span> {
     <span class="key">position</span>: <span class="value">fixed</span>;
     <span class="key">width</span>: <span class="float">50%</span>;
     <span class="key">top</span>: <span class="float">70px</span>;
     <span class="key">bottom</span>: <span class="float">0</span>;
     <span class="key">left</span>: <span class="float">0</span>;
 }
 <span class="id">#list</span> <span class="tag">ul</span> {
     <span class="key">list-style-type</span>: <span class="value">none</span>;
 }
 <span class="id">#list</span> <span class="tag">li</span> {
     <span class="key">background-color</span>: <span class="value">white</span>;
     <span class="key">border</span>: <span class="float">1px</span> <span class="value">solid</span> <span class="value">silver</span>;
     <span class="key">border-radius</span>: <span class="float">2px</span>;
     <span class="key">font-family</span>: <span class="string"><span class="delimiter">'</span><span class="content">Handlee</span><span class="delimiter">'</span></span>, <span class="value">cursive</span>;
     <span class="key">width</span>: <span class="float">90%</span>;
     <span class="key">padding</span>: <span class="float">5px</span> <span class="float">10px</span>;
     <span class="key">margin-top</span>: <span class="float">10px</span>;
     <span class="key">margin-bottom</span>: <span class="float">10px</span>;
     <span class="key">cursor</span>: <span class="value">pointer</span>;
 }
 <span class="id">#card</span> {
     <span class="key">position</span>: <span class="value">fixed</span>;
     <span class="key">width</span>: <span class="float">50%</span>;
     <span class="key">right</span>: <span class="float">0</span>;
     <span class="key">top</span>: <span class="float">270px</span>;
     <span class="key">bottom</span>: <span class="float">0</span>;
 }
 <span class="tag">iframe</span> {
     <span class="key">background-color</span>: <span class="value">white</span>;
     <span class="key">border</span>: <span class="value">none</span>;
     <span class="key">box-shadow</span>: <span class="float">5px</span> <span class="float">5px</span> <span class="float">3px</span> <span class="color">#333</span>;
 }

 <span class="class">.tag</span> {
     <span class="key">float</span>: <span class="value">right</span>;
     <span class="key">margin-right</span>: <span class="float">10px</span>;
     <span class="key">padding</span>: <span class="float">2px</span> <span class="float">5px</span>;
     <span class="key">background-color</span>: <span class="value">orangered</span>;
     <span class="key">color</span>: <span class="value">white</span>;
     <span class="key">font-size</span>: <span class="float">12px</span>;
     <span class="key">font-family</span>: <span class="value">Arial</span>;
 }</span>
<span class="tag">&lt;/style&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The layout is divided in three section: the search bar at the top, the list of flashcards on the left and the currently selected flashcard on the right. We use fixed positioning to keep all sections always present on the screen. The results now looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/generated-styled-site.png" alt="generated styled site">
</div>
</div>
<div class="paragraph">
<p>This ends our first case study. We have seen how to exploit the Anki API to retrieve our data and export them to another format. In the next case study, we are going to use the Anki API to load a batch of cards, created from a book.</p>
</div>
<div class="paragraph">
<p>Here is the full listing of the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">sys</span>, <span class="include">os</span>, <span class="include">codecs</span>, <span class="include">re</span>, <span class="include">shutil</span>
sys.path.append(<span class="string"><span class="delimiter">&quot;</span><span class="content">..</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">from</span> <span class="include">anki.storage</span> <span class="keyword">import</span> <span class="include">Collection</span>

<span class="comment"># Constants</span>
PROFILE_HOME = <span class="string"><span class="delimiter">&quot;</span><span class="content">C:/Users/Julien/Anki/User 1</span><span class="delimiter">&quot;</span></span>
OUTPUT_DIRECTORY = <span class="string"><span class="delimiter">&quot;</span><span class="content">C:/out</span><span class="delimiter">&quot;</span></span>

<span class="comment"># Utility methods</span>

<span class="keyword">def</span> <span class="function">rawText</span>(text):
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content"> Clean question text to display a list of all questions. </span><span class="delimiter">&quot;&quot;&quot;</span></span>
    raw_text = re.sub(<span class="string"><span class="delimiter">'</span><span class="content">&lt;[^&lt;]+?&gt;</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>, text)
    raw_text = re.sub(<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">'</span><span class="delimiter">&quot;</span></span>, raw_text)
    raw_text = raw_text.strip()
    <span class="keyword">if</span> raw_text:
        <span class="keyword">return</span> raw_text
    <span class="keyword">else</span>:
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Untitled</span><span class="delimiter">&quot;</span></span>

<span class="keyword">def</span> <span class="function">extractMedia</span>(text):
    regex = <span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">&lt;img src=&quot;(.*?)&quot;</span><span class="content">\s</span><span class="content">?/?&gt;</span><span class="delimiter">'</span></span>
    pattern = re.compile(regex)

    src_media_folder = os.path.join(PROFILE_HOME, <span class="string"><span class="delimiter">&quot;</span><span class="content">collection.media/</span><span class="delimiter">&quot;</span></span>)
    dest_media_folder = os.path.join(OUTPUT_DIRECTORY, <span class="string"><span class="delimiter">&quot;</span><span class="content">medias</span><span class="delimiter">&quot;</span></span>)

    <span class="comment"># Create target directory if not exists</span>
    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(dest_media_folder):
        os.makedirs(dest_media_folder)

    <span class="keyword">for</span> (media) <span class="keyword">in</span> re.findall(pattern, text):
        src = os.path.join(src_media_folder, media)
        dest = os.path.join(dest_media_folder, media)
        shutil.copyfile(src, dest)

    text_with_prefix_folder = re.sub(regex, <span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">&lt;img src=&quot;medias/</span><span class="content">\1</span><span class="content">&quot; /&gt;</span><span class="delimiter">'</span></span>, text)

    <span class="keyword">return</span> text_with_prefix_folder


<span class="comment"># Load the anki collection</span>
cpath = os.path.join(PROFILE_HOME, <span class="string"><span class="delimiter">&quot;</span><span class="content">collection.anki2</span><span class="delimiter">&quot;</span></span>)
col = Collection(cpath, log=<span class="predefined-constant">True</span>)

<span class="comment"># Iterate over all cards</span>
cards = {}
<span class="keyword">for</span> cid <span class="keyword">in</span> col.findCards(<span class="string"><span class="delimiter">&quot;</span><span class="content">tag:Git</span><span class="delimiter">&quot;</span></span>):

    card = col.getCard(cid)

    <span class="comment"># Retrieve the node to determine the card type model</span>
    note = col.getNote(card.nid)
    model = col.models.get(note.mid)
    tags = note.tags

    <span class="comment"># Card contains the index of the template to use</span>
    template = model[<span class="string"><span class="delimiter">'</span><span class="content">tmpls</span><span class="delimiter">'</span></span>][card.ord]

    <span class="comment"># We retrieve the question and answer templates</span>
    question_template = template[<span class="string"><span class="delimiter">'</span><span class="content">qfmt</span><span class="delimiter">'</span></span>]
    answer_template = template[<span class="string"><span class="delimiter">'</span><span class="content">afmt</span><span class="delimiter">'</span></span>]

    <span class="comment"># We could use a convenient method exposed by Anki to evaluate the template</span>
    rendering = col.renderQA([cid], <span class="string"><span class="delimiter">&quot;</span><span class="content">card</span><span class="delimiter">&quot;</span></span>)[<span class="integer">0</span>]
    <span class="comment"># Only one element when coming from a given card</span>
    <span class="comment"># Could be more when passing a note of type &quot;Basic (with reversed card)&quot;</span>

    question = rendering[<span class="string"><span class="delimiter">'</span><span class="content">q</span><span class="delimiter">'</span></span>]
    answer = rendering[<span class="string"><span class="delimiter">'</span><span class="content">a</span><span class="delimiter">'</span></span>]

    question = extractMedia(question)
    answer = extractMedia(answer)

    css = model[<span class="string"><span class="delimiter">'</span><span class="content">css</span><span class="delimiter">'</span></span>]

    html = <span class="string"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">&lt;!doctype html&gt;</span><span class="content">
</span><span class="content">&lt;html lang=&quot;fr&quot;&gt;</span><span class="content">
</span><span class="content">&lt;head&gt;</span><span class="content">
</span><span class="content">  &lt;meta charset=&quot;utf-8&quot;&gt;</span><span class="content">
</span><span class="content">  &lt;title&gt;Card Answer&lt;/title&gt;</span><span class="content">
</span><span class="content">  &lt;style&gt;</span><span class="content">
</span><span class="content">  %s</span><span class="content">
</span><span class="content">  &lt;/style&gt;</span><span class="content">
</span><span class="content">&lt;/head&gt;</span><span class="content">
</span><span class="content">&lt;body&gt;</span><span class="content">
</span><span class="content">  &lt;div class=&quot;card&quot;&gt;</span><span class="content">
</span><span class="content">  %s</span><span class="content">
</span><span class="content">  &lt;/div&gt;</span><span class="content">
</span><span class="content">&lt;/body&gt;</span><span class="content">
</span><span class="content">&lt;/html&gt;</span><span class="delimiter">&quot;&quot;&quot;</span></span> % (css, answer)

    card_filename = <span class="string"><span class="delimiter">&quot;</span><span class="content">card-%s.html</span><span class="delimiter">&quot;</span></span> % cid
    card_file = codecs.open(os.path.join(OUTPUT_DIRECTORY, card_filename), \
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>)
    card_file.write(html)
    card_file.close()

    cards[cid] = {
        <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>: rawText(question),
        <span class="string"><span class="delimiter">'</span><span class="content">file</span><span class="delimiter">'</span></span>: card_filename,
        <span class="string"><span class="delimiter">'</span><span class="content">tags</span><span class="delimiter">'</span></span>: tags
    }


<span class="comment"># Generate a list of all cards</span>
card_list = <span class="string"><span class="delimiter">'</span><span class="content">[</span><span class="delimiter">'</span></span>
<span class="keyword">for</span> cid, props <span class="keyword">in</span> cards.iteritems():
    card_list += <span class="string"><span class="delimiter">&quot;</span><span class="content">{ 'name': </span><span class="char">\&quot;</span><span class="content">%s</span><span class="char">\&quot;</span><span class="content">, 'file': '%s', 'tags': [ %s ] },</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> % (
        props[<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>],
        props[<span class="string"><span class="delimiter">'</span><span class="content">file</span><span class="delimiter">'</span></span>],
        <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span> + <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">,</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>.join(props[<span class="string"><span class="delimiter">'</span><span class="content">tags</span><span class="delimiter">'</span></span>]) + <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
card_list += <span class="string"><span class="delimiter">'</span><span class="content">]</span><span class="delimiter">'</span></span>

html = <span class="string"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">&lt;!doctype html&gt;</span><span class="content">
</span><span class="content">&lt;html lang=&quot;fr&quot; ng-app=&quot;ankiApp&quot;&gt;</span><span class="content">
</span><span class="content">&lt;head&gt;</span><span class="content">
</span><span class="content">  &lt;meta charset=&quot;utf-8&quot;&gt;</span><span class="content">
</span><span class="content">  &lt;title&gt;Anki Export&lt;/title&gt;</span><span class="content">
</span><span class="content">  &lt;script src=&quot;//ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js&quot;&gt;</span><span class="content">
</span><span class="content">  &lt;/script&gt;</span><span class="content">
</span><span class="content">  &lt;style&gt;</span><span class="content">
</span><span class="content">body {</span><span class="content">
</span><span class="content">    background-color: #0079bf;</span><span class="content">
</span><span class="content">}</span><span class="content">
</span><span class="content">#search {</span><span class="content">
</span><span class="content">    position: fixed;</span><span class="content">
</span><span class="content">    height: 70px;</span><span class="content">
</span><span class="content">    width: 100%%;</span><span class="content">
</span><span class="content">    padding-top: 20px;</span><span class="content">
</span><span class="content">    text-align: center;</span><span class="content">
</span><span class="content">}</span><span class="content">
</span><span class="content">#search input {</span><span class="content">
</span><span class="content">    width: 80%%;</span><span class="content">
</span><span class="content">    height: 30px;</span><span class="content">
</span><span class="content">    border-radius: 15px;</span><span class="content">
</span><span class="content">    text-align: center;</span><span class="content">
</span><span class="content">    border: none;</span><span class="content">
</span><span class="content">    box-shadow: 2px 2px #222;</span><span class="content">
</span><span class="content">}</span><span class="content">
</span><span class="content">#list {</span><span class="content">
</span><span class="content">    position: fixed;</span><span class="content">
</span><span class="content">    width: 50%%;</span><span class="content">
</span><span class="content">    top: 70px;</span><span class="content">
</span><span class="content">    bottom: 0;</span><span class="content">
</span><span class="content">    left: 0;</span><span class="content">
</span><span class="content">}</span><span class="content">
</span><span class="content">#list ul {</span><span class="content">
</span><span class="content">    list-style-type: none;</span><span class="content">
</span><span class="content">}</span><span class="content">
</span><span class="content">#list li {</span><span class="content">
</span><span class="content">    background-color: white;</span><span class="content">
</span><span class="content">    border: 1px solid silver;</span><span class="content">
</span><span class="content">    border-radius: 2px;</span><span class="content">
</span><span class="content">    width: 90%%;</span><span class="content">
</span><span class="content">    padding: 5px 10px;</span><span class="content">
</span><span class="content">    margin-top: 10px;</span><span class="content">
</span><span class="content">    margin-bottom: 10px;</span><span class="content">
</span><span class="content">    cursor: pointer;</span><span class="content">
</span><span class="content">}</span><span class="content">
</span><span class="content">#card {</span><span class="content">
</span><span class="content">    position: fixed;</span><span class="content">
</span><span class="content">    width: 50%%;</span><span class="content">
</span><span class="content">    right: 0;</span><span class="content">
</span><span class="content">    top: 85px;</span><span class="content">
</span><span class="content">    bottom: 0;</span><span class="content">
</span><span class="content">}</span><span class="content">
</span><span class="content">iframe {</span><span class="content">
</span><span class="content">    background-color: white;</span><span class="content">
</span><span class="content">    border: none;</span><span class="content">
</span><span class="content">    box-shadow: 5px 5px 3px #333;</span><span class="content">
</span><span class="content">}</span><span class="content">
</span><span class="content">.tag {</span><span class="content">
</span><span class="content">    float: right;</span><span class="content">
</span><span class="content">    margin-right: 10px;</span><span class="content">
</span><span class="content">    padding: 2px 5px;</span><span class="content">
</span><span class="content">    background-color: orangered;</span><span class="content">
</span><span class="content">    color: white;</span><span class="content">
</span><span class="content">    font-size: 12px;</span><span class="content">
</span><span class="content">    font-family: Arial;</span><span class="content">
</span><span class="content">}</span><span class="content">
</span><span class="content">  &lt;/style&gt;</span><span class="content">
</span><span class="content">  &lt;script&gt;</span><span class="content">
</span><span class="content">angular.module('ankiApp', [])</span><span class="content">
</span><span class="content">  .controller('AnkiController', function() {</span><span class="content">
</span><span class="content">    var anki = this;</span><span class="content">
</span><span class="content">    anki.cardList = %s;</span><span class="content">
</span><span class="content">    anki.selectedCard = anki.cardList[0];</span><span class="content">
</span><span class="content">
</span><span class="content">    anki.select = function(card) {</span><span class="content">
</span><span class="content">      anki.selectedCard = card;</span><span class="content">
</span><span class="content">    }</span><span class="content">
</span><span class="content">  });</span><span class="content">
</span><span class="content">  &lt;/script&gt;</span><span class="content">
</span><span class="content">&lt;/head&gt;</span><span class="content">
</span><span class="content">&lt;body&gt;</span><span class="content">
</span><span class="content">  &lt;div ng-controller=&quot;AnkiController as anki&quot;&gt;</span><span class="content">
</span><span class="content">      &lt;div id=&quot;search&quot;&gt;</span><span class="content">
</span><span class="content">        &lt;input type=&quot;text&quot; ng-model=&quot;anki.search&quot; placeholder=&quot;Search...&quot;&gt;</span><span class="content">
</span><span class="content">      &lt;/div&gt;</span><span class="content">
</span><span class="content">      &lt;nav id=&quot;list&quot;&gt;</span><span class="content">
</span><span class="content">        &lt;ul&gt;</span><span class="content">
</span><span class="content">          &lt;li ng-repeat=&quot;card in anki.cardList | filter:anki.search </span><span class="char">\
</span><span class="content">                                               | orderBy:'name'&quot;&quot;</span><span class="content">
</span><span class="content">              ng-click=&quot;anki.select(card)&quot;&gt;</span><span class="content">
</span><span class="content">            {{card.name}}</span><span class="content">
</span><span class="content">            &lt;span class=&quot;tag&quot; ng-repeat=&quot;tag in card.tags&quot;&gt;{{tag}}&lt;/span&gt;</span><span class="content">
</span><span class="content">          &lt;/li&gt;</span><span class="content">
</span><span class="content">        &lt;/ul&gt;</span><span class="content">
</span><span class="content">      &lt;/nav&gt;</span><span class="content">
</span><span class="content">      &lt;div id=&quot;card&quot;&gt;</span><span class="content">
</span><span class="content">        &lt;iframe ng-src=&quot;{{anki.selectedCard.file}}&quot; width=&quot;80%%&quot;&gt;</span><span class="content">
</span><span class="content">        &lt;/iframe&gt;</span><span class="content">
</span><span class="content">      &lt;/div&gt;</span><span class="content">
</span><span class="content">  &lt;/div&gt;</span><span class="content">
</span><span class="content">&lt;/body&gt;</span><span class="content">
</span><span class="content">&lt;/html&gt;</span><span class="delimiter">&quot;&quot;&quot;</span></span> % (card_list)


index_filename = <span class="string"><span class="delimiter">&quot;</span><span class="content">index.html</span><span class="delimiter">&quot;</span></span>
index_file = codecs.open(os.path.join(OUTPUT_DIRECTORY, index_filename), \
                         <span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>)
index_file.write(html)
index_file.close()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="case_study_convert_an_epub_to_flashcards">Case Study: Convert an EPUB to Flashcards</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Let&#8217;s me present you the context. We just bought a new <a href="https://www.amazon.fr/Harraps-Expressions-anglaises-Collectif/dp/2818704480">book to learn the common English expressions</a>. This book contains around 4000 expressions. If we consider it takes two minutes to create a flashcard, more than 100 hours will be required to overcome this daunting task. So, what can we do? One solution is to script the creation of the flashcards and this is exactly what we are going to do here.</em></p>
</div>
<div class="paragraph">
<p>This post will be divided in two sections. In the first part of this post, we are going to create a small program to read an Epub file in Python. In the second part, we will extend this program to insert the content directly into our Anki collection.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">But does it not preferable to manually create the flashcards in order to retain more?</div>
<div class="paragraph">
<p>Of course! Creating manually a flashcard is always better than automating its creation. When you enter the words on the keyboard, or when you search on Google Images a memorable picture, you create connections inside your memory and this considerably help you to start fixing this new information. The manual creation is perfectly fine when learning your first words in a new language because it is easy to find a great picture or a personal story about it. Here, we are interested in common idioms, phrases that often does not mean what common sense would say. Relevant memorable pictures are difficult to find, so creating the flashcards manually does not help that much to fix the information in your brain. It is better to spend the 100 or more hours on studying the flashcards than on creating them.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="part_i_reading_the_ebook_epub">Part I: Reading the Ebook (ePub)</h3>
<div class="paragraph">
<p>The book is available in ePub format. The term is short for <em>electronic publication</em>. EPUB 3 is currently the most portable ebook format (Amazon has its own proprietary format for its Kindle but every other software readers such as Kobo or Bookeen supports this format).</p>
</div>
<div class="paragraph">
<p>For our task, we only need to know that an ePub is just a ZIP archive containing a website written in HTML5, including HTML files, images, CSS stylesheets, and other assets like video.</p>
</div>
<div class="paragraph">
<p>The ebook is subject to a copyright, so to avoid any violation, I rewrite a short version by customizing the text. This demonstration ebook is available in the <a href="https://github.com/julien-sobczak/anki-scripting/tree/master/anki-usecase-enidioms">repository associated to this post</a>. To inspect its content, just unzip the archive:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/epub-unzipped.png" alt="epub unzipped">
</div>
</div>
<div class="paragraph">
<p>The first file in the archive must be the <code>mimetype</code> file. It must be uncompressed so that non-ZIP utilities can read the mimetype. The <code>mimetype</code> file must be an ASCII file that contains the string <code>application/epub+zip</code>.</p>
</div>
<div class="paragraph">
<p>There must be a <code>META-INF</code> directory containing <code>container.xml</code>. This file points to the file defining the contents of the book:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="tag">&lt;container</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:oasis:names:tc:opendocument:xmlns:container</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;rootfiles&gt;</span>
  <span class="tag">&lt;rootfile</span> <span class="attribute-name">full-path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OEBPS/volume.opf</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/oebps-package+xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/rootfiles&gt;</span>
<span class="tag">&lt;/container&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Apart from <code>mimetype</code> and <code>META-INF/container.xml</code>, the other files (HTML, CSS and images files) are traditionally put in a directory named <code>OEBPS</code>. This directory contains the <code>volume.opf</code> file referenced in the previous file. Here is an example of this file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span>
<span class="tag">&lt;package</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.idpf.org/2007/opf</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">prefix</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cc: http://creativecommons.org/ns</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;metadata</span> <span class="attribute-name">xmlns:dc</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://purl.org/dc/elements/1.1/</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">xmlns:opf</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.idpf.org/2007/opf</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;dc:title&gt;</span>Julien's Mes Expressions anglaises<span class="tag">&lt;/dc:title&gt;</span>
    <span class="tag">&lt;dc:language&gt;</span>fr<span class="tag">&lt;/dc:language&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cover</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cover</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">property</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rendition:layout</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>pre-paginated<span class="tag">&lt;/meta&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">property</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rendition:orientation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>auto<span class="tag">&lt;/meta&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">property</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rendition:spread</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>landscape<span class="tag">&lt;/meta&gt;</span>
  <span class="tag">&lt;/metadata&gt;</span>
  <span class="tag">&lt;manifest&gt;</span>
    <span class="tag">&lt;item</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">images/cover.jpg</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cover</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">image/jpeg</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">properties</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cover-image</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;item</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">images/Page_1.jpg</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jpg296</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">image/jpeg</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;item</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Page_1.html</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Page_1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xhtml+xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;item</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Page_2.html</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Page_2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xhtml+xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;item</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">toc.html</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">toc</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xhtml+xml</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">properties</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">nav</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;item</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">css/ENE.css</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">css288</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/css</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;item</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_page_map_.xml</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_page_map_</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/oebps-page-map+xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/manifest&gt;</span>
  <span class="tag">&lt;spine</span> <span class="attribute-name">page-map</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_page_map_</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;itemref</span> <span class="attribute-name">idref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Page_1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">linear</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">yes</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">properties</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">page-spread-right</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;itemref</span> <span class="attribute-name">idref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Page_2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">linear</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">yes</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">properties</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">page-spread-right</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;spine&gt;</span>
<span class="tag">&lt;/package&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the manifest section, we can see all web resources included in this epub. This are these files that interested us, in particular the HTML files. If you open the book with an ebook reader (your device or an application like Calibre), you could see the book content:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/epub-preview.png" alt="epub preview">
</div>
</div>
<div class="paragraph">
<p>If you want to know more about the epub format, O&#8217;Reilly published whole <a href="https://shop.oreilly.com/product/0636920024897.do">books</a> on the subject.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see how the HTML looks like. The <code>Page_1.html</code> page contains only a picture with the cover of the book. We could ignore it. The next page <code>Page_2.html</code> is an example of page we need to parse to extract the English expressions. Here is an extract of this file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span>
<span class="tag">&lt;html</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/1999/xhtml</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;head&gt;</span>
<span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;meta</span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">width=1277,height=2048</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewport</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;title&gt;</span>Page 2<span class="tag">&lt;/title&gt;</span>
<span class="tag">&lt;link</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">css/ENE.css</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/css</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/head&gt;</span>
<span class="tag">&lt;body</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Mes-Expressions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fr-FR</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">width</span>: <span class="float">1277px</span>; <span class="key">height</span>: <span class="float">2048px</span>;<span class="delimiter">&quot;</span></span> <span class="attribute-name">xml:lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fr-FR</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;article</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Layout</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">-webkit-transform-origin</span>: <span class="float">0%</span> <span class="float">0%</span>; <span class="error">\</span>
                <span class="key">-webkit-transform</span>: <span class="error">s</span><span class="error">c</span><span class="error">a</span><span class="error">l</span><span class="error">e</span>(<span class="float">4.05545</span>); <span class="error">\</span>
                <span class="key">transform-origin</span>: <span class="float">0%</span> <span class="float">0%</span>; <span class="error">\</span>
                <span class="key">transform</span>: <span class="error">s</span><span class="error">c</span><span class="error">a</span><span class="error">l</span><span class="error">e</span>(<span class="float">4.05545</span>);<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Bloc-de-texte-standard</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_idContainer009</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;div</span> <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">width</span>: <span class="float">5046px</span>; <span class="key">height</span>: <span class="float">8589px</span>; <span class="key">position</span>: <span class="value">absolute</span>; <span class="error">\</span>
              <span class="key">top</span>: <span class="float">6.11px</span>; <span class="key">left</span>: <span class="float">0px</span>; <span class="key">-webkit-transform-origin</span>: <span class="float">0%</span> <span class="float">0%</span>; <span class="error">\</span>
              <span class="key">-webkit-transform</span>: <span class="error">s</span><span class="error">c</span><span class="error">a</span><span class="error">l</span><span class="error">e</span>(<span class="float">0.05</span>); <span class="key">transform-origin</span>: <span class="float">0%</span> <span class="float">0%</span>; <span class="error">\</span>
              <span class="key">transform</span>: <span class="error">s</span><span class="error">c</span><span class="error">a</span><span class="error">l</span><span class="error">e</span>(<span class="float">0.05</span>);<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;p</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_1_Chapter-Heading_Toc_1 ParaOverride-1</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en-GB</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xml:lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en-GB</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CharOverride-2</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">position</span>: <span class="value">absolute</span>; <span class="key">top</span>: <span class="float">0px</span>; <span class="error">\</span>
                   <span class="key">left</span>: <span class="float">793.7px</span>; <span class="key">letter-spacing</span>: <span class="float">-18px</span>;<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        1. Mes mots
      <span class="tag">&lt;/span&gt;</span>
    <span class="tag">&lt;/p&gt;</span>

    <span class="tag">&lt;p</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_1_IDIOM ParaOverride-1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">position</span>: <span class="value">absolute</span>; <span class="key">top</span>: <span class="float">1250.55px</span>; <span class="error">\</span>
             <span class="key">left</span>: <span class="float">170.08px</span>; <span class="key">letter-spacing</span>: <span class="float">-1px</span>;<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Examples1 CharOverride-4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        Spaced repetition ● Répétition espacée
      <span class="tag">&lt;/span&gt;</span>
    <span class="tag">&lt;/p&gt;</span>
    <span class="tag">&lt;p</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_2_EXEMPLE-IDIOM ParaOverride-1</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">position</span>: <span class="value">absolute</span>; <span class="key">top</span>: <span class="float">1546.89px</span>; <span class="error">\</span>
              <span class="key">left</span>: <span class="float">170.08px</span>; <span class="key">letter-spacing</span>: <span class="float">-3px</span>;<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EXEMPLE-IDIO CharOverride-5</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        Spaced repetition is a learning technique.
      <span class="tag">&lt;/span&gt;</span>
      <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TRADUCTION-EXEMPLE-IDIOM CharOverride-7</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        La répétition espacée est une technique d'apprentissage.
      <span class="tag">&lt;/span&gt;</span>
    <span class="tag">&lt;/p&gt;</span>
    <span class="tag">&lt;p</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WARNING ParaOverride-1</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">position</span>: <span class="value">absolute</span>; <span class="key">top</span>: <span class="float">1950.29px</span>; <span class="error">\</span>
              <span class="key">left</span>: <span class="float">170.08px</span>; <span class="key">letter-spacing</span>: <span class="float">-1px</span>;<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CharOverride-10</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        Note: Un logiciel facilitation la répétition espacée
        est appelé SRS (Spaced Repetition System).
      <span class="tag">&lt;/span&gt;</span>
    <span class="tag">&lt;/p&gt;</span>
  <span class="tag">&lt;/div&gt;</span>
<span class="tag">&lt;/div&gt;</span>
<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we simplify the HTML definition, we get something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>.Bloc-de-texte-standard#_idContainer* --&gt; New page containing expressions
  .*Chapter-Heading_Toc* ---------------&gt; New category found

  ._1_IDIOM ----------------------------&gt; New idiom found
  .EXEMPLE-IDIO ------------------------&gt; An example of the idiom examples
  .WARNING -----------------------------&gt; A warning to complement the idiom

(Where * matches one or many characters)</pre>
</div>
</div>
<div class="paragraph">
<p>We now have all the necessary information to begin our program. As usual, we will write our program in Python, the same language used by Anki.</p>
</div>
<div class="paragraph">
<p>First, we need to open each HTML page and check if this page contains idioms or not:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">codecs</span>

<span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">2</span>, <span class="integer">3</span>): <span class="comment"># Only page 2 exists in our demo ebook...</span>

    <span class="comment"># Read the page content</span>
    f = codecs.open(<span class="string"><span class="delimiter">&quot;</span><span class="content">myepub/OEBPS/Page_%s.html</span><span class="delimiter">&quot;</span></span> % i, <span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>)
    page_html = f.read()
    f.close()

    <span class="comment"># Parse the HTML</span>
    soup = BeautifulSoup(page_html, <span class="string"><span class="delimiter">'</span><span class="content">html.parser</span><span class="delimiter">'</span></span>)

    <span class="comment"># Search the page content</span>
    <span class="keyword">for</span> bloc <span class="keyword">in</span> soup.find_all(<span class="string"><span class="delimiter">'</span><span class="content">div</span><span class="delimiter">'</span></span>, { <span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">Bloc-de-texte-standard</span><span class="delimiter">'</span></span>}):

        <span class="comment"># Only page with id beginning by _idContainer contains idioms</span>
        <span class="keyword">if</span> bloc.get(<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>) <span class="keyword">and</span> bloc.get(<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>).startswith(<span class="string"><span class="delimiter">'</span><span class="content">_idContainer</span><span class="delimiter">'</span></span>):
            process_block(soup, bloc)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, for each block of idioms, the function <code>process_block</code> is called. This method takes two parameters:
- the BeautifulSoup HTML parser,
- the working HTML element</p>
</div>
<div class="paragraph">
<p>As some idioms cross two pages, we need to keep the chapter number (idioms are grouped by general subjects), the category (each subject is divided into many related categories) and the current idiom to complete it when we will parsed the next page. To do so, we will use global variables (not good OO-design but an adequate choice for such a simple program). The code consists of a loop to iterate over paragraphs and uses CSS classes to determine the type of each paragraph (idiom, example or warning). Here is the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">process_block</span>(soup, bloc_element):
    <span class="keyword">global</span> chapter
    <span class="keyword">global</span> category
    <span class="keyword">global</span> idiom

    <span class="keyword">for</span> p <span class="keyword">in</span> bloc_element.find_all(<span class="string"><span class="delimiter">'</span><span class="content">p</span><span class="delimiter">'</span></span>):

        classes = p.get(<span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>)

        found = <span class="predefined-constant">False</span>
        <span class="keyword">for</span> classe <span class="keyword">in</span> classes:
            <span class="keyword">if</span> <span class="string"><span class="modifier">u</span><span class="delimiter">'</span><span class="content">Chapter-Heading_Toc</span><span class="delimiter">'</span></span> <span class="keyword">in</span> classe \
            <span class="keyword">or</span> <span class="string"><span class="modifier">u</span><span class="delimiter">'</span><span class="content">chaper-headibg-2-chiffres</span><span class="delimiter">'</span></span> <span class="keyword">in</span> classe:
                found = <span class="predefined-constant">True</span>
                category = p.get_text()
                index = category.index(<span class="string"><span class="delimiter">'</span><span class="content">. </span><span class="delimiter">'</span></span>)
                <span class="keyword">if</span> index:
                    chapter = category[:index]
                    category = category[index+<span class="integer">2</span>:]
                <span class="keyword">print</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Beginning category %s</span><span class="delimiter">&quot;</span></span> % category

        <span class="keyword">if</span> found:
            <span class="keyword">continue</span>

        <span class="keyword">if</span> <span class="string"><span class="modifier">u</span><span class="delimiter">'</span><span class="content">_1_IDIOM</span><span class="delimiter">'</span></span> <span class="keyword">in</span> classes: <span class="comment"># New idiom</span>
            idiom = Idiom(chapter, category)
            idioms.append(idiom)
            text = p.get_text()

            <span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">●</span><span class="delimiter">'</span></span> <span class="keyword">in</span> text:
                index = text.index(<span class="string"><span class="delimiter">'</span><span class="content">●</span><span class="delimiter">'</span></span>)
                idiom.set_en(text[:index])
                idiom.set_fr(text[index+<span class="integer">1</span>:])
            <span class="keyword">else</span>:
                idiom.set_en(p.get_text())
        <span class="keyword">elif</span> <span class="string"><span class="modifier">u</span><span class="delimiter">'</span><span class="content">_2_EXEMPLE-IDIOM</span><span class="delimiter">'</span></span> <span class="keyword">in</span> classes: <span class="comment"># Example for previous idiom</span>
            text = p.get_text()
            <span class="keyword">if</span> <span class="string"><span class="delimiter">'</span><span class="content">. </span><span class="delimiter">'</span></span> <span class="keyword">in</span> text:
                index = text.index(<span class="string"><span class="delimiter">'</span><span class="content">. </span><span class="delimiter">'</span></span>)
                idiom.add_example({
                  <span class="string"><span class="delimiter">'</span><span class="content">en</span><span class="delimiter">'</span></span>: text[:index + <span class="integer">1</span>], <span class="string"><span class="delimiter">'</span><span class="content">fr</span><span class="delimiter">'</span></span>: text[index +<span class="integer">2</span>:] })
            <span class="keyword">elif</span> <span class="string"><span class="delimiter">'</span><span class="content">? </span><span class="delimiter">'</span></span> <span class="keyword">in</span> text:
                index = text.index(<span class="string"><span class="delimiter">'</span><span class="content">? </span><span class="delimiter">'</span></span>)
                idiom.add_example({
                  <span class="string"><span class="delimiter">'</span><span class="content">en</span><span class="delimiter">'</span></span>: text[:index + <span class="integer">1</span>], <span class="string"><span class="delimiter">'</span><span class="content">fr</span><span class="delimiter">'</span></span>: text[index +<span class="integer">2</span>:] })
            <span class="keyword">elif</span> <span class="string"><span class="delimiter">'</span><span class="content">! </span><span class="delimiter">'</span></span> <span class="keyword">in</span> text:
                index = text.index(<span class="string"><span class="delimiter">'</span><span class="content">! </span><span class="delimiter">'</span></span>)
                idiom.add_example({
                  <span class="string"><span class="delimiter">'</span><span class="content">en</span><span class="delimiter">'</span></span>: text[:index + <span class="integer">1</span>], <span class="string"><span class="delimiter">'</span><span class="content">fr</span><span class="delimiter">'</span></span>: text[index +<span class="integer">2</span>:] })
            <span class="keyword">elif</span> <span class="string"><span class="delimiter">'</span><span class="content">.”</span><span class="delimiter">'</span></span> <span class="keyword">in</span> text:
                index = text.index(<span class="string"><span class="delimiter">'</span><span class="content">.”</span><span class="delimiter">'</span></span>)
                idiom.add_example({
                  <span class="string"><span class="delimiter">'</span><span class="content">en</span><span class="delimiter">'</span></span>: text[:index + <span class="integer">2</span>], <span class="string"><span class="delimiter">'</span><span class="content">fr</span><span class="delimiter">'</span></span>: text[index +<span class="integer">2</span>:] })
            <span class="keyword">else</span>:
                <span class="keyword">print</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">[ERROR] Unable to find translation in example '%s'</span><span class="delimiter">&quot;</span></span> \
                      % text
        <span class="keyword">elif</span> <span class="string"><span class="modifier">u</span><span class="delimiter">'</span><span class="content">WARNING</span><span class="delimiter">'</span></span> <span class="keyword">in</span> classes: <span class="comment"># WARNING</span>
            idiom.add_warning(p.get_text())
        <span class="keyword">else</span>:
            <span class="keyword">print</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">[ERROR] Unknown class %s</span><span class="delimiter">&quot;</span></span> % (classes)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid being polluted with all the <code>span</code> tag present in the source (the original epub contains a lot more span!), we use the method <code>get_text()</code> of the Soup parser to only extract the raw text. If the paragraph is an idiom, we know the english and french translations are separated by the special character ●. If the paragraph is an example, we search for a phrase separator (dot, question mark, exclamation point, etc). If the paragraph is a warning, we just have the keep the whole text.</p>
</div>
<div class="paragraph">
<p>For each idiom, we create a new object of type <code>Idiom</code> to group all the information about a given idiom. The collection of idioms is defined globally and will be reused in the second section of this blog post. Here is the definition of the class <code>Idiom</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">Idiom</span>:

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, chapter, category):
        <span class="predefined-constant">self</span>.category = category
        <span class="predefined-constant">self</span>.chapter = chapter
        <span class="predefined-constant">self</span>.en = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>
        <span class="predefined-constant">self</span>.fr = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>
        <span class="predefined-constant">self</span>.examples = []
        <span class="predefined-constant">self</span>.warnings = []

    <span class="keyword">def</span> <span class="function">set_category</span>(<span class="predefined-constant">self</span>, category):
        <span class="predefined-constant">self</span>.category = category

    <span class="keyword">def</span> <span class="function">set_en</span>(<span class="predefined-constant">self</span>, expression):
        <span class="predefined-constant">self</span>.en = expression

    <span class="keyword">def</span> <span class="function">set_fr</span>(<span class="predefined-constant">self</span>, expression):
        <span class="predefined-constant">self</span>.fr = expression

    <span class="keyword">def</span> <span class="function">add_example</span>(<span class="predefined-constant">self</span>, example):
        <span class="predefined-constant">self</span>.examples.append(example)

    <span class="keyword">def</span> <span class="function">add_warning</span>(<span class="predefined-constant">self</span>, text):
        <span class="predefined-constant">self</span>.warnings.append(text)

<span class="comment"># List of all idioms</span>
idioms = []</code></pre>
</div>
</div>
<div class="paragraph">
<p>This ends the first section of this post. We have extracted all the relevant text from the ebook. The next big task is to load all of these idioms directly inside Anki.</p>
</div>
</div>
<div class="sect2">
<h3 id="part_ii_bulk_loading_the_flashcards">Part II: Bulk loading the flashcards</h3>
<div class="paragraph">
<p>Before importing a flashcard, we need to design the card template. By default, Anki includes only simple card types: Basic, Basic (with reversed card). These card types have only two fields: the front text, and the back text. We need something more evolved to be able to includes examples and/or note information. We want our cards to look like the following picture:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/english-card-type.png" alt="english card type">
</div>
</div>
<div class="paragraph">
<p>We have two solutions: either we create the card type manually using the Anki API directly in Python, or create the card type through the GUI to benefit the direct feedback when defining the CSS declarations. We will choose the second solution but implementing the first one is relatively easy using code similar to the code we already wrote.</p>
</div>
<div class="paragraph">
<p>So, run the Anki program, and go to <strong>"Tools &gt; Manage Note Types&#8230;&#8203;"</strong>, click on <strong>"Add"</strong>, and choose <strong>"Clone: Basic (with reversed card)"</strong> as the model to clone. Name our note type <strong>Idiom</strong>.</p>
</div>
<div class="paragraph">
<p>Return to the "Manage Note Types" screen and click on <strong>"Fields&#8230;&#8203;"</strong>. Remove the <code>Front</code> and <code>Back</code> fields and add four new fields like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/note-type-fields.png" alt="note type fields">
</div>
</div>
<div class="paragraph">
<p>Close the dialog and click on <strong>"Cards&#8230;&#8203;"</strong>. Again, we need the update the content to match the following screenshot:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/note-type-card1.png" alt="note type card1">
</div>
</div>
<div class="paragraph">
<p>Here is the full CSS code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="css"><span class="class">.card</span> {
 <span class="key">font-family</span>: <span class="value">arial</span>, <span class="value">sans-serif</span>;
 <span class="key">font-size</span>: <span class="float">20px</span>;
 <span class="key">text-align</span>: <span class="value">center</span>;
 <span class="key">color</span>: <span class="value">black</span>;
 <span class="key">background-color</span>: <span class="value">white</span>;
}

<span class="class">.qualifier</span> {
  <span class="key">color</span>: <span class="value">black</span>;
  <span class="key">font-style</span>: <span class="value">italic</span>;
  <span class="key">font-weight</span>: <span class="value">normal</span>;
  <span class="key">font-size</span>: <span class="float">80%</span>;
  <span class="key">letter-spacing</span>: <span class="float">-1px</span>;
}

<span class="class">.idiom</span> <span class="class">.english</span> {
  <span class="key">font-weight</span>: <span class="value">bold</span>;
  <span class="key">font-size</span>: <span class="float">110%</span>;
}

<span class="class">.example</span> {
  <span class="key">font-size</span>: <span class="float">18px</span>;
  <span class="key">font-style</span>: <span class="value">italic</span>;
  <span class="key">letter-spacing</span>: <span class="float">-1px</span>;
  <span class="key">line-height</span>: <span class="float">130%</span>;
}

<span class="class">.english</span> {
  <span class="key">color</span>: <span class="color">#39499b</span>
}
<span class="class">.french</span> {
  <span class="key">color</span>: <span class="value">black</span>;
}

<span class="class">.note</span> {
  <span class="key">color</span>: <span class="color">#333</span>;
  <span class="key">font-size</span>: <span class="float">16px</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The back card is very similar. You only need to invert the <code>French</code> and <code>English</code> fields as shown in the following screenshot:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/note-type-card2.png" alt="note type card2">
</div>
</div>
<div class="paragraph">
<p>Then, close Anki to force it to write the changes to disk. Let&#8217;s go back to our program to add a new line at the end of the source code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">bulk_loading_anki(idioms)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function <code>bulk_loading_anki</code> iterate over the idioms, and create a new note for each of them. Before that, we need to retrieve our new note type <code>Idiom</code> to define it as the default (like we do when we use Anki through the UI). We also need to retrieve the deck in which to create the notes (<code>English</code> in our example but any deck would works too). Here is the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">bulk_loading_anki</span>(idioms):

    <span class="comment"># Load the anki collection</span>
    cpath = os.path.join(PROFILE_HOME, <span class="string"><span class="delimiter">&quot;</span><span class="content">collection.anki2</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    col = Collection(cpath, log=<span class="predefined-constant">True</span>) <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="comment"># Set the model</span>
    modelBasic = col.models.byName(<span class="string"><span class="delimiter">'</span><span class="content">Idiom</span><span class="delimiter">'</span></span>)
    col.decks.current()[<span class="string"><span class="delimiter">'</span><span class="content">mid</span><span class="delimiter">'</span></span>] = modelBasic[<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>]

    <span class="comment"># Get the deck</span>
    deck = col.decks.byName(<span class="string"><span class="delimiter">&quot;</span><span class="content">English</span><span class="delimiter">&quot;</span></span>)

    <span class="comment"># Iterate over idioms</span>
    <span class="keyword">for</span> idiom <span class="keyword">in</span> idioms:

        <span class="comment"># Instantiate the new note</span>
        note = col.newNote()
        note.model()[<span class="string"><span class="delimiter">'</span><span class="content">did</span><span class="delimiter">'</span></span>] = deck[<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>]

        <span class="comment"># Set the content</span>
        english_field = highlight_qualifier(idiom.en)
        french_field = highlight_qualifier(idiom.fr)
        examples_field = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="comment"># fill below</span>
        note_field =  <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="comment"># fill below</span>

        <span class="keyword">if</span> <span class="keyword">not</span> idiom.en:
            <span class="comment"># Should not happen</span>
            <span class="keyword">continue</span>
        <span class="keyword">if</span> <span class="keyword">not</span> idiom.fr <span class="keyword">and</span> idiom.examples:
            <span class="comment"># Sometimes, there is not translation in french,</span>
            <span class="comment"># we used the first example phrase instead</span>
            english_field = idiom.examples[<span class="integer">0</span>][<span class="string"><span class="delimiter">'</span><span class="content">en</span><span class="delimiter">'</span></span>]
            french_field = idiom.examples[<span class="integer">0</span>][<span class="string"><span class="delimiter">'</span><span class="content">fr</span><span class="delimiter">'</span></span>]
        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">(familier)</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> idiom.en:
            french_field += <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> + highlight_qualifier(<span class="string"><span class="delimiter">'</span><span class="content">(familier)</span><span class="delimiter">'</span></span>)

        <span class="keyword">for</span> example <span class="keyword">in</span> idiom.examples:
            examples_field += <span class="string"><span class="delimiter">'</span><span class="content">&lt;p class=&quot;example&quot;&gt;</span><span class="delimiter">'</span></span> +
               <span class="string"><span class="delimiter">'</span><span class="content">&lt;span class=&quot;english&quot;&gt;%s&lt;/span&gt; </span><span class="delimiter">'</span></span> +
               <span class="string"><span class="delimiter">'</span><span class="content">&lt;span class=&quot;french&quot;&gt;%s&lt;/span&gt;</span><span class="delimiter">'</span></span> +
               <span class="string"><span class="delimiter">'</span><span class="content">&lt;/p&gt;</span><span class="delimiter">'</span></span> \
                % (example[<span class="string"><span class="delimiter">'</span><span class="content">en</span><span class="delimiter">'</span></span>], example[<span class="string"><span class="delimiter">'</span><span class="content">fr</span><span class="delimiter">'</span></span>]) <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="keyword">for</span> warning <span class="keyword">in</span> idiom.warnings:
            note_field += <span class="string"><span class="delimiter">'</span><span class="content">&lt;p class=&quot;warning&quot;&gt;%s&lt;p&gt;</span><span class="delimiter">'</span></span> % warning

        note.fields[<span class="integer">0</span>] = english_field <i class="conum" data-value="4"></i><b>(4)</b>
        note.fields[<span class="integer">1</span>] = french_field
        note.fields[<span class="integer">2</span>] = examples_field
        note.fields[<span class="integer">3</span>] = note_field

        <span class="keyword">print</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">{</span><span class="char">\n</span><span class="content">English: %s,</span><span class="char">\n</span><span class="content">French: %s,</span><span class="char">\n</span><span class="content">Examples: %s,</span><span class="char">\n</span><span class="content">Notes: %s}</span><span class="delimiter">&quot;</span></span> % (
            note.fields[<span class="integer">0</span>], note.fields[<span class="integer">1</span>], note.fields[<span class="integer">2</span>], note.fields[<span class="integer">3</span>])

        <span class="comment"># Set the tags (and add the new ones to the deck configuration</span>
        tags = <span class="string"><span class="delimiter">&quot;</span><span class="content">idiom</span><span class="delimiter">&quot;</span></span>
        note.tags = col.tags.canonify(col.tags.split(tags))
        m = note.model()
        m[<span class="string"><span class="delimiter">'</span><span class="content">tags</span><span class="delimiter">'</span></span>] = note.tags
        col.models.save(m)

        <span class="comment"># Add the note</span>
        col.addNote(note)

    <span class="comment"># Save the changes to DB</span>
    col.save() <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Load the collection from the local disk.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The code reflects the Anki terminology (note, card, field, deck, tag, etc). If some term are unclear to you, check the official documentation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>CSS classes defined in the note type could be used to stylize our cards. Unlike the desktop application, HTML is not escaped.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The order of the fields should follow the same order as defined in the GUI.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Without the explicit call to the <code>save</code> method, the flashcards would not be saved to disk. Indeed, the Anki application schedules a task every 5 minutes to call this method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The function <code>highlight_qualifier</code> used in the previous code is defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">highlight_qualifier</span>(text):
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content"> Surround text in parenthesis with a stylized HTML tag. </span><span class="delimiter">&quot;&quot;&quot;</span></span>
    <span class="keyword">return</span> re.sub(<span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">[(](.*?)[)]</span><span class="delimiter">'</span></span>, <span class="string"><span class="modifier">r</span><span class="delimiter">'</span><span class="content">&lt;span class=&quot;qualifier&quot;&gt;(</span><span class="content">\1</span><span class="content">)&lt;/span&gt;</span><span class="delimiter">'</span></span>, text)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rerun the program and open Anki again. You should see thousands of new card to study! (Go to <strong>"Browse"</strong> and select the <strong>"idiom"</strong> tag to see them all).</p>
</div>
<div class="paragraph">
<p>Our case study is finished. We have converted an ebook purchased online into thousands of flashcards with just one hundred line of code. In the next case study, we are going to create flashcards for the most common words in a language (the first step in practice before learning idioms but this use case is far more complex to automate, the reason why we invert the order in this post).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="case_study_learn_the_5000_most_frequent_words">Case Study: Learn the 5000 most frequent words</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Learning the vocabulary of a new language is probably one the best use case for Anki. Many famous polyglot use it daily to practice their vocabulary. To help us identify the list of frequent words in our target language, you can buy a frequency book on Amazon, or you can use free resources like Wikipedia: <a href="https://en.wiktionary.org/wiki/Wiktionary:Frequency_lists" class="bare">https://en.wiktionary.org/wiki/Wiktionary:Frequency_lists</a>.</p>
</div>
<div class="paragraph">
<p>In this post, we are targeting the English language and will use Wikipedia.</p>
</div>
<div class="sect2">
<h3 id="the_frequency_list">The frequency list</h3>
<div class="paragraph">
<p>Wikipedia currently offers multiple frequency lists based on different sources: films, project Gutenberg containing thousand of freely available classic romans, and even the integral of the Simpsons episodes. The lists are split in several pages (1-999, 1000-1999, and so on). By using the browser developer tool, we could easily extract the HTML to create a single HTML file containing the entire list. Here is a sample of the extracted list based on the project Gutenberg:</p>
</div>
<div class="listingblock">
<div class="title">40000_frequency_list_gutenberg.txt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;table&gt;</span>
<span class="tag">&lt;thead&gt;</span>
<span class="tag">&lt;tr&gt;</span>
<span class="tag">&lt;td&gt;</span><span class="tag">&lt;b&gt;</span>Rank<span class="tag">&lt;/b&gt;</span><span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;td&gt;</span><span class="tag">&lt;b&gt;</span>Word<span class="tag">&lt;/b&gt;</span><span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;td&gt;</span><span class="tag">&lt;b&gt;</span>Count (per billion)<span class="tag">&lt;/b&gt;</span><span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;/tr&gt;</span>
<span class="tag">&lt;/thead&gt;</span>
<span class="tag">&lt;tbody&gt;</span>
<span class="tag">&lt;tr&gt;</span>
<span class="tag">&lt;td&gt;</span>1<span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;td&gt;</span><span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/the</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">title</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">the</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>the<span class="tag">&lt;/a&gt;</span><span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;td&gt;</span>56271872<span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;/tr&gt;</span>
<span class="tag">&lt;tr&gt;</span>
<span class="tag">&lt;td&gt;</span>2<span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;td&gt;</span><span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/of</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">title</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">of</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>of<span class="tag">&lt;/a&gt;</span><span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;td&gt;</span>33950064<span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;/tr&gt;</span>
<span class="tag">&lt;tr&gt;</span>
<span class="tag">&lt;td&gt;</span>3<span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;td&gt;</span><span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/and</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">title</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">and</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>and<span class="tag">&lt;/a&gt;</span><span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;td&gt;</span>29944184<span class="tag">&lt;/td&gt;</span>
<span class="tag">&lt;/tr&gt;</span>
... <span class="comment">&lt;!-- 39 997 other entries --&gt;</span>
<span class="tag">&lt;/tbody&gt;</span>
<span class="tag">&lt;/table&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Like your browser, most HTML parsers are very tolerant concerning HTML syntax. We don&#8217;t need to create a perfectly valid HTML document to be able to parse it. We will continue to use the Python language, and its most popular HTML parser <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">BeautifulSoup</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a basic program to parse this HTML file and generate a csv file:</p>
</div>
<div class="listingblock">
<div class="title">html2csv.python</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment">#/usr/bin/python</span>

<span class="keyword">from</span> <span class="include">bs4</span> <span class="keyword">import</span> <span class="include">BeautifulSoup</span>
<span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> <span class="predefined">len</span>(sys.argv) != <span class="integer">2</span>:
  print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Usage: python $0 &lt;file.html&gt;</span><span class="delimiter">&quot;</span></span>)
  sys.exit(<span class="integer">1</span>)


html_file = sys.argv[<span class="integer">1</span>]
<span class="keyword">with</span> <span class="predefined">open</span>(html_file, <span class="string"><span class="delimiter">'</span><span class="content">r</span><span class="delimiter">'</span></span>) <span class="keyword">as</span> input_file:
    html_doc = input_file.read()
    soup = BeautifulSoup(html_doc, <span class="string"><span class="delimiter">'</span><span class="content">html.parser</span><span class="delimiter">'</span></span>)
    <span class="keyword">for</span> tr <span class="keyword">in</span> soup.select(<span class="string"><span class="delimiter">'</span><span class="content">tbody tr</span><span class="delimiter">'</span></span>):
      cells = tr.find_all(<span class="string"><span class="delimiter">'</span><span class="content">td</span><span class="delimiter">'</span></span>)
      print(<span class="string"><span class="delimiter">'</span><span class="content">,</span><span class="delimiter">'</span></span>.join(c.get_text() <span class="keyword">for</span> c <span class="keyword">in</span> cells))</code></pre>
</div>
</div>
<div class="paragraph">
<p>To convert the previous HTML file to a CSV file, launch the program using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ python html2csv.py 40000_frequency_list_gutenberg.html &gt; \
      40000_frequency_list_gutenberg.csv</pre>
</div>
</div>
<div class="paragraph">
<p>Project Gutenberg is a wonderful place to find famous old roman but we could miss usual words nowadays, so we do the same task with the TV frequency list. This results in two files <code>40000_frequency_list_gutenberg.csv</code> and <code>40000_frequency_list_tv.csv</code> having most of the words in common but with different rankings. We need to merge the two list.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/assistant-merge-frequency-lists.png" alt="assistant merge frequency lists">
</div>
</div>
<div class="paragraph">
<p>Here is a small program to produce a unique CSV file containing only two fields: the rank and the word.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">import</span> <span class="include">codecs</span>
<span class="keyword">import</span> <span class="include">operator</span>


<span class="comment"># Contains the merge of the two lists.</span>
frequencies = {}
<span class="comment"># word: [rank_1, rank_2] if present in both files</span>


<span class="keyword">def</span> <span class="function">fill_words</span>(filename):
    <span class="keyword">global</span> frequencies

    <span class="keyword">for</span> line <span class="keyword">in</span> codecs.open(filename, <span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>):
        (rank, word, frequency) = line.split(<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>)
        <span class="keyword">if</span> <span class="keyword">not</span> word <span class="keyword">in</span> frequencies:
            frequencies[word] = []
        frequencies[word].append(<span class="predefined">int</span>(rank))


<span class="comment"># Read the files to parse</span>
fill_words(<span class="string"><span class="delimiter">&quot;</span><span class="content">40000_frequency_list_gutenberg.csv</span><span class="delimiter">&quot;</span></span>)
fill_words(<span class="string"><span class="delimiter">&quot;</span><span class="content">40000_frequency_list_tv.csv</span><span class="delimiter">&quot;</span></span>)


<span class="comment"># Calculate the average rank (ex: TV 30250, Gutenberg 27500 =&gt; 28875)</span>
frequencies_avg = {}
<span class="keyword">for</span> word, ranks <span class="keyword">in</span> frequencies.iteritems():
    rank = <span class="predefined">int</span>(<span class="predefined">reduce</span>(<span class="keyword">lambda</span> x, y: x + y, ranks) / <span class="predefined">len</span>(ranks))
    frequencies_avg[word] = rank


<span class="comment"># Sort the dictionary by value (rank)</span>
frequencies_sorted = <span class="predefined">sorted</span>(frequencies_avg.items(),
                       key=operator.itemgetter(<span class="integer">1</span>))


<span class="comment"># Output a new CSV with incrementing rank</span>
<span class="comment"># (previous ranking calculation produces words with the same rank)</span>
i = <span class="integer">0</span>
<span class="keyword">for</span> word, rank <span class="keyword">in</span> frequencies_sorted:
    i += <span class="integer">1</span>
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">%s,%s</span><span class="delimiter">&quot;</span></span> % (i, word))</code></pre>
</div>
</div>
<div class="paragraph">
<p>To generate the new list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ python calculate_frequency_list.py &gt; my_english_frequency_list.csv</pre>
</div>
</div>
<div class="paragraph">
<p>If we inspect the resulting file, we notice numerous unwanted words such as "Mickey." Let&#8217;s remove them by updating our program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">filter</span>(word):
    <span class="comment"># Remove Proper name (ex: Mickey)</span>
    <span class="keyword">if</span> word[<span class="integer">0</span>].isupper():
        <span class="keyword">return</span> <span class="predefined-constant">True</span>
    <span class="comment"># Remove single length word (ex: I)</span>
    <span class="keyword">if</span> <span class="predefined">len</span>(word) == <span class="integer">1</span>:
        <span class="keyword">return</span> <span class="predefined-constant">True</span>
    <span class="comment"># Remove abbreviation (ex: can't)</span>
    <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">'</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> word:
        <span class="keyword">return</span> <span class="predefined-constant">True</span>
    <span class="comment"># Remove word containing a digit (ex: 8th)</span>
    <span class="keyword">if</span> <span class="predefined">any</span>(char.isdigit() <span class="keyword">for</span> char <span class="keyword">in</span> word):
        <span class="keyword">return</span> <span class="predefined-constant">True</span>
    <span class="comment"># Remove abbreviation ending with . (ex: Mr.)</span>
    <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">.</span><span class="delimiter">&quot;</span></span> in word:
        <span class="keyword">return</span> <span class="predefined-constant">True</span>
    <span class="keyword">return</span> <span class="predefined-constant">False</span>

frequencies_avg = {}
<span class="keyword">for</span> word, ranks <span class="keyword">in</span> frequencies.iteritems():
    <span class="keyword">if</span> <span class="predefined">filter</span>(word): <span class="comment"># New</span>
        <span class="keyword">continue</span>     <span class="comment"># New</span>
    rank = <span class="predefined">int</span>(<span class="predefined">reduce</span>(<span class="keyword">lambda</span> x, y: x + y, ranks) / <span class="predefined">len</span>(ranks))
    frequencies_avg[word] = rank</code></pre>
</div>
</div>
<div class="paragraph">
<p>We still have not finished. If we look again at the output, we notice words sharing the same radical (ex: bill/bills, displease/displeased). These words could not be filtered as before but could only be removed at the end of the program (when we are sure we have found the different syntaxes).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/assistant-filter-words.png" alt="assistant filter words">
</div>
</div>
<div class="paragraph">
<p>So, let&#8217;s update our program to add the following code just before printing the result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">frequencies_avg_copy = frequencies_avg.copy() <span class="comment"># Work on a copy</span>
                                              <span class="comment"># to delete during iteration</span>
<span class="keyword">for</span> word, rank <span class="keyword">in</span> frequencies_avg_copy.iteritems():

    <span class="keyword">if</span> word.endswith(<span class="string"><span class="delimiter">&quot;</span><span class="content">ing</span><span class="delimiter">&quot;</span></span>): <span class="comment"># eat/eating</span>
        adverb_word = word
        verb = word[:<span class="predefined">len</span>(word) - <span class="integer">3</span>]
        <span class="keyword">if</span> adverb_word <span class="keyword">in</span> frequencies_avg <span class="keyword">and</span> verb <span class="keyword">in</span> frequencies_avg:
            <span class="keyword">del</span> frequencies_avg[adverb_word]

    <span class="keyword">if</span> word.endswith(<span class="string"><span class="delimiter">&quot;</span><span class="content">ies</span><span class="delimiter">&quot;</span></span>): <span class="comment"># lady/ladies</span>
        third_person_verb = word
        verb = word[:<span class="predefined">len</span>(word) - <span class="integer">3</span>] + <span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">if</span> third_person_verb <span class="keyword">in</span> frequencies_avg <span class="keyword">and</span> verb <span class="keyword">in</span> frequencies_avg:
            <span class="keyword">del</span> frequencies_avg[third_person_verb]

    <span class="keyword">if</span> word.endswith(<span class="string"><span class="delimiter">&quot;</span><span class="content">ed</span><span class="delimiter">&quot;</span></span>):
        adjective_word = word

        word1 = word[:<span class="predefined">len</span>(word) - <span class="integer">2</span>] <span class="comment"># fill =&gt; filled</span>
        <span class="keyword">if</span> adjective_word <span class="keyword">in</span> frequencies_avg <span class="keyword">and</span> word1 <span class="keyword">in</span> frequencies_avg:
            <span class="keyword">del</span> frequencies_avg[adjective_word]

        word2 = word[:<span class="predefined">len</span>(word) - <span class="integer">1</span>] <span class="comment"># displease =&gt; displeased</span>
        <span class="keyword">if</span> adjective_word <span class="keyword">in</span> frequencies_avg <span class="keyword">and</span> word2 <span class="keyword">in</span> frequencies_avg:
            <span class="keyword">del</span> frequencies_avg[adjective_word]

    <span class="keyword">if</span> word.endswith(<span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>): <span class="comment"># bill/bills</span>
        plural_word = word
        singular_word = word[:<span class="predefined">len</span>(word) - <span class="integer">1</span>]
        <span class="keyword">if</span> plural_word <span class="keyword">in</span> frequencies_avg <span class="keyword">and</span> singular_word <span class="keyword">in</span> frequencies_avg:
            <span class="keyword">del</span> frequencies_avg[plural_word]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the_definitions">The definitions</h3>
<div class="paragraph">
<p>When learning a new language, it is better to left out completely your tongue language of our flashcards. Popular flashcard application Memrise does exactly that. Instead, we will include the definitions written in the same language as the word. To do so, we will use Wiktionary. Like its sister project Wikipedia, Wiktionary is run by the Wikimedia Foundation, and is edited collaboratively by volunteers. This dictionary is available in 172 languages and probably contains the most exhaustive list of words (500 000 words for the english dictionary!).</p>
</div>
<div class="sect3">
<h4 id="reading_the_data">Reading the data</h4>
<div class="paragraph">
<p>Wiktionary, like other Wikimedia projects, offers a <a href="https://en.wiktionary.org/w/api.php">REST API</a> to retrieve a single page. The API is still in active development. Another option is to exploit the <a href="https://dumps.wikimedia.org/">generated dumps</a>. Indeed, Wikimedia hosts numerous dumps of its database (useful for example in natural language processing tasks or for reseach project). The one that interest us is the <a href="https://dumps.wikimedia.org/enwiktionary/">enwiktionary dump</a>, in particular the first archive described as "Articles, templates, media/file descriptions, and primary meta-pages".</p>
</div>
<div class="paragraph">
<p>Once downloaded, we extract the tar.gz archive to find a single XML file with a size of 4,5 GB!</p>
</div>
</div>
<div class="sect3">
<h4 id="parsing_the_wiktionary_dump">Parsing the Wiktionary dump</h4>
<div class="paragraph">
<p>The downloaded file contains every dictionary written in the english language (English &#8658; English, Spanish &#8658; English, &#8230;&#8203;). To avoid parsing the whole file many times, we need to extract only the relevant information.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/assistant-filter-english.png" alt="assistant filter english">
</div>
</div>
<div class="paragraph">
<p>Here is a preview of its content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;mediawiki</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.mediawiki.org/xml/export-0.10/</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.mediawiki.org/xml/export-0.10/</span>
                               <span class="content">http://www.mediawiki.org/xml/export-0.10.xsd</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xml:lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;page&gt;</span>
  <span class="tag">&lt;title&gt;</span>free<span class="tag">&lt;/title&gt;</span>
  <span class="tag">&lt;ns&gt;</span>0<span class="tag">&lt;/ns&gt;</span>
  <span class="tag">&lt;id&gt;</span>19<span class="tag">&lt;/id&gt;</span>
  <span class="tag">&lt;revision&gt;</span>
    <span class="tag">&lt;id&gt;</span>38832709<span class="tag">&lt;/id&gt;</span>
    <span class="tag">&lt;parentid&gt;</span>38719386<span class="tag">&lt;/parentid&gt;</span>
    <span class="tag">&lt;timestamp&gt;</span>2016-06-17T20:55:44Z<span class="tag">&lt;/timestamp&gt;</span>
    <span class="tag">&lt;contributor&gt;</span>
      <span class="tag">&lt;username&gt;</span>DTLHS<span class="tag">&lt;/username&gt;</span>
      <span class="tag">&lt;id&gt;</span>794618<span class="tag">&lt;/id&gt;</span>
    <span class="tag">&lt;/contributor&gt;</span>
    <span class="tag">&lt;comment&gt;</span>/* English */<span class="tag">&lt;/comment&gt;</span>
    <span class="tag">&lt;model&gt;</span>wikitext<span class="tag">&lt;/model&gt;</span>
    <span class="tag">&lt;format&gt;</span>text/x-wiki<span class="tag">&lt;/format&gt;</span>
    <span class="tag">&lt;text</span> <span class="attribute-name">xml:space</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">preserve</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>{{also|-free}}
==English==
{{wikipedia|dab=free}}

===Etymology===
From {{etyl|enm|en}} {{m|enm|free}}, {{m|enm|fre}}, {{m|enm|freo}},
from {{etyl|ang|en}} {{m|ang|frēo||free}}, from {{etyl|gem-pro|en}}
{{m|gem-pro|*frijaz||free}}, from {{etyl|ine-pro|en}}
{{m|ine-pro|*preyH-||to be fond of}}. Cognate with West Frisian
{{m|fy|frij||free}}, Dutch {{m|nl|vrij||free}},
Low German {{m|nds|free||free}},
German {{m|de|frei||free}},
Danish {{m|da|fri||free}}.

The verb comes from {{etyl|enm|en}} {{m|enm|freen}}, {{m|enm|freoȝen}},
from {{etyl|ang|en}} {{m|ang|frēon}}, {{m|ang|frēoġan||to free; make free}}.

===Pronunciation===
* {{IPA|/fɹiː/|lang=en}}
* {{audio|en-us-free.ogg|Audio (US)|lang=en}}
* {{audio|En-uk-free.ogg|Audio (UK)|lang=en}}
* {{rhymes|iː|lang=en}}

[[File:Free Beer.jpg|thumb|A sign advertising '''free''' beer
(obtainable without payment)]]
[[File:Buy one, get one free ^ - geograph.org.uk - 153952.jpg|thumb|A
<span class="entity">&amp;quot;</span>buy one get one '''free'''<span class="entity">&amp;quot;</span> sign at a flower stand
(obtainable without additional payment)]]
[[File:Berkeley Farms Fat-Free Half <span class="entity">&amp;amp;</span> Half.jpg|thumb|This food product
is labelled <span class="entity">&amp;quot;</span>fat '''free'''<span class="entity">&amp;quot;</span>, meaning it contains no fat]]

===Adjective===
{{en-adj|er}}

# {{label|en|social}} [[unconstrained|Unconstrained]].
#: {{ux|en|He was given '''free''' rein to do whatever he wanted.}}
#* {{quote-book|year=1899|author={{w|Stephen Crane}}
|title=[[s:Twelve O'Clock|Twelve O'Clock]]|chapter=1
|passage=There was some laughter, and Roddle was left '''free'''.”}}
...
 <span class="tag">&lt;sha1&gt;</span>sbauh4n08a6ktob42jxeoye85e0w9tb<span class="tag">&lt;/sha1&gt;</span>
  <span class="tag">&lt;/revision&gt;</span>
<span class="tag">&lt;/page&gt;</span>
<span class="comment">&lt;!-- Million of pages... --&gt;</span>
<span class="tag">&lt;/mediawiki&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When parsing such a large file, we should be careful and not load the full file in memory. A solution is to use a SAX Parser. But unlike a DOM parser, it is not possible to simply traverse the XML document to extract the relevant information. SAX Parsers are event-driven. We need to listen to each new tag, each character text, and so on. We also need to remember our position inside the file to answer question such as "Does the text correspond to the title tag?".</p>
</div>
<div class="paragraph">
<p>The following program extracts the id, title, and text and generates another XML file containing only the English words. The result is a smaller file (less than 300 Mb), that does not take 45 minutes to be parsed on my machine&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="title">parse_wiktionary.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">Parses a XML wiktionary dump using a SAX parser (humongous file!).</span><span class="content">
</span><span class="content">Produces another XML files containing only the english words</span><span class="content">
</span><span class="content">with their id and the full text.</span><span class="content">
</span><span class="delimiter">&quot;&quot;&quot;</span></span>

<span class="keyword">import</span> <span class="include">xml.sax</span>
<span class="keyword">import</span> <span class="include">codecs</span>
<span class="keyword">import</span> <span class="include">sys</span>


<span class="keyword">class</span> <span class="class">ABContentHandler</span>(xml.sax.ContentHandler):

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, frequency_list = <span class="predefined-constant">None</span>):
        xml.sax.ContentHandler.__init__(<span class="predefined-constant">self</span>)
        <span class="predefined-constant">self</span>.frequency_list = frequency_list

        <span class="comment"># Flag to determine our current position inside the XML file</span>
        <span class="predefined-constant">self</span>.in_page = <span class="predefined-constant">False</span>
        <span class="predefined-constant">self</span>.in_id = <span class="predefined-constant">False</span>
        <span class="predefined-constant">self</span>.in_title = <span class="predefined-constant">False</span>
        <span class="predefined-constant">self</span>.in_text = <span class="predefined-constant">False</span>

        <span class="comment"># Variables to hold information about the processed element</span>
        <span class="predefined-constant">self</span>.id = <span class="predefined-constant">None</span>
        <span class="predefined-constant">self</span>.title = <span class="predefined-constant">None</span>
        <span class="predefined-constant">self</span>.text = <span class="predefined-constant">None</span>

        <span class="comment"># Counter to count the number of English word found</span>
        <span class="predefined-constant">self</span>.filtered_words = <span class="integer">0</span>
        <span class="predefined-constant">self</span>.all_words = <span class="integer">0</span>

    <span class="keyword">def</span> <span class="function">startElement</span>(<span class="predefined-constant">self</span>, name, attrs):
        <span class="keyword">if</span> name == <span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>:
            <span class="predefined-constant">self</span>.in_page = <span class="predefined-constant">True</span>
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.in_page <span class="keyword">and</span> name == <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:
            <span class="predefined-constant">self</span>.in_id = <span class="predefined-constant">True</span>
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.in_page <span class="keyword">and</span> name == <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>:
            <span class="predefined-constant">self</span>.in_title = <span class="predefined-constant">True</span>
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.in_page <span class="keyword">and</span> name == <span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>:
            <span class="predefined-constant">self</span>.in_text = <span class="predefined-constant">True</span>
            <span class="predefined-constant">self</span>.text = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>

    <span class="keyword">def</span> <span class="function">characters</span>(<span class="predefined-constant">self</span>, content):
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.in_title:
            <span class="predefined-constant">self</span>.title = content
        <span class="keyword">elif</span> <span class="predefined-constant">self</span>.in_id:
            <span class="predefined-constant">self</span>.id = content
        <span class="keyword">elif</span> <span class="predefined-constant">self</span>.in_text:
            <span class="predefined-constant">self</span>.text += content

    <span class="keyword">def</span> <span class="function">_append_word</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">global</span> output_file
        <span class="predefined-constant">self</span>.filtered_words += <span class="integer">1</span>
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.frequency_list:
            <span class="predefined-constant">self</span>.frequency_list[<span class="predefined-constant">self</span>.title] = <span class="predefined-constant">True</span>
        output_file.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">  &lt;entry&gt;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
        output_file.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">    &lt;id&gt;%s&lt;/id&gt;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> % <span class="predefined-constant">self</span>.id)
        output_file.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">    &lt;title&gt;%s&lt;/title&gt;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> % <span class="predefined-constant">self</span>.title)
        output_file.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">    &lt;text xml:space=</span><span class="char">\&quot;</span><span class="content">preserve</span><span class="char">\&quot;</span><span class="content">&gt;&lt;![CDATA[</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
        output_file.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">%s</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> % <span class="predefined-constant">self</span>.text)
        output_file.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">    ]]&gt;&lt;/text&gt;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
        output_file.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">  &lt;/entry&gt;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)

    <span class="keyword">def</span> <span class="function">endElement</span>(<span class="predefined-constant">self</span>, name):
        <span class="keyword">if</span> name == <span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>:
            <span class="predefined-constant">self</span>.in_page = <span class="predefined-constant">False</span>
            <span class="predefined-constant">self</span>.all_words += <span class="integer">1</span>

            <span class="comment"># Remove non-english words</span>
            <span class="comment"># Remove category title (ex: Index:Spanish)</span>
            <span class="comment"># Remove words beginning by an Uppercase BUG</span>
            <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">==English==</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.text[:<span class="integer">200</span>] \
                    <span class="keyword">and</span> <span class="keyword">not</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.title \
                    <span class="keyword">and</span> <span class="predefined-constant">self</span>.title != <span class="predefined-constant">self</span>.title.title():

                <span class="keyword">if</span> <span class="keyword">not</span> <span class="predefined-constant">self</span>.frequency_list \
                   <span class="keyword">or</span> <span class="predefined-constant">self</span>.title <span class="keyword">in</span> <span class="predefined-constant">self</span>.frequency_list:
                    <span class="predefined-constant">self</span>._append_word()

        <span class="keyword">if</span> <span class="predefined-constant">self</span>.in_page <span class="keyword">and</span> name == <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>:
            <span class="predefined-constant">self</span>.in_title = <span class="predefined-constant">False</span>
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.in_page <span class="keyword">and</span> name == <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:
            <span class="predefined-constant">self</span>.in_id = <span class="predefined-constant">False</span>
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.in_page <span class="keyword">and</span> name == <span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>:
            <span class="predefined-constant">self</span>.in_text = <span class="predefined-constant">False</span>

<span class="keyword">if</span> __name__ == <span class="string"><span class="delimiter">&quot;</span><span class="content">__main__</span><span class="delimiter">&quot;</span></span>:

    <span class="comment"># Read the frequency to filter the words</span>
    frequency_list = {}
    <span class="keyword">for</span> line <span class="keyword">in</span> codecs.open(<span class="string"><span class="delimiter">&quot;</span><span class="content">my_english_frequency_list.csv</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>):
        (rank, word) = line.strip().split(<span class="string"><span class="delimiter">'</span><span class="content">,</span><span class="delimiter">'</span></span>)
        frequency_list[word] = <span class="predefined-constant">False</span>

    <span class="comment"># Read the</span>
    output_file = codecs.open(<span class="string"><span class="delimiter">&quot;</span><span class="content">enwiktionary-frequency.xml</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>)
    output_file.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;dictionary&gt;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
    source = <span class="predefined">open</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">enwiktionary-20160720-pages-articles-multistream.xml</span><span class="delimiter">&quot;</span></span>)
    xml.sax.parse(source, ABContentHandler(frequency_list))
    output_file.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/dictionary&gt;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
    output_file.close()

<span class="comment"># Results:</span>
<span class="comment"># - 34 307 common words extracted from 615 209 English words</span>
<span class="comment">#   among a total of 5 113 338 words.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When running the program, a new file <code>enwiktionary-frequency.xml</code> appears in the current folder. Here is an excerpt of its content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dictionary&gt;</span>
  <span class="tag">&lt;entry&gt;</span>
    <span class="tag">&lt;id&gt;</span>45268<span class="tag">&lt;/id&gt;</span>
    <span class="tag">&lt;title&gt;</span>dictionary<span class="tag">&lt;/title&gt;</span>
    <span class="tag">&lt;text</span> <span class="attribute-name">xml:space</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">preserve</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="inline-delimiter">&lt;![CDATA[</span>
{{also|Dictionary}}
==English==
{{wikipedia|dab=Dictionary (disambiguation)|Dictionary}}

===Etymology===
{{PIE root|en|deyḱ}}
{{etyl|ML.|en}} {{m|la|dictionarium}},
from {{etyl|la|en}} {{m|la|dictionarius}},
from {{m|la|dictio||speaking}}, from {{m|la|dictus}},
perfect past participle of {{m|la|dīcō||speak}} + {{m|la|-arium||room, place}}.

===Pronunciation===
* {{a|RP}} {{IPA|/ˈdɪkʃ(ə)n(ə)ɹɪ/|lang=en}}
* {{a|GenAm|Canada}} {{enPR|dĭk'shə-nĕr-ē}}, {{IPA|/ˈdɪkʃənɛɹi/|lang=en}}
* {{audio|en-us-dictionary.ogg|Audio (US)|lang=en}}
* {{audio|en-uk-dictionary.ogg|Audio (UK)|lang=en}}
* {{hyphenation|dic|tion|ary|lang=en}}

===Noun===
{{en-noun|dictionaries}}

# A [[reference work]] with a list of [[word]]s from one or more languages,
normally ordered [[alphabetical]]ly, explaining each word's meaning,
and sometimes containing information on its etymology, pronunciation,
usage, translations, and other data.
...
    <span class="inline-delimiter">]]&gt;</span><span class="tag">&lt;/text&gt;</span>
  <span class="tag">&lt;/entry&gt;</span>
  <span class="tag">&lt;entry&gt;</span>
    <span class="tag">&lt;id&gt;</span>794618<span class="tag">&lt;/id&gt;</span>
    <span class="tag">&lt;title&gt;</span>free<span class="tag">&lt;/title&gt;</span>
    <span class="tag">&lt;text</span> <span class="attribute-name">xml:space</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">preserve</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="inline-delimiter">&lt;![CDATA[</span>
      ...
    <span class="inline-delimiter">]]&gt;</span><span class="tag">&lt;/text&gt;</span>
  <span class="tag">&lt;/entry&gt;</span>
  ...
<span class="tag">&lt;/dictionary&gt;</span>

===Etymology===</code></pre>
</div>
</div>
<div class="paragraph">
<p>This file could quickly be parsed (10s on my local machine). The next step is to parse the value of the <code>text</code> tag to extract all relevant information.</p>
</div>
</div>
<div class="sect3">
<h4 id="parsing_the_x_wiki_text_to_generate_a_json_file">Parsing the x-wiki text to generate a JSON file</h4>
<div class="paragraph">
<p>The <code>&lt;text&gt;</code> tag contains a x-wiki document whose main syntax is defined <a href="https://platform.xwiki.org/xwiki/bin/view/Main/XWikiSyntax">here</a>. Wikipedia add a lot of semantic above this syntax through the use of numerous labels. I didn&#8217;t find a document that describes the Wiktionary syntax, so we need to revert to reverse engineering.</p>
</div>
<div class="paragraph">
<p>Here is an shortened example of a x-wiki document (about the word <code>keyboard</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{{also|Keyboard}}
==English== <i class="conum" data-value="1"></i><b>(1)</b>
{{wikipedia|dab=keyboard|lang=en}}
[[Image:Player piano keyboard.jpg|thumb|100px|A piano keyboard]]

===Etymology===
From {{compound|key|board|lang=en}}.

===Pronunciation===
* {{a|US}} {{IPA|/ˈkibɔ˞d/|lang=en}}
* {{a|UK|Australia}} {{IPA|/ˈkiːbɔːd/|lang=en}}
* {{audio|En-us-keyboard.ogg|Audio (US)|lang=en}}

===Noun=== <i class="conum" data-value="2"></i><b>(2)</b>
{{en-noun}}

# {{lb|en|computing|etc.}} A set of keys used to operate
a [[typewriter]], [[computer]] etc.
# {{lb|en|music}} A component of many [[instruments]] including the
[[piano]], [[organ]], and [[harpsichord]] consisting of usually black
and white keys that cause different tones to be produced when struck.
# {{lb|en|music}} A device with keys of a musical keyboard, used to control
[[electronic]] sound-producing devices which may be built into or separate
from the keyboard device.

====Synonyms====
* {{sense|electronic musical device}} {{l|en|electronic keyboard}} <i class="conum" data-value="3"></i><b>(3)</b>

====Related terms====
* {{l|en|key}}
* {{l|en|keypad}}

====Translations==== <i class="conum" data-value="4"></i><b>(4)</b>
{{trans-top|set of keys used to operate a typewriter, computer etc.}}
* Breton: {{t|br|klavier|m}}
* Dutch: {{t+|nl|toetsenbord|n}}, {{t+|nl|klavier|n}}
* French: {{t+|fr|clavier|m}} <i class="conum" data-value="3"></i><b>(3)</b>
{{trans-bottom}}

{{trans-top|component of many instruments}}
* Breton: {{t|br|klavier|m}}
*: Mandarin: {{t+|cmn|鍵盤|sc=Hani}}, {{t+|cmn|键盘|tr=jiànpán|sc=Hani}}
* Dutch: {{t+|nl|klavier|n}}, {{t+|nl|keyboard|n}}
* French: {{t+|fr|clavier|m}}
* German: {{t+|de|Tastatur|f}}, {{t+|de|Klaviatur|f}}, {{t+|de|Manual|n}}
{{trans-bottom}}

===Verb=== <i class="conum" data-value="2"></i><b>(2)</b>
{{en-verb}}

# {{lb|en|intransitive}} To [[type]] on a [[computer]] keyboard.
#: '' '''Keyboarding''' is the part of this job I hate the most.''

====Translations==== <i class="conum" data-value="4"></i><b>(4)</b>
{{trans-top|to type in}}
*: Mandarin: {{t+|cmn|打字|tr=dǎzì|sc=Hani}}
* French: {{t+|fr|clavier}}
* Greek: {{t|el|πληκτρογραφώ}}, {{t+|el|πληκτρολογώ}}
{{trans-bottom}}

==Dutch== <i class="conum" data-value="1"></i><b>(1)</b>

===Pronunciation===
* {{audio|Nl-keyboard.ogg|Audio|lang=nl}}
* {{hyphenation|key|board|lang=nl}}

===Etymology===
{{borrowing|en|keyboard|lang=nl}}.

===Noun===
{{nl-noun|n|-s|keyboardje}}

# {{lb|nl|computing|music}} {{l|en|keyboard}}

====Synonyms====
* {{sense|computing}} {{l|nl|toetsenbord}}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A wiktionary entry contains the text of multiple dictionaries (English-English, English-Dutch). Only the English-English dictionary is relevant when learning the English language.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A given word could be used as a noun, a verb, etc. We need to extract the definition for each type while keeping note of the type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Label syntax such as {{t+|fr|clavier|m}} is used exhaustively inside the wiki text. Most of the content is present inside these labels but the syntax is not easily parseable.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>There are many translation blocks. Often, the first one is the only translation we are interested.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On this example, the definitions are easily parseable but not all the words are so simple in practice. Consider the word 'car':</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/posts_resources/2016-12-26-anki-scripting/wiktionary-car.png" alt="wiktionary car" width="750"></span></p>
</div>
<div class="paragraph">
<p>Here the same content as x-wiki:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>====Noun====
{{en-noun}}

# {{lb|en|dated}} A [[wheeled]] [[vehicle]],
drawn by a [[horse]] or other animal.
# A wheeled vehicle that moves independently,
with at least three wheels, powered mechanically,
steered by a driver
#: ''She drove her '''car''' to the mall.'' <i class="conum" data-value="1"></i><b>(1)</b>
#* {{quote-book|year=2006|author=[[w:Edwin Black|Edwin Black]] <i class="conum" data-value="2"></i><b>(2)</b>
|title=Internal Combustion
|chapter=1|url=http://openlibrary.org/works/OL4103950W
|passage=If successful, Edison and Ford—in 1914—
would move society away from the ever more expensive}}
# {{lb|en|rail transport|chiefly|North America}} An unpowered
unit in a [[railroad]] train.
#: ''The conductor coupled the '''cars''' to the locomotive.''</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Quotes could be on a line starting with <code>#:</code>, be surrounded with <code>''</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>While other quotes could be on a line containing a label with the attribute <code>passage</code> containing the quote text.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is only one example of subtlety among many others. Wiktionary syntax is full of surprise but also full of interesting content.</p>
</div>
<div class="paragraph">
<p>So, we will create another Python program to parse the previously generated XML file. The aim of to generate a structured JSON file with only the required information. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">car</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">3184799</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">ipa</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">/k</span><span class="char">\u0251</span><span class="char">\u02d0</span><span class="content">/</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">rank</span><span class="delimiter">&quot;</span></span>:<span class="integer">683</span>,

  <span class="key"><span class="delimiter">&quot;</span><span class="content">audio</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">En-uk-a car.ogg</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">audio_url</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">http://upload.wikimedia.org/wikipedia/ </span><span class="content">\
</span><span class="content">               commons/3/31/En-uk-a car.ogg</span><span class="delimiter">&quot;</span></span>,

  <span class="key"><span class="delimiter">&quot;</span><span class="content">images</span><span class="delimiter">&quot;</span></span>:[
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Diagram for the list (42 69 613). The [[car</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">filename</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Cons-cells.svg</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">thumb_url</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">http://upload.wikimedia.org/wikipedia/commons/ </span><span class="content">\
</span><span class="content">                   thumb/1/1b/Cons-cells.svg/600px-Cons-cells.svg</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">http://upload.wikimedia.org/wikipedia/commons/1/1b/Cons-cells.svg</span><span class="delimiter">&quot;</span></span>
    }
  ],

  <span class="key"><span class="delimiter">&quot;</span><span class="content">types</span><span class="delimiter">&quot;</span></span>:[
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Noun</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">definitions</span><span class="delimiter">&quot;</span></span>:[
        { <span class="key"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">A wheeled vehicle, drawn by a horse or other animal.</span><span class="delimiter">&quot;</span></span> },
        {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">A wheeled vehicle that moves...</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">quotations</span><span class="delimiter">&quot;</span></span>:[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">She drove her &lt;em&gt;car&lt;/em&gt; to the mall.</span><span class="delimiter">&quot;</span></span>
          ]
        },
        {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">(rail transport, chiefly, North America) </span><span class="content">\
</span><span class="content">                  An unpowered unit in a railroad train.</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">quotations</span><span class="delimiter">&quot;</span></span>:[
            <span class="string"><span class="delimiter">&quot;</span><span class="content">The conductor coupled the &lt;em&gt;cars&lt;/em&gt; to the locomotive.</span><span class="delimiter">&quot;</span></span>
          ]
        }
       ]
     }
  ],

  <span class="key"><span class="delimiter">&quot;</span><span class="content">synonyms</span><span class="delimiter">&quot;</span></span>:[
    <span class="string"><span class="delimiter">&quot;</span><span class="content">(private vehicle that moves independently) auto, motorcar</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">(non-powered part of a train) railcar, wagon</span><span class="delimiter">&quot;</span></span>
  ],

  <span class="key"><span class="delimiter">&quot;</span><span class="content">translations</span><span class="delimiter">&quot;</span></span>:[
    <span class="string"><span class="delimiter">&quot;</span><span class="content">char</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">auto</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">automobile</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">voiture</span><span class="delimiter">&quot;</span></span>
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code behind this program contains a lot of parsing logic. The result is not the most beautiful code that I have written and I am not going to present it in this post but if you are curious, the full listing is available in the project repository in <a href="https://github.com/julien-sobczak/anki-scripting/blob/master/anki-usecase-enfrequency/5-parse_mytionary.py">GitHub</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating_the_flashcards">Creating the flashcards</h3>
<div class="paragraph">
<p>Unlike the previous case study on idioms, creating flashcards for vocabulary is most complicated for different reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some word contains more than ten definitions or examples. Should we add them all?</p>
</li>
<li>
<p>Some word would benefit from a memorable image (ex: the word "dog")</p>
</li>
<li>
<p>Some word have a pronunciation sound in Wiktionary</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Moreover, which type of notes should we select in Anki? The "Basic (with reversed card)" is probably too simplistic. Why not find the word from the image only, the sound only, a given definition, or ask for the translation of the word, etc. There are so many possibilities.</p>
</div>
<div class="paragraph">
<p>All of these points highlight that we cannot write a program to automatically take all the decisions. So, we will create a basic web application to display the definitions, the examples, and a list of candidate images retrieved from Google Images. Each of these elements will be accompanied with several checkboxes to choose the most relevant definitions, examples and select the most memorable picture.</p>
</div>
<div class="sect3">
<h4 id="the_assistant">The Assistant</h4>
<div class="paragraph">
<p>The assistant reads the JSON dictionary file created previously, displays its content to the user and save a new annotated JSON file containing the choices made by the user. We will return to this file later.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/assistant-global.png" alt="assistant global">
</div>
</div>
<div class="paragraph">
<p>Here is a screenshot of this application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/anki-vocabulary-assistant.png" alt="anki vocabulary assistant">
</div>
</div>
<div class="paragraph">
<p>To launch locally the web application, you need to first retrieve the source and build the archive: (JDK 1.7 &gt; required)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ git clone https://github.com/julien-sobczak/anki-scripting.git
$ cd anki-scripting/anki-vocabulary-assistant
$ mvn clean package</pre>
</div>
</div>
<div class="paragraph">
<p>Then, run the following command to start the web application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ java \
  -DdeveloperKey=&lt;YOUR_DEVELOPER_KEY&gt; \
  -Dcx=&lt;YOUR_CONTEXT_KEY&gt; \
  -DoutputDir="~/output/" \
  -DdictionaryFile="anki-usecase-enfrequency/resources/mywiktionary.json" \
  -jar target/anki-vocabulary-assistant-0.0.1.jar \</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Google CSE API</div>
<div class="paragraph">
<p>The application uses the Google Custom Search API (GSE) to retrieve a list of images related to the selected word, so you need credentials to access the API. Google limits to 100 free searches per day.</p>
</div>
<div class="paragraph">
<p>Please visit the <a href="https://developers.google.com/custom-search/docs/tutorial/introduction">official site</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open your browser and enter the URL <a href="http://localhost:8080" class="bare">http://localhost:8080</a>. You should have the same output as the previous screenshot.</p>
</div>
<div class="admonitionblock caution content">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Requisites</div>
<div class="paragraph">
<p>In this part, we will use Spring Boot and the Java language for the backend and AngularJS for the frontend. If these technologies are new to you, do not hesitate to read a Getting Starting on these technologies first. You do not need to be expert in these technologies to follow the code along. The presented code uses only basic features of these frameworks.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The entry point is the class <code>Application</code>:</p>
</div>
<div class="listingblock">
<div class="title">Application.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">fr.imlovinit.anki.vocabulary.assistant</span>;

<span class="keyword">import</span> <span class="include">fr.imlovinit.anki.vocabulary.assistant.configuration.AppConfiguration</span>;
<span class="keyword">import</span> <span class="include">org.springframework.boot.SpringApplication</span>;
<span class="keyword">import</span> <span class="include">org.springframework.boot.autoconfigure.SpringBootApplication</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.Import</span>;

<span class="annotation">@SpringBootApplication</span>
<span class="annotation">@Import</span>(AppConfiguration.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Application</span> {

        <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
                SpringApplication.run(Application.class, args);
        }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application defines a unique web controller <code>ApiController</code> that loads the full dictionary in-memory at start-up:</p>
</div>
<div class="listingblock">
<div class="title">ApiController.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">fr.imlovinit.anki.vocabulary.assistant.controller</span>;

<span class="keyword">import</span> <span class="include">fr.imlovinit.anki.vocabulary.assistant.model.Dictionary</span>;
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation</span>.*;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation</span>.*;

<span class="keyword">import</span> <span class="include">javax.annotation.PostConstruct</span>;

<span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ApiController</span> {

    <span class="directive">private</span> <span class="predefined-type">Dictionary</span> dictionary;

    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${outputDir}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> outputDir;

    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${dictionaryFile}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> dictionaryFile;

    <span class="annotation">@PostConstruct</span>
    <span class="directive">public</span> <span class="type">void</span> init() {
        dictionary = <span class="keyword">new</span> <span class="predefined-type">Dictionary</span>(dictionaryFile);
    }

    <span class="comment">// ...</span>
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class <code>Dictionary</code> is a wrapper around the JSON document generated at the end of the previous section:</p>
</div>
<div class="listingblock">
<div class="title">Dictionary.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">fr.imlovinit.anki.vocabulary.assistant.model</span>;

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.databind.node.ArrayNode</span>;
<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.databind.node.ObjectNode</span>;
<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.databind.node.TextNode</span>;
<span class="keyword">import</span> <span class="include">fr.imlovinit.anki.vocabulary.assistant.util.Json</span>;

<span class="keyword">import</span> <span class="include">java.io.IOException</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Dictionary</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> filepath;
    <span class="directive">private</span> ArrayNode dictionary;

    <span class="directive">public</span> <span class="predefined-type">Dictionary</span>(<span class="predefined-type">String</span> filepath) {
        <span class="local-variable">this</span>.filepath = filepath;
        <span class="local-variable">this</span>.dictionary = loadDictionary();
    }

    <span class="directive">private</span> ArrayNode loadDictionary() {
        <span class="keyword">try</span> {
            ArrayNode rootNode = Json.readFromFile(filepath, ArrayNode.class);
            <span class="keyword">return</span> rootNode;
        } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
            e.printStackTrace();
        }
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could access any word from its rank using the method <code>searchWord</code>:</p>
</div>
<div class="listingblock">
<div class="title">Dictionary.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * Search inside the full JSON dictionary after the given identifier.
 * Only the rank could be used as identifier for now.
 */</span>
<span class="directive">public</span> Word searchWord(<span class="predefined-type">String</span> identifier) {
    ObjectNode json = (ObjectNode) dictionary.get(
      <span class="predefined-type">Integer</span>.parseInt(identifier) - <span class="integer">1</span>);
    <span class="keyword">return</span> <span class="keyword">new</span> Word(json);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method is exposed in REST:</p>
</div>
<div class="listingblock">
<div class="title">ApiController</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ApiController</span> {

    <span class="directive">private</span> <span class="predefined-type">Dictionary</span> dictionary;

    <span class="annotation">@RequestMapping</span>(path = <span class="string"><span class="delimiter">&quot;</span><span class="content">/word/{identifier}</span><span class="delimiter">&quot;</span></span>,
                    method = RequestMethod.GET,
                    produces = <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> ObjectNode getWord(
                    <span class="annotation">@PathVariable</span> <span class="predefined-type">String</span> identifier) {
        <span class="keyword">return</span> dictionary.searchWord(identifier).asJsonNode();
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, if you want to retrieve the information about the word <strong>daughter</strong> (340), enter the following URL into your browser: <a href="http://localhost:8080/api/word/340" class="bare">http://localhost:8080/api/word/340</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">45268</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">daughter</span><span class="delimiter">&quot;</span></span>
  <span class="key"><span class="delimiter">&quot;</span><span class="content">rank</span><span class="delimiter">&quot;</span></span>:<span class="integer">340</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">ipa</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">/ˈdɔːtə(ɹ)/</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">audio</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">en-us-daughter.ogg</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">translations</span><span class="delimiter">&quot;</span></span>:[<span class="string"><span class="delimiter">&quot;</span><span class="content">fille</span><span class="delimiter">&quot;</span></span>],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">types</span><span class="delimiter">&quot;</span></span>:[
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">definitions</span><span class="delimiter">&quot;</span></span>: [ <span class="error">.</span><span class="error">.</span><span class="error">.</span> ]
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We could now create an application based on AngularJS 1.x and hosted in the same project for convenience. By default, every resource present under the directory <code>src/main/resources/public</code> will be exposed as static resources by Spring Boot. So, let&#8217;s create the index page:</p>
</div>
<div class="listingblock">
<div class="title">index.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="doctype">&lt;!doctype html&gt;</span>
<span class="tag">&lt;html</span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fr</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-app</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">app</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;head&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;title&gt;</span>Anki Vocabulary Assistant<span class="tag">&lt;/title&gt;</span>
    <span class="comment">&lt;!-- some CSS code --&gt;</span>
    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">libs/angularjs/1.5.8/angular.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="inline">    </span><span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">app.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/head&gt;</span>
<span class="tag">&lt;body</span> <span class="attribute-name">ng-controller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WordController</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;header&gt;</span>
        <span class="tag">&lt;h1&gt;</span>
          .
          <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ipa</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/span&gt;</span>
        <span class="tag">&lt;/h1&gt;</span>
    <span class="tag">&lt;/header&gt;</span>

    <span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">container</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dictionary</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;section</span> <span class="attribute-name">ng-repeat</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">type in json.types</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;h2&gt;</span>
                    <span class="tag">&lt;label&gt;</span><span class="tag">&lt;/label&gt;</span>
                    <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">checkbox</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">ng-click</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">type.include = !type.include</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">ng-checked</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">type.include</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- &lt;1&gt; --&gt;</span>
                    <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Include?<span class="tag">&lt;/span&gt;</span>
                <span class="tag">&lt;/h2&gt;</span>
                <span class="tag">&lt;ol</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">definitions</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;li</span> <span class="attribute-name">ng-repeat</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">definition in type.definitions</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                        <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">checkbox</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">ng-click</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">definition.include = !definition.include</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">ng-checked</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">definition.include</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- &lt;1&gt; --&gt;</span>
                        <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">definition</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/span&gt;</span>
                        <span class="comment">&lt;!-- quotations --&gt;</span>
                    <span class="tag">&lt;/li&gt;</span>
                <span class="tag">&lt;/ol&gt;</span>
            <span class="tag">&lt;/section&gt;</span>

            <span class="comment">&lt;!-- synonyms, translations, ... --&gt;</span>
        <span class="tag">&lt;/div&gt;</span>

        <span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">media</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;section</span> <span class="attribute-name">ng-if</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">json.audio</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;h2&gt;</span>
                    Audio
                    <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">checkbox</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">ng-click</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">json.audio.include = !json.audio.include</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">ng-checked</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">json.audio.include</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">ng-if</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">json.audio</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
                    <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Sound?<span class="tag">&lt;/span&gt;</span>
                <span class="tag">&lt;/h2&gt;</span>
                <span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">audio</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;audio</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">audio_controller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">controls</span><span class="tag">&gt;</span>
                        <span class="tag">&lt;source</span> <span class="attribute-name">ng-src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
                                <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">audio/ogg</span><span class="delimiter">&quot;</span></span>
                                <span class="attribute-name">ng-if</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">json.audio.url.endsWith('.ogg') !== -1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                        <span class="tag">&lt;source</span> <span class="attribute-name">ng-src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
                                <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">audio/mpeg</span><span class="delimiter">&quot;</span></span>
                                <span class="attribute-name">ng-if</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">json.audio.url.endsWith('.mp3') !== -1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                        Your browser does not support the audio element.
                    <span class="tag">&lt;/audio&gt;</span>
                <span class="tag">&lt;/div&gt;</span>
            <span class="tag">&lt;/section&gt;</span>
        <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We add a property <code>include</code> to <code>true</code> when the user select an element.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The HTML is self-descriptive. Let&#8217;s inspect the JavaScript code used to bootstrap the AngularJS application:</p>
</div>
<div class="listingblock">
<div class="title">app.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">angular.module(<span class="string"><span class="delimiter">'</span><span class="content">app</span><span class="delimiter">'</span></span>, [])

.controller(<span class="string"><span class="delimiter">'</span><span class="content">WordController</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(<span class="predefined">$scope</span>, <span class="predefined">$http</span>, <span class="predefined">$document</span>) {

  <span class="predefined">$scope</span>.word = <span class="predefined-constant">undefined</span>;

  <span class="comment">// Display a word.</span>
  <span class="keyword">function</span> <span class="function">showWord</span>(rank) {

    <span class="predefined">$http</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">/api/word/</span><span class="delimiter">'</span></span> + rank).then(<span class="keyword">function</span>(json) { <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="predefined">$scope</span>.json = json.data;
      <span class="predefined">$scope</span>.word = <span class="predefined">$scope</span>.json.title;
    });

    window.location.hash = <span class="string"><span class="delimiter">'</span><span class="content">#</span><span class="delimiter">'</span></span> + <span class="predefined">$scope</span>.rank;
  }

  <span class="comment">// Inspect the Hash to determine the word to display</span>
  <span class="keyword">if</span> (window.location.hash) { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined">$scope</span>.rank = Number(window.location.hash.substring(<span class="integer">1</span>));
  } <span class="keyword">else</span> {
    <span class="predefined">$scope</span>.rank = <span class="integer">1</span>;
  }
  showWord(<span class="predefined">$scope</span>.rank);
});
}]);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>At initialization, we check the URL to determine the word to load before calling the main method <code>showWord</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We emit an HTTP request to retrieve the JSON containing the word information. The result is stored in the model to be accessible by the view.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The user could then check every definition, quotation, sound that interesting him. Once this is done, the user presses the touch 'Enter' to save the current word and trigger the next word loading.</p>
</div>
<div class="paragraph">
<p>So, let&#8217;s add the code to listen the key press:</p>
</div>
<div class="listingblock">
<div class="title">app.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// ...</span>
.controller(<span class="string"><span class="delimiter">'</span><span class="content">WordController</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(<span class="predefined">$scope</span>, <span class="predefined">$locale</span>, <span class="predefined">$http</span>, <span class="predefined">$document</span>) {

  <span class="predefined">$scope</span>.word = <span class="predefined-constant">undefined</span>;

  <span class="comment">// ...</span>

  <span class="comment">// Assign hotkeys</span>
  <span class="predefined">$document</span>.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">keypress</span><span class="delimiter">&quot;</span></span>, <span class="keyword">function</span>(event) {
    code = event.charCode || event.keyCode;
    <span class="keyword">switch</span> (code) {
    <span class="keyword">case</span> <span class="integer">13</span>: <span class="comment">// Enter</span>
        <span class="predefined">$scope</span>.save();
        <span class="keyword">break</span>;
    }
  });

  <span class="comment">// Save the currently edited JSON document before moving to the next word</span>
  <span class="predefined">$scope</span>.<span class="function">save</span> = <span class="keyword">function</span>() {
    <span class="predefined">$http</span>.put(<span class="string"><span class="delimiter">'</span><span class="content">/api/word/</span><span class="delimiter">'</span></span> + <span class="predefined">$scope</span>.rank, <span class="predefined">$scope</span>.json).then(<span class="keyword">function</span>() {
        <span class="predefined">$scope</span>.showNextWord();
    });
  };

  <span class="comment">// Advance the position before calling the previously covered method</span>
  <span class="predefined">$scope</span>.<span class="function">showNextWord</span> = <span class="keyword">function</span>() {
    <span class="predefined">$scope</span>.rank++
    showWord(<span class="predefined">$scope</span>.rank);
  };

})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code makes an HTTP request to a new service we need to define in our controller <code>ApiController</code>:</p>
</div>
<div class="listingblock">
<div class="title">ApiController</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ApiController</span> {

    <span class="directive">private</span> <span class="predefined-type">Dictionary</span> dictionary;

    <span class="comment">// ...</span>

    <span class="annotation">@RequestMapping</span>(path = <span class="string"><span class="delimiter">&quot;</span><span class="content">/word/{identifier}</span><span class="delimiter">&quot;</span></span>,
                    method = RequestMethod.PUT,
                    consumes = <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> saveWord(
            <span class="annotation">@PathVariable</span> <span class="predefined-type">String</span> identifier,
            <span class="annotation">@RequestBody</span> <span class="predefined-type">String</span> jsonWord) <span class="directive">throws</span> <span class="exception">IOException</span> {

        <span class="comment">// Parse the input</span>
        ObjectNode node = Json.readFromString(jsonWord,
            ObjectNode.class); <i class="conum" data-value="1"></i><b>(1)</b>
        Word newWord = <span class="keyword">new</span> Word(node);

        <span class="comment">// Save picture</span>
        newWord.save(outputDir); <i class="conum" data-value="2"></i><b>(2)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We parse the input JSON before passing it to the constructor of the class <code>Word</code>. Like the class <code>Dictionary</code>, this class acts as a Wrapper around the raw JSON document.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use the method <code>save</code> on this object to persist the selection of the user.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The main logic is encapsulated inside the class <code>Word</code>. Let&#8217;s see its definition:</p>
</div>
<div class="listingblock">
<div class="title">Word.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">fr.imlovinit.anki.vocabulary.assistant.model</span>;

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.databind.node.ArrayNode</span>;
<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.databind.node.ObjectNode</span>;
<span class="keyword">import</span> <span class="include">fr.imlovinit.anki.vocabulary.assistant.util.Json</span>;

<span class="keyword">import</span> <span class="include">java.io</span>.*;
<span class="keyword">import</span> <span class="include">java.net.URL</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Word</span> {

   <span class="directive">private</span> ObjectNode word;

   <span class="directive">public</span> Word(ObjectNode json) {
       <span class="local-variable">this</span>.word = json;
   }

   <span class="directive">public</span> <span class="predefined-type">String</span> getDescriptiveName() {
       <span class="keyword">return</span> word.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">rank</span><span class="delimiter">&quot;</span></span>).asInt() + <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span> + word.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).asText();
   }

   <span class="directive">public</span> <span class="type">void</span> save(<span class="predefined-type">String</span> outputDir) <span class="directive">throws</span> <span class="exception">IOException</span> {
       downloadAudio(outputDir); <i class="conum" data-value="1"></i><b>(1)</b>
       saveDictionaryEntry(outputDir); <i class="conum" data-value="2"></i><b>(2)</b>
   }

   <span class="directive">private</span> <span class="type">void</span> saveDictionaryEntry(<span class="predefined-type">String</span> outputDir) <span class="directive">throws</span> <span class="exception">IOException</span> {
       <span class="predefined-type">String</span> filepath = outputDir + <span class="predefined-type">File</span>.separator +
                         getDictionaryEntryFilename();
       Json.writeToFile(asJsonNode(), filepath);
   }

   <span class="directive">private</span> <span class="type">void</span> downloadAudio(<span class="predefined-type">String</span> outputDir) <span class="directive">throws</span> <span class="exception">IOException</span> {
       <span class="predefined-type">String</span> audioUrl = getAudioUrl();

       <span class="keyword">if</span> (audioUrl != <span class="predefined-constant">null</span>) {
           <span class="predefined-type">String</span> filepath = outputDir + <span class="predefined-type">File</span>.separator +
                             getAudioFilename(audioUrl);
           downloadFile(audioUrl, filepath);
       }
   }

   <span class="directive">public</span> <span class="predefined-type">String</span> getAudioUrl() {
       <span class="comment">// Search the selected image</span>
       ObjectNode audio = (ObjectNode) word.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">audio</span><span class="delimiter">&quot;</span></span>);
       <span class="keyword">if</span> (audio != <span class="predefined-constant">null</span>) {
           <span class="keyword">if</span> (audio.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span>) != <span class="predefined-constant">null</span> &amp;&amp;
               audio.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span>).asBoolean()) {
               <span class="predefined-type">String</span> url = audio.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span>).asText();
               <span class="keyword">return</span> url;
           }
       }

       <span class="keyword">return</span> <span class="predefined-constant">null</span>; <span class="comment">// No audio file or not selected</span>
   }

   <span class="directive">private</span> <span class="predefined-type">String</span> getAudioFilename(<span class="predefined-type">String</span> url) {
       <span class="predefined-type">String</span> extension = extractExtension(url);
       <span class="keyword">return</span> getDescriptiveName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">.</span><span class="delimiter">&quot;</span></span> + extension;
   }

   <span class="directive">private</span> <span class="predefined-type">String</span> getDictionaryEntryFilename() {
       <span class="keyword">return</span> getDescriptiveName() + <span class="string"><span class="delimiter">&quot;</span><span class="content">.json</span><span class="delimiter">&quot;</span></span>;
   }

   <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> extractExtension(<span class="predefined-type">String</span> url) {
       <span class="type">int</span> indexDot = url.lastIndexOf(<span class="string"><span class="delimiter">'</span><span class="content">.</span><span class="delimiter">'</span></span>);
       <span class="type">int</span> indexPercent = url.indexOf(<span class="string"><span class="delimiter">'</span><span class="content">?</span><span class="delimiter">'</span></span>, indexDot);
       <span class="predefined-type">String</span> extension = indexPercent == -<span class="integer">1</span> ?
          url.substring(indexDot + <span class="integer">1</span>) :
          url.substring(indexDot + <span class="integer">1</span>, indexPercent);
       <span class="keyword">return</span> extension;
   }

  <span class="comment">// Utility method to download an URL locally</span>
  <span class="directive">private</span> <span class="type">void</span> downloadFile(<span class="predefined-type">String</span> url, <span class="predefined-type">String</span> outputPath) <span class="directive">throws</span> <span class="exception">IOException</span> {

       <span class="predefined-type">URL</span> link = <span class="keyword">new</span> <span class="predefined-type">URL</span>(url);

       <span class="predefined-type">InputStream</span> in = <span class="keyword">new</span> <span class="predefined-type">BufferedInputStream</span>(link.openStream());
       <span class="predefined-type">ByteArrayOutputStream</span> out = <span class="keyword">new</span> <span class="predefined-type">ByteArrayOutputStream</span>();
       <span class="type">byte</span><span class="type">[]</span> buf = <span class="keyword">new</span> <span class="type">byte</span>[<span class="integer">1024</span>];
       <span class="type">int</span> n = <span class="integer">0</span>;
       <span class="keyword">while</span> (-<span class="integer">1</span> != (n = in.read(buf))) {
           out.write(buf, <span class="integer">0</span>, n);
       }
       out.close();
       in.close();
       <span class="type">byte</span><span class="type">[]</span> response = out.toByteArray();

       <span class="predefined-type">FileOutputStream</span> fos = <span class="keyword">new</span> <span class="predefined-type">FileOutputStream</span>(outputPath);
       fos.write(response);
       fos.close();
   }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We download the sound from Wikipedia locally</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We save the JSON to disk</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In definitive, the assistant application reads the full JSON dictionary, exposes its information through a REST API, allows the user to choose the most pertinent information before saving an annotated JSON document to disk such as the following one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">472128</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">rank</span><span class="delimiter">&quot;</span></span> : <span class="integer">114</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">ipa</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">/wɜːk/</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">audio</span><span class="delimiter">&quot;</span></span> : {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">en-uk-work.ogg</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">//upload.wikimedia.org/wikipedia/commons/f/ff/En-uk-work.ogg</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> : <span class="value">true</span>
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">translations</span><span class="delimiter">&quot;</span></span> : [
    { <span class="key"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">oeuvre</span><span class="delimiter">&quot;</span></span>,   <span class="key"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> : <span class="value">true</span> },
    { <span class="key"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">travail</span><span class="delimiter">&quot;</span></span>,  <span class="key"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> : <span class="value">false</span> }
  ],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">types</span><span class="delimiter">&quot;</span></span> : [
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">Noun</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> : <span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">definitions</span><span class="delimiter">&quot;</span></span> : [
        {
          <span class="key"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">(heading) ''Effort.''</span><span class="delimiter">&quot;</span></span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> : <span class="value">true</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">card</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
          <span class="key"><span class="delimiter">&quot;</span><span class="content">quotations</span><span class="delimiter">&quot;</span></span> : [
            {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">Let's get to &lt;em&gt;work&lt;/em&gt;.</span><span class="delimiter">&quot;</span></span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> : <span class="value">true</span>,
              <span class="key"><span class="delimiter">&quot;</span><span class="content">card_sample</span><span class="delimiter">&quot;</span></span> : <span class="value">false</span>
            }
          ]
        }
      ]
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Why saving and not create the flashcards directly inside the method 'save'?</strong></p>
</div>
<div class="paragraph">
<p>The problem is that Anki exposes only its internal API written in Python. If the backend of our application was written in Python too, we could have create the flashcards at the same time. Here, we dump the result to a file that we will need to read by another program written in Python. This is task of the <strong>Importer</strong>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The full source of the application is available <a href="https://github.com/julien-sobczak/anki-scripting/tree/master/anki-vocabulary-assistant">here</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="the_importer">The Importer</h4>
<div class="paragraph">
<p>This aim of this Python script is to convert a collection of JSON documents (one per word) to flashcards. As for the English idioms, we will use a custom note type that we called <code>Word</code> that we will defined manually through Anki Desktop. The note type <code>Word</code> defines a long list of fields that we will used inside the card templates:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/vocabulary-note-type-fields.png" alt="vocabulary note type fields">
</div>
</div>
<div class="paragraph">
<p>Then, we define the templates for the different possible cards.</p>
</div>
<div class="sect4">
<h5 id="do_you_know_this_word">Do you know this word?</h5>
<div class="paragraph">
<p>The <code>Card 1</code> displays the English word:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/vocabulary-note-card1.png" alt="vocabulary note card1">
</div>
</div>
<div class="paragraph">
<p>Where the front template is defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{{Word}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the back template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{{FrontSide}}

&lt;hr id=answer&gt;

&lt;div class=&quot;word&quot;&gt;
{{Word}}
{{#IPA}}&lt;span class=&quot;ipa&quot;&gt;{{IPA}}&lt;/span&gt;{{/IPA}}
&lt;/div&gt;
{{#Sound}}{{Sound}}{{/Sound}}

&lt;br&gt;

&lt;div class=&quot;definitions&quot;&gt;
{{DefinitionsWithSamples}}
&lt;/div&gt;


{{#Translation}}
&lt;br&gt;
&lt;div class=&quot;translation&quot;&gt;
&lt;small&gt;FR:&lt;/small&gt;{{Translation}}
&lt;/div&gt;
{{/Translation}}


{{#Synonyms}}
&lt;br&gt;
&lt;div class=&quot;synonyms&quot;&gt;
&lt;small&gt;SYN.:&lt;/small&gt; {{Synonyms}}
&lt;/div&gt;
{{/Synonyms}}


{{#Image}}
&lt;br&gt;
{{Image}}
{{/Image}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the <a href="https://ankisrs.net/docs/manual.html#conditional-replacement">official Anki manual</a> to know more about the syntax used in these templates.</p>
</div>
</div>
<div class="sect4">
<h5 id="what_is_it">What is it?</h5>
<div class="paragraph">
<p>The <code>Card 2</code> displays the picture associated the word:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/vocabulary-note-card2.png" alt="vocabulary note card2">
</div>
</div>
<div class="paragraph">
<p>Where the front template is defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{{#HasImageCard}} <i class="conum" data-value="1"></i><b>(1)</b>
{{Image}}
{{/HasImageCard}}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We need an additional field to determine if this card is required because some words have a picture but the user only want this picture to be displayed in other cards.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And the back template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{{FrontSide}}

&lt;hr id=answer&gt;

&lt;div class=&quot;word&quot;&gt;
{{Word}}
{{#IPA}}&lt;span class=&quot;ipa&quot;&gt;{{IPA}}&lt;/span&gt;{{/IPA}}
&lt;/div&gt;
{{#Sound}}{{Sound}}{{/Sound}}

&lt;br&gt;

&lt;div class=&quot;definitions&quot;&gt;
{{DefinitionsWithSamples}}
&lt;/div&gt;


{{#Translation}}
&lt;br&gt;
&lt;div class=&quot;translation&quot;&gt;
&lt;small&gt;FR:&lt;/small&gt; {{Translation}}
&lt;/div&gt;
{{/Translation}}


{{#Synonyms}}
&lt;br&gt;
&lt;div class=&quot;synonyms&quot;&gt;
&lt;small&gt;SYN.:&lt;/small&gt; {{Synonyms}}
&lt;/div&gt;
{{/Synonyms}}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="what_is_the_translation">What is the translation?</h5>
<div class="paragraph">
<p>The <code>Card 3</code> displays the translation of the word:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/vocabulary-note-card3.png" alt="vocabulary note card3">
</div>
</div>
<div class="paragraph">
<p>Where the front template is defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{{#HasTranslationCard}}
{{Translation}}
{{/HasTranslationCard}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the back template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{{FrontSide}}

&lt;hr id=answer&gt;

&lt;div class=&quot;word&quot;&gt;
{{Word}}
{{#IPA}}&lt;span class=&quot;ipa&quot;&gt;{{IPA}}&lt;/span&gt;{{/IPA}}
&lt;/div&gt;
{{#Sound}}{{Sound}}{{/Sound}}

&lt;br&gt;

&lt;div class=&quot;definitions&quot;&gt;
{{DefinitionsWithSamples}}
&lt;/div&gt;


{{#Image}}
&lt;br&gt;
{{Image}}
{{/Image}}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="complete_this_sentence">Complete this sentence&#8230;&#8203;</h5>
<div class="paragraph">
<p>The <code>Card 4</code>, <code>Card 5</code>, and <code>Card 6</code> display a sentence with a missing word and the user should find it (the same concept as <a href="https://ankisrs.net/docs/manual.html#cloze">Cloze Deletion</a> in Anki):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/vocabulary-note-card4.png" alt="vocabulary note card4">
</div>
</div>
<div class="paragraph">
<p>Where the front template is defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{{#SampleA}} <i class="conum" data-value="1"></i><b>(1)</b>
&lt;small&gt;Complete&lt;/small&gt; {{SampleA}}
{{/SampleA}}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>SampleA</code> by <code>SampleB</code>, <code>SampleC</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And the back template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{{FrontSide}}

&lt;hr id=answer&gt;

&lt;div class=&quot;word&quot;&gt;
{{Word}}
{{#IPA}}&lt;span class=&quot;ipa&quot;&gt;{{IPA}}&lt;/span&gt;{{/IPA}}
&lt;/div&gt;

&lt;br&gt;

&lt;div class=&quot;answer&quot;&gt;
{{AnswerA}} <i class="conum" data-value="1"></i><b>(1)</b>
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>AnswerA</code> by <code>AnswerB</code>, <code>AnswerC</code></td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="find_the_word_from_its_definitions">Find the word from its definitions</h5>
<div class="paragraph">
<p>The <code>Card 7</code> displays a list of definitions:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/posts_resources/2016-12-26-anki-scripting/vocabulary-note-card7.png" alt="vocabulary note card7">
</div>
</div>
<div class="paragraph">
<p>Where the front template is defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{{#HasDefinitionsCard}}
{{DefinitionsOnly}}
{{/HasDefinitionsCard}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the back template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{{FrontSide}}

&lt;hr id=answer&gt;

&lt;div class=&quot;word&quot;&gt;
{{Word}}
{{#IPA}}&lt;span class=&quot;ipa&quot;&gt;{{IPA}}&lt;/span&gt;{{/IPA}}
&lt;/div&gt;

&lt;br&gt;

&lt;div class=&quot;definitions&quot;&gt;
{{DefinitionsWithSamples}}
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally, the CSS used to stylize the cards:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="css"><span class="class">.card</span> {
        <span class="key">font-family</span>: <span class="value">arial</span>;
        <span class="key">font-size</span>: <span class="float">20px</span>;
        <span class="key">text-align</span>: <span class="value">center</span>;
        <span class="key">color</span>: <span class="value">black</span>;
        <span class="key">background-color</span>: <span class="value">white</span>;
}
<span class="class">.word</span> {
        <span class="key">font-size</span>: <span class="float">120%</span>;
        <span class="key">color</span>: <span class="color">#39499b</span>;
}

<span class="class">.definitions</span> {
        <span class="key">text-align</span>: <span class="value">left</span>;
}
<span class="class">.definitions</span> <span class="tag">em</span> {
        <span class="key">color</span>: <span class="color">#8a0000</span>;
}
<span class="class">.definitions</span> <span class="tag">ul</span> <span class="tag">ul</span> {
        <span class="key">color</span>: <span class="color">#39499b</span>;
        <span class="key">font-size</span>: <span class="float">90%</span>;
}
<span class="class">.definitions</span> <span class="tag">li</span> {
        <span class="key">margin-bottom</span>: <span class="float">15px</span>;
}
<span class="class">.definitions</span> <span class="tag">li</span> <span class="tag">li</span> {
        <span class="key">margin-top</span>: <span class="float">5px</span>;
        <span class="key">margin-bottom</span>: <span class="float">5px</span>;
}

<span class="class">.ipa</span> {
        <span class="key">font-family</span>: <span class="value">Times</span>, <span class="value">serif</span>;
        <span class="key">color</span>: <span class="value">black</span>;
}
<span class="tag">small</span> {
        <span class="key">color</span>: <span class="value">gray</span>;
        <span class="key">font-style</span>: <span class="value">italic</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>What we just did could be done through Anki internal API too but using the application is very easy and this task needs to be done only once. So, everything is ready for us to load the flashcards.</p>
</div>
<div class="paragraph">
<p>Here is the full listing. We already have seen most of the API in the previous case studies.</p>
</div>
<div class="listingblock">
<div class="title">anki-vocabulary-assistant/scripts/load_word.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment">#!/usr/bin/env python</span>

<span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">Load a JSON file saved by the assistant to Anki.</span><span class="content">
</span><span class="delimiter">&quot;&quot;&quot;</span></span>

<span class="keyword">import</span> <span class="include">os</span>, <span class="include">json</span>, <span class="include">shutil</span>, <span class="include">sys</span>

<span class="comment"># Add Anki source to path</span>
sys.path.append(<span class="string"><span class="delimiter">&quot;</span><span class="content">../../anki</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">from</span> <span class="include">anki.storage</span> <span class="keyword">import</span> <span class="include">Collection</span>


<span class="keyword">class</span> <span class="class">Word</span>:
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">    Wrapper around a single JSON file</span><span class="content">
</span><span class="content">    </span><span class="delimiter">&quot;&quot;&quot;</span></span>

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, doc):
        <span class="predefined-constant">self</span>.doc = doc

    <span class="keyword">def</span> <span class="function">title</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">'</span><span class="content">title</span><span class="delimiter">'</span></span>]

    <span class="keyword">def</span> <span class="function">rank</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">'</span><span class="content">rank</span><span class="delimiter">'</span></span>]

    <span class="keyword">def</span> <span class="function">audio_url</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">audio</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc <span class="keyword">and</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">audio</span><span class="delimiter">&quot;</span></span>][<span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span>]:
            <span class="keyword">return</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">audio</span><span class="delimiter">&quot;</span></span>][<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span>]
        <span class="keyword">else</span>:
            <span class="keyword">return</span> <span class="predefined-constant">None</span>

    <span class="keyword">def</span> <span class="function">definitions_with_samples</span>(<span class="predefined-constant">self</span>):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content"> Returns the back text for the Card 1 </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        html = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">for</span> <span class="predefined">type</span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">types</span><span class="delimiter">&quot;</span></span>]:
            <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined">type</span> <span class="keyword">and</span> <span class="predefined">type</span>[<span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span>]:
                subhtml = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
                <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">definitions</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined">type</span>:
                    <span class="keyword">for</span> definition <span class="keyword">in</span> <span class="predefined">type</span>[<span class="string"><span class="delimiter">&quot;</span><span class="content">definitions</span><span class="delimiter">&quot;</span></span>]:
                        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> definition <span class="keyword">and</span> definition[<span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span>]:
                            subhtml += <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;li&gt;</span><span class="delimiter">&quot;</span></span> + definition[<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>]
                            <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">quotations</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> definition:
                                first_quotation = <span class="predefined-constant">True</span>
                                quotation_found = <span class="predefined-constant">False</span>
                                <span class="keyword">for</span> quotation <span class="keyword">in</span> definition[<span class="string"><span class="delimiter">&quot;</span><span class="content">quotations</span><span class="delimiter">&quot;</span></span>]:
                                    <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> quotation \
                                        <span class="keyword">and</span> quotation[<span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span>]:
                                        quotation_found = <span class="predefined-constant">True</span>
                                        <span class="keyword">if</span> first_quotation:
                                            subhtml += <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;ul&gt;</span><span class="delimiter">&quot;</span></span>
                                            first_quotation = <span class="predefined-constant">False</span>
                                        subhtml += <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;li&gt;</span><span class="delimiter">&quot;</span></span> + \
                                                   quotation[<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>] + \
                                                   <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/li&gt;</span><span class="delimiter">&quot;</span></span>
                                <span class="keyword">if</span> quotation_found:
                                    subhtml += <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/ul&gt;</span><span class="delimiter">&quot;</span></span>
                            subhtml += <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/li&gt;</span><span class="delimiter">&quot;</span></span>
                <span class="comment"># Add the definition if at least one definition was included</span>
                <span class="keyword">if</span> subhtml:
                    html += <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;em&gt;</span><span class="delimiter">&quot;</span></span> + <span class="predefined">type</span>[<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>] + <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/em&gt;</span><span class="delimiter">&quot;</span></span> + \
                            <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;ul&gt;</span><span class="delimiter">&quot;</span></span> + subhtml + <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/ul&gt;</span><span class="delimiter">&quot;</span></span>

        <span class="keyword">return</span> html

    <span class="keyword">def</span> <span class="function">definitions_only</span>(<span class="predefined-constant">self</span>):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content"> Returns the text for the front Card 7 </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        selected_definitions = []
        <span class="keyword">for</span> <span class="predefined">type</span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">types</span><span class="delimiter">&quot;</span></span>]:
            <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">definitions</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined">type</span>:
                <span class="keyword">for</span> definition <span class="keyword">in</span> <span class="predefined">type</span>[<span class="string"><span class="delimiter">&quot;</span><span class="content">definitions</span><span class="delimiter">&quot;</span></span>]:
                    <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> definition <span class="keyword">and</span> definition[<span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span>]:
                        selected_definitions.append(definition[<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>])
        <span class="keyword">if</span> selected_definitions:
            html = <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;ul&gt;</span><span class="delimiter">&quot;</span></span>
            <span class="keyword">for</span> definition <span class="keyword">in</span> selected_definitions:
                html += <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;li&gt;</span><span class="delimiter">&quot;</span></span> + definition + <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/li&gt;</span><span class="delimiter">&quot;</span></span>
            html += <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;/ul&gt;</span><span class="delimiter">&quot;</span></span>
            <span class="keyword">return</span> html
        <span class="keyword">else</span>:
            <span class="keyword">return</span> <span class="predefined-constant">None</span>

    <span class="keyword">def</span> <span class="function">image</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">images</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc:
            <span class="keyword">for</span> image <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">images</span><span class="delimiter">&quot;</span></span>]:
                <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> image <span class="keyword">and</span> image[<span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span>]:
                    <span class="keyword">return</span> image[<span class="string"><span class="delimiter">&quot;</span><span class="content">thumb_url</span><span class="delimiter">&quot;</span></span>]
        <span class="keyword">return</span> <span class="predefined-constant">None</span>

    <span class="keyword">def</span> <span class="function">ipa</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">ipa</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc:
            <span class="keyword">return</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">ipa</span><span class="delimiter">&quot;</span></span>]
        <span class="keyword">return</span> <span class="predefined-constant">None</span>

    <span class="keyword">def</span> <span class="function">translation</span>(<span class="predefined-constant">self</span>):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content"> Returns the translation block text includes in various cards </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        selected_translations = []
        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">translations</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc:
            <span class="keyword">for</span> translation <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">translations</span><span class="delimiter">&quot;</span></span>]:
                <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> translation <span class="keyword">and</span> translation[<span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span>]:
                    selected_translations.append(translation[<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>])
        <span class="keyword">if</span> selected_translations:
            <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">, </span><span class="delimiter">&quot;</span></span>.join(selected_translations)
        <span class="keyword">else</span>:
            <span class="keyword">return</span> <span class="predefined-constant">None</span>

    <span class="keyword">def</span> <span class="function">synonyms</span>(<span class="predefined-constant">self</span>):
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content"> Returns the synonym block text includes in various cards </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        selected_synonyms = []
        <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">synonyms</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc:
            <span class="keyword">for</span> synonym <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">synonyms</span><span class="delimiter">&quot;</span></span>]:
                <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> synonym <span class="keyword">and</span> synonym[<span class="string"><span class="delimiter">&quot;</span><span class="content">include</span><span class="delimiter">&quot;</span></span>]:
                    selected_synonyms.append(synonym[<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>])
        <span class="keyword">if</span> selected_synonyms:
            <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">, </span><span class="delimiter">&quot;</span></span>.join(selected_synonyms)
        <span class="keyword">else</span>:
            <span class="keyword">return</span> <span class="predefined-constant">None</span>

    <span class="keyword">def</span> <span class="function">samples</span>(<span class="predefined-constant">self</span>):
        result = {}
        <span class="keyword">for</span> <span class="predefined">type</span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">types</span><span class="delimiter">&quot;</span></span>]:
            <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">definitions</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined">type</span>:
                <span class="keyword">for</span> definition <span class="keyword">in</span> <span class="predefined">type</span>[<span class="string"><span class="delimiter">&quot;</span><span class="content">definitions</span><span class="delimiter">&quot;</span></span>]:
                    <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">quotations</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> definition:
                        <span class="keyword">for</span> quotation <span class="keyword">in</span> definition[<span class="string"><span class="delimiter">&quot;</span><span class="content">quotations</span><span class="delimiter">&quot;</span></span>]:
                            <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">card_sample</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> quotation \
                                <span class="keyword">and</span> quotation[<span class="string"><span class="delimiter">&quot;</span><span class="content">card_sample</span><span class="delimiter">&quot;</span></span>]:
                                answer = quotation[<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>]
                                sample = answer.replace(<span class="predefined-constant">self</span>.title(), <span class="string"><span class="delimiter">&quot;</span><span class="content">[...]</span><span class="delimiter">&quot;</span></span>)
                                result[sample] = answer
        <span class="keyword">return</span> result

    <span class="keyword">def</span> <span class="function">has_image_card</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">card_images</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc <span class="keyword">and</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">card_images</span><span class="delimiter">&quot;</span></span>]

    <span class="keyword">def</span> <span class="function">has_definition_card</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">for</span> <span class="predefined">type</span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">types</span><span class="delimiter">&quot;</span></span>]:
            <span class="keyword">if</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">card_definitions</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined">type</span> <span class="keyword">and</span> <span class="predefined">type</span>[<span class="string"><span class="delimiter">&quot;</span><span class="content">card_definitions</span><span class="delimiter">&quot;</span></span>]:
                <span class="keyword">return</span> <span class="predefined-constant">True</span>
        <span class="keyword">return</span> <span class="predefined-constant">None</span>

    <span class="keyword">def</span> <span class="function">has_translation_card</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">card_translate</span><span class="delimiter">&quot;</span></span> <span class="keyword">in</span> <span class="predefined-constant">self</span>.doc <span class="keyword">and</span> <span class="predefined-constant">self</span>.doc[<span class="string"><span class="delimiter">&quot;</span><span class="content">card_translate</span><span class="delimiter">&quot;</span></span>]



<span class="keyword">def</span> <span class="function">load</span>(col, filepath):
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">    Load a single word into Anki.</span><span class="content">
</span><span class="content">
</span><span class="content">    Read the word file.</span><span class="content">
</span><span class="content">    Check if a picture or sound is present in the same folder.</span><span class="content">
</span><span class="content">
</span><span class="content">    :param filepath: the file path of the JSON document file</span><span class="content">
</span><span class="content">    </span><span class="delimiter">&quot;&quot;&quot;</span></span>

    directory = os.path.dirname(filepath)
    basename = os.path.basename(filepath)

    media_directory = os.path.join(os.path.dirname(col.path),
                                  <span class="string"><span class="delimiter">&quot;</span><span class="content">collection.media</span><span class="delimiter">&quot;</span></span>)

    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Opening file %s</span><span class="delimiter">&quot;</span></span> % filepath)
    <span class="keyword">with</span> <span class="predefined">open</span>(filepath, <span class="string"><span class="delimiter">'</span><span class="content">r</span><span class="delimiter">'</span></span>) <span class="keyword">as</span> f:
        json_content = f.read()
        doc = json.loads(json_content)
        word = Word(doc)

        <span class="comment"># We need to populate each one of the fields</span>
        fields = {}
        fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">Word</span><span class="delimiter">&quot;</span></span>] = word.title()

        <span class="keyword">if</span> word.audio_url():
            filename = <span class="string"><span class="delimiter">&quot;</span><span class="content">%s-%s</span><span class="delimiter">&quot;</span></span> % (word.rank(), word.title())
            possible_extensions = [<span class="string"><span class="delimiter">'</span><span class="content">ogg</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">mp3</span><span class="delimiter">'</span></span>]
            <span class="keyword">for</span> extension <span class="keyword">in</span> possible_extensions:
                audio_name = filename + <span class="string"><span class="delimiter">'</span><span class="content">.</span><span class="delimiter">'</span></span> + extension
                audio_path = os.path.join(directory, audio_name)
                <span class="keyword">if</span> os.path.exists(audio_path):
                    source_path = audio_path
                    target_path = os.path.join(media_directory, audio_name)
                    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Copying media file %s to %s</span><span class="delimiter">&quot;</span></span> %
                        (source_path, target_path))
                    col.media.addFile(source_path)
                    <span class="comment">#shutil.copyfile(source_path, target_path)</span>
                    fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">Sound</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">&quot;</span><span class="content">[sound:%s]</span><span class="delimiter">&quot;</span></span> % audio_name

        fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">DefinitionsWithSamples</span><span class="delimiter">&quot;</span></span>] = word.definitions_with_samples()
        fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">DefinitionsOnly</span><span class="delimiter">&quot;</span></span>] = word.definitions_only()

        <span class="keyword">if</span> word.image():
            image_name = <span class="string"><span class="delimiter">&quot;</span><span class="content">%s-%s-thumb.jpg</span><span class="delimiter">&quot;</span></span> % (word.rank(), word.title())
            image_path = os.path.join(directory, image_name)
            <span class="keyword">if</span> os.path.exists(image_path):
                source_path = os.path.join(directory, image_name)
                target_path = os.path.join(media_directory, image_name)
                print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Copying media file %s to %s</span><span class="delimiter">&quot;</span></span> %
                    (source_path, target_path))
                col.media.addFile(source_path)
                <span class="comment">#shutil.copyfile(source_path, target_path)</span>
                fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">Image</span><span class="delimiter">&quot;</span></span>] = <span class="string"><span class="delimiter">'</span><span class="content">&lt;img src=&quot;%s&quot;&gt;</span><span class="delimiter">'</span></span> % image_name

        <span class="keyword">if</span> word.ipa():
            fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">IPA</span><span class="delimiter">&quot;</span></span>] = word.ipa()
        <span class="keyword">if</span> word.translation():
            fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">Translation</span><span class="delimiter">&quot;</span></span>] = word.translation()
        <span class="keyword">if</span> word.synonyms():
            fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">Synonyms</span><span class="delimiter">&quot;</span></span>] = word.synonyms()

        samples = word.samples()
        <span class="keyword">if</span> samples:
            sample_suffixes = [<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">C</span><span class="delimiter">&quot;</span></span>]
            index = <span class="integer">0</span>
            <span class="keyword">for</span> sample, answer <span class="keyword">in</span> samples.items():
                fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">Sample</span><span class="delimiter">&quot;</span></span> + sample_suffixes[index]] = sample
                fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">Answer</span><span class="delimiter">&quot;</span></span> + sample_suffixes[index]] = answer
                index += <span class="integer">1</span>

        <span class="keyword">if</span> word.has_image_card():
            fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">HasImageCard</span><span class="delimiter">&quot;</span></span>] = <span class="predefined">str</span>(word.has_image_card())
        <span class="keyword">if</span> word.has_definition_card():
            fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">HasDefinitionsCard</span><span class="delimiter">&quot;</span></span>] = <span class="predefined">str</span>(word.has_definition_card())
        <span class="keyword">if</span> word.has_translation_card():
            fields[<span class="string"><span class="delimiter">&quot;</span><span class="content">HasTranslationCard</span><span class="delimiter">&quot;</span></span>] = <span class="predefined">str</span>(word.has_translation_card())

        <span class="comment"># Get the deck</span>
        deck = col.decks.byName(<span class="string"><span class="delimiter">&quot;</span><span class="content">English</span><span class="delimiter">&quot;</span></span>)

        <span class="comment"># Instantiate the new note</span>
        note = col.newNote()
        note.model()[<span class="string"><span class="delimiter">'</span><span class="content">did</span><span class="delimiter">'</span></span>] = deck[<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>]

        <span class="comment"># Ordered fields as defined in Anki note type</span>
        anki_fields = [
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Word</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Sound</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">DefinitionsWithSamples</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">DefinitionsOnly</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Image</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">IPA</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Translation</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">Synonyms</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">SampleA</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">SampleB</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">SampleC</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">HasImageCard</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">HasDefinitionsCard</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">AnswerA</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">AnswerB</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">AnswerC</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">HasTranslationCard</span><span class="delimiter">&quot;</span></span>
        ]

        <span class="keyword">for</span> field, value <span class="keyword">in</span> fields.items():
            note.fields[anki_fields.index(field)] = value

        <span class="comment"># Set the tags (and add the new ones to the deck configuration</span>
        tags = <span class="string"><span class="delimiter">&quot;</span><span class="content">word</span><span class="delimiter">&quot;</span></span>
        note.tags = col.tags.canonify(col.tags.split(tags))
        m = note.model()
        m[<span class="string"><span class="delimiter">'</span><span class="content">tags</span><span class="delimiter">'</span></span>] = note.tags
        col.models.save(m)

        <span class="comment"># Add the note</span>
        col.addNote(note)


<span class="keyword">if</span> __name__ == <span class="string"><span class="delimiter">'</span><span class="content">__main__</span><span class="delimiter">'</span></span>:

    <span class="comment"># We provide a command-line interface with various options</span>
    <span class="keyword">import</span> <span class="include">argparse</span>, <span class="include">glob</span>

    parser = argparse.ArgumentParser()
    parser.add_argument(<span class="string"><span class="delimiter">&quot;</span><span class="content">anki_home</span><span class="delimiter">&quot;</span></span>,
        help=<span class="string"><span class="delimiter">&quot;</span><span class="content">Home of your Anki installation</span><span class="delimiter">&quot;</span></span>)
    parser.add_argument(<span class="string"><span class="delimiter">&quot;</span><span class="content">-f</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">--folder</span><span class="delimiter">&quot;</span></span>,
        help=<span class="string"><span class="delimiter">&quot;</span><span class="content">Input folder where to search files</span><span class="delimiter">&quot;</span></span>, default=<span class="string"><span class="delimiter">&quot;</span><span class="content">../save</span><span class="delimiter">&quot;</span></span>)
    parser.add_argument(<span class="string"><span class="delimiter">&quot;</span><span class="content">--rank</span><span class="delimiter">&quot;</span></span>,
        help=<span class="string"><span class="delimiter">&quot;</span><span class="content">Rank of the word to load</span><span class="delimiter">&quot;</span></span>, type=<span class="predefined">int</span>)
    parser.add_argument(<span class="string"><span class="delimiter">&quot;</span><span class="content">--from</span><span class="delimiter">&quot;</span></span>,
        help=<span class="string"><span class="delimiter">&quot;</span><span class="content">Rank of the first word to load</span><span class="delimiter">&quot;</span></span>, type=<span class="predefined">int</span>,
        default=<span class="integer">0</span>, dest=<span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span>)  <span class="comment"># reserved word</span>
    parser.add_argument(<span class="string"><span class="delimiter">&quot;</span><span class="content">--to</span><span class="delimiter">&quot;</span></span>,
        help=<span class="string"><span class="delimiter">&quot;</span><span class="content">Rank of the last word to load</span><span class="delimiter">&quot;</span></span>, type=<span class="predefined">int</span>, default=<span class="integer">100000</span>,
        dest=<span class="string"><span class="delimiter">&quot;</span><span class="content">end</span><span class="delimiter">&quot;</span></span>)  <span class="comment"># to be consistent with start</span>
    args = parser.parse_args()

    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------</span><span class="delimiter">&quot;</span></span>)
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Word Loader ----------------------</span><span class="delimiter">&quot;</span></span>)
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">----------------------------------</span><span class="delimiter">&quot;</span></span>)
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Anki home: %s</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> % args.anki_home)

    <span class="comment"># Load the anki collection</span>
    cpath = os.path.join(args.anki_home, <span class="string"><span class="delimiter">&quot;</span><span class="content">collection.anki2</span><span class="delimiter">&quot;</span></span>)
    col = Collection(cpath, log=<span class="predefined-constant">True</span>)

    <span class="comment"># Set the model</span>
    modelBasic = col.models.byName(<span class="string"><span class="delimiter">'</span><span class="content">Word</span><span class="delimiter">'</span></span>)
    deck = col.decks.byName(<span class="string"><span class="delimiter">&quot;</span><span class="content">English</span><span class="delimiter">&quot;</span></span>)
    col.decks.select(deck[<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>])
    col.decks.current()[<span class="string"><span class="delimiter">'</span><span class="content">mid</span><span class="delimiter">'</span></span>] = modelBasic[<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>]

    <span class="keyword">if</span> args.rank:

        <span class="comment"># Only one word to load</span>
        print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Only rank %d to load</span><span class="delimiter">&quot;</span></span> % args.rank)
        glob_pattern = <span class="string"><span class="delimiter">&quot;</span><span class="content">%d-*.json</span><span class="delimiter">&quot;</span></span> % args.rank
        file_pattern = os.path.join(args.folder, glob_pattern)
        print(<span class="string"><span class="delimiter">&quot;</span><span class="content">File pattern: </span><span class="delimiter">&quot;</span></span> + file_pattern)
        <span class="keyword">for</span> filepath <span class="keyword">in</span> glob.iglob(file_pattern):
            load(col, filepath)

    <span class="keyword">else</span>:

        <span class="comment"># Iterate over input folder</span>
        glob_pattern = <span class="string"><span class="delimiter">'</span><span class="content">[1-9]*-*.json</span><span class="delimiter">'</span></span>

        file_pattern = os.path.join(args.folder, glob_pattern)
        <span class="keyword">for</span> filepath <span class="keyword">in</span> glob.iglob(file_pattern):
            filename = os.path.basename(filepath)
            rank = <span class="predefined">int</span>(filename[:filename.index(<span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>)])
            <span class="keyword">if</span> rank &gt;= args.start <span class="keyword">and</span> rank &lt; args.end:
                load(col, filepath)
            <span class="keyword">else</span>:
                print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Skipped %s</span><span class="delimiter">&quot;</span></span> % filename)


    <span class="comment"># Save the changes to DB</span>
    col.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>To launch the program, first close our Anki application if running and enter the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ pwd
~/workspace/anki-scripting/anki-vocabulary-assistant
python scripts/load_word.py \
  --folder save/
  --from 1
  --to 1000
  ~/Documents/Anki/User\ 1/</pre>
</div>
</div>
<div class="paragraph">
<p>Relaunch Anki. You should see new cards under the English deck.</p>
</div>
<div class="paragraph">
<p>Congratulations! We finally comes to the end of this lengthy post. We have seen how the internal API of Anki could be used in various scenarios. This is not complete, however. It remains the most important task&#8201;&#8212;&#8201;study all of these newly created flashcards!</p>
</div>
<div class="admonitionblock note remember">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">To remember</div>
<div class="ulist">
<ul>
<li>
<p>Anki is written in Python and do not expose a REST API. We need to interact directly with its internal API.</p>
</li>
<li>
<p>Anki persists the flashcard texts in a SQL database. Media resources are persisted on disk along the database and are referenced directly inside the card text.</p>
</li>
<li>
<p>The Anki underlying model is partially documented. Use this post as a reference to determine the role of each field or property.</p>
</li>
<li>
<p>Creating flashcards manually is the recommended way to start learning but when it comes to creating hundreds or thousand of flashcards, using a small program could be welcome.</p>
</li>
<li>
<p>Creating a flashcard programmatically is relatively easy. The most difficult part is extracting the information you want to add (book, website, &#8230;&#8203;)</p>
</li>
<li>
<p>Basic programming competency is necessary to get started. The good news is that Python is the most used language in the world to introduce new people to programming. You could find many resource online (MOOC, tutorial, ebook, blog) to get started. <a href="https://www.khanacademy.org/">Khan Academy</a> is a good start.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
      </div>

      <div class="author-bio">
  <img src="/img/me.jpg" />
  <p><strong>About the author</strong></p>
  <p>Julien Sobczak works as a software developer for Scaleway, a French cloud provider. He is a passionate reader who likes to see the world differently to measure the extent of his ignorance. His main areas of interest are productivity (doing less and better), human potential, and everything that contributes in being a better person (including a better dad and a better developer).</p>
  <a href="https://fr.linkedin.com/in/julien-sobczak-56780a91">Read Full Profile</a>
</div>

    </article>

  </div>
</section>



<section id="recommendations">
  <div class="container">
    <h2>You may also <strong>&hearts;</strong></h2>
    <hr class="star-light">
    <ul>
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
        <li>
          <a class="title" href="/write/2020/12/26/anki-scripting-for-non-programmers.html">Anki Scripting for Non-Programmers</a>

          
            <a href="/tags/tools"
              class="label">
              Tools
            </a>
          
            <a href="/tags/learning"
              class="label">
              Learning
            </a>
          
          
            <span
              class="label">
              Flashcards
            </span>
          

          
        </li>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
        <li>
          <a class="title" href="/write/2018/12/01/10-rules-for-better-flashcards.html">10 Rules for Better Flashcards</a>

          
            <a href="/tags/learning"
              class="label">
              Learning
            </a>
          
          
            <span
              class="label">
              Flashcards
            </span>
          

          
        </li>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
        <li>
          <a class="title" href="/write/2018/12/30/should-i-create-a-flashcard.html">Should I Create a Flashcard?</a>

          
            <a href="/tags/learning"
              class="label">
              Learning
            </a>
          
            <a href="/tags/productivity"
              class="label">
              Productivity
            </a>
          
          

          
            <span class="subtitle">A case-by-case approach</span>
          
        </li>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    </ul>
  </div>
</section>



  
<section id="labels" class="labels">
  <div class="container">

  <div>
    <h2>Tags</h2>
    <hr class="star-light">
  </div>


  <ul class="labels">
    <!-- TODO refactor remove useless tags and rename them. Ex: agile => people -->
    <!-- <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/agile.html"><span class="label-icon label-team-icon label-white-icon"></span><span class="label-text">People<span class="label-count">0</span></span></a>
      </div>
    </li> -->
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/architecture.html"><span class="label-icon label-architecture-icon label-white-icon"></span><span class="label-text">Architecture<span class="label-count">13</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/classics.html"><span class="label-icon label-classics-icon label-white-icon"></span><span class="label-text">Classics<span class="label-count">3</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/craftsmanship.html"><span class="label-icon label-craftsmanship-icon label-white-icon"></span><span class="label-text">Craftsmanship<span class="label-count">11</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/computer-science.html"><span class="label-icon label-computer-science-icon label-white-icon"></span><span class="label-text">Computer Science<span class="label-count">9</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/data.html"><span class="label-icon label-data-icon label-white-icon"></span><span class="label-text">Data<span class="label-count">6</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/devops.html"><span class="label-icon label-devops-icon label-white-icon"></span><span class="label-text">Devops<span class="label-count">11</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/frameworks.html"><span class="label-icon label-frameworks-icon label-white-icon"></span><span class="label-text">Frameworks<span class="label-count">10</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/human.html"><span class="label-icon label-human-icon label-white-icon"></span><span class="label-text">Human<span class="label-count">11</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/languages.html"><span class="label-icon label-languages-icon label-white-icon"></span><span class="label-text">Languages<span class="label-count">6</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/learning.html"><span class="label-icon label-reversing-icon label-white-icon"></span><span class="label-text">Learning<span class="label-count">31</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/management.html"><span class="label-icon label-management-icon label-white-icon"></span><span class="label-text">Management<span class="label-count">28</span></span></a>
      </div>
    </li>
    <!-- Not pertinent
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/popular.html"><span class="label-icon label-popular-icon label-white-icon"></span><span class="label-text">Popular<span class="label-count">0</span></span></a>
      </div>
    </li>
    -->
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/productivity.html"><span class="label-icon label-productivity-icon label-white-icon"></span><span class="label-text">Productivity<span class="label-count">16</span></span></a>
      </div>
    </li>
    <li>
      <div class="label">
        <span class="sunshine"></span><a href="/tags/tools.html"><span class="label-icon label-tools-icon label-white-icon"></span><span class="label-text">Tools<span class="label-count">9</span></span></a>
      </div>
    </li>
  </ul>

  </div>
</section>

  <footer id="footer">
    <img src="/img/me-torso-scaleway.png" class="footer-me" />
    <div class="footer-above">
        <div class="footer-col">
            <h3>Location</h3>
            <p>Lille<br>France</p>
        </div>
        <div class="footer-col">
            <h3>Around the Web</h3>
            <ul class="list-inline">
                <!-- <li>
                    <a href="https://www.goodreads.com/user/show/104485538-sobczak-julien" alt="Goodreads" title="Goodreads" class="btn-social btn-outline"><i class="fab fa-goodreads-g"></i></a>
                </li> -->
                <li>
                    <a href="https://literal.club/julien-sobczak" alt="Goodreads" title="Library.club" class="btn-social btn-outline"><i class="fa fa-book"></i></a>
                </li>
                <li>
                    <a href="https://github.com/julien-sobczak" alt="GitHub" title="GitHub" class="btn-social btn-outline"><i class="fab fa-github"></i></a>
                </li>
                <li>
                    <a href="https://fr.linkedin.com/in/julien-sobczak-56780a91" alt="LinkedIn" title="LinkedIn" class="btn-social btn-outline"><i class="fab fa-linkedin"></i></a>
                </li>
            </ul>
        </div>
    </div>
    <div class="footer-below">
        <span>Opinions are my own and don't reflect the views of my employer.</span><br/>
        <span class="manuscript">In addition, as anybody with an open mind, my opinions are likely to change from time to time...</span><br/><br/>
        <small class="copyright">Copyright &copy; 2024 Julien Sobczak</small><br/>
    </div>
</footer>

  <div id="easter-egg">
  <div id="water"></div>
  <div id="bikini-bottom">
    <img id="spongebob" src="/img/easter-egg/spongebob.png" width="20%">
  </div>
</div>
  <!-- Font Awesome CDN -->
<!-- <script src="https://kit.fontawesome.com/d54861fcaa.js" crossorigin="anonymous"></script> -->
<script src="/js/index.js"></script>

<!-- Masonry effect -->
<!-- <script src="https://unpkg.com/colcade@0/colcade.js"></script> -->
<script src="/vendor/fontawesome.js"></script>

<!-- Custom logic -->
<script src="/vendor/colcade.js"></script>


</body>
</html>
